<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React16+源码解析 | Attraction11</title>
    <meta name="description" content="个人博客">
    <link rel="stylesheet" href="/assets/style.6a4d5608.css">
    <link rel="modulepreload" href="/assets/app.5eebf8c0.js">
    <link rel="modulepreload" href="/assets/Framework_React_React16Code.md.1148dd90.lean.js">
    
    <link rel="icon" href="/docs-logo.png">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-82528fa6><!--[--><!--]--><!--[--><span tabindex="-1" data-v-f637ee78></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-f637ee78> Skip to content </a><!--]--><!----><header class="VPNav" data-v-82528fa6 data-v-12c8867e><div class="VPNavBar has-sidebar" data-v-12c8867e data-v-447244bd><div class="container" data-v-447244bd><div class="VPNavBarTitle has-sidebar" data-v-447244bd data-v-aaed7263><a class="title" href="/" data-v-aaed7263><!--[--><!--]--><!--[--><img class="VPImage logo" src="/docs-logo.png" alt data-v-ca1a0a93><!--]--><!--[-->Attraction11<!--]--><!--[--><!--]--></a></div><div class="content" data-v-447244bd><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-447244bd data-v-d8cdd395><span id="main-nav-aria-label" class="visually-hidden" data-v-d8cdd395>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-d8cdd395 data-v-aeb1c475><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-aeb1c475><span class="text" data-v-aeb1c475><!----> 前端基础 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-aeb1c475><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-aeb1c475><div class="VPMenu" data-v-aeb1c475 data-v-079aa243><div class="items" data-v-079aa243><!--[--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/JavaScript/HTML&amp;CSS/" data-v-d3c02515 data-v-97a44ddd><!--[-->HTML&amp;CSS<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/JavaScript/Functional/" data-v-d3c02515 data-v-97a44ddd><!--[-->函数式编程<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/JavaScript/Asynchronous/" data-v-d3c02515 data-v-97a44ddd><!--[-->JS异步编程<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/JavaScript/ESFeatures/" data-v-d3c02515 data-v-97a44ddd><!--[-->ES新特性<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/JavaScript/TypeScript/" data-v-d3c02515 data-v-97a44ddd><!--[-->TS语言<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/JavaScript/Performance/" data-v-d3c02515 data-v-97a44ddd><!--[-->JS性能优化<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/JavaScript/Engineering/" data-v-d3c02515 data-v-97a44ddd><!--[-->项目工程化<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/JavaScript/Module/" data-v-d3c02515 data-v-97a44ddd><!--[-->模块检测<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-d8cdd395 data-v-aeb1c475><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-aeb1c475><span class="text" data-v-aeb1c475><!----> 前端框架 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-aeb1c475><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-aeb1c475><div class="VPMenu" data-v-aeb1c475 data-v-079aa243><div class="items" data-v-079aa243><!--[--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/Framework/Vue/Vue2.html" data-v-d3c02515 data-v-97a44ddd><!--[-->Vue<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/Framework/React/React.html" data-v-d3c02515 data-v-97a44ddd><!--[-->React<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/Framework/Nuxt/serveRender.html" data-v-d3c02515 data-v-97a44ddd><!--[-->Nuxt<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/Framework/Next/NextJS.html" data-v-d3c02515 data-v-97a44ddd><!--[-->Next<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/Framework/Module/" data-v-d3c02515 data-v-97a44ddd><!--[-->杂记<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-d8cdd395 data-v-aeb1c475><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-aeb1c475><span class="text" data-v-aeb1c475><!----> 全栈开发 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-aeb1c475><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-aeb1c475><div class="VPMenu" data-v-aeb1c475 data-v-079aa243><div class="items" data-v-079aa243><!--[--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/FullStack/Node/WebCli.html" data-v-d3c02515 data-v-97a44ddd><!--[-->Node<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/FullStack/DataBase/Mongodb.html" data-v-d3c02515 data-v-97a44ddd><!--[-->NoSQL数据库<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/FullStack/WebDev/Express.html" data-v-d3c02515 data-v-97a44ddd><!--[-->Web开发框架<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/FullStack/GraphQL/" data-v-d3c02515 data-v-97a44ddd><!--[-->GraphQL API 开发<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-d8cdd395 data-v-aeb1c475><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-aeb1c475><span class="text" data-v-aeb1c475><!----> 泛客户端开发 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-aeb1c475><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-aeb1c475><div class="VPMenu" data-v-aeb1c475 data-v-079aa243><div class="items" data-v-079aa243><!--[--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/PanClient/RN/WebCli.html" data-v-d3c02515 data-v-97a44ddd><!--[-->React Native<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/PanClient/RN/WebCli.html" data-v-d3c02515 data-v-97a44ddd><!--[-->Flutter<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-d8cdd395 data-v-aeb1c475><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-aeb1c475><span class="text" data-v-aeb1c475><!----> 技术方案 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-aeb1c475><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-aeb1c475><div class="VPMenu" data-v-aeb1c475 data-v-079aa243><div class="items" data-v-079aa243><!--[--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/ProgramTopics/MicroFrontend/WebCli.html" data-v-d3c02515 data-v-97a44ddd><!--[-->Micro Frontend<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/Sites.html" data-v-d8cdd395 data-v-08b6ef03 data-v-97a44ddd><!--[-->宝藏网站<!--]--><!----></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-d8cdd395 data-v-aeb1c475><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-aeb1c475><span class="text" data-v-aeb1c475><!----> 随机文章 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-aeb1c475><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-aeb1c475><div class="VPMenu" data-v-aeb1c475 data-v-079aa243><div class="items" data-v-079aa243><!--[--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/notes/Git%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C.html" data-v-d3c02515 data-v-97a44ddd><!--[-->Git常用操作.md<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/notes/Linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4.html" data-v-d3c02515 data-v-97a44ddd><!--[-->Linux基本命令.md<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/notes/Nginx%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html" data-v-d3c02515 data-v-97a44ddd><!--[-->Nginx基本使用.md<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/notes/RegExp%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8.html" data-v-d3c02515 data-v-97a44ddd><!--[-->RegExp介绍与使用.md<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/notes/%E5%8A%9B%E6%89%A3%E9%A2%98%E8%AE%B0%E5%BD%95.html" data-v-d3c02515 data-v-97a44ddd><!--[-->力扣题记录.md<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/notes/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95.html" data-v-d3c02515 data-v-97a44ddd><!--[-->小程序开发记录.md<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/notes/%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE.html" data-v-d3c02515 data-v-97a44ddd><!--[-->常用快捷键.md<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/notes/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95.html" data-v-d3c02515 data-v-97a44ddd><!--[-->排序算法.md<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-079aa243 data-v-d3c02515><a class="VPLink link" href="/notes/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86.html" data-v-d3c02515 data-v-97a44ddd><!--[-->网络相关知识.md<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-447244bd data-v-d70ebc80><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-d70ebc80 data-v-9a8716a3 data-v-3258a739><span class="check" data-v-3258a739><span class="icon" data-v-3258a739><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-9a8716a3><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-9a8716a3><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-447244bd data-v-6a2a6555 data-v-b8f6762d><!--[--><a class="VPSocialLink" href="https://github.com/attraction11" target="_blank" rel="noopener" data-v-b8f6762d data-v-179ad0ea><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-447244bd data-v-b390db70 data-v-aeb1c475><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-aeb1c475><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-aeb1c475><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-aeb1c475><div class="VPMenu" data-v-aeb1c475 data-v-079aa243><!----><!--[--><!--[--><!----><div class="group" data-v-b390db70><div class="item appearance" data-v-b390db70><p class="label" data-v-b390db70>Appearance</p><div class="appearance-action" data-v-b390db70><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-b390db70 data-v-9a8716a3 data-v-3258a739><span class="check" data-v-3258a739><span class="icon" data-v-3258a739><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-9a8716a3><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-9a8716a3><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-b390db70><div class="item social-links" data-v-b390db70><div class="VPSocialLinks social-links-list" data-v-b390db70 data-v-b8f6762d><!--[--><a class="VPSocialLink" href="https://github.com/attraction11" target="_blank" rel="noopener" data-v-b8f6762d data-v-179ad0ea><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-447244bd data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-82528fa6 data-v-72f15439><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-72f15439><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-72f15439><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-72f15439>Menu</span></button><a class="top-link" href="#" data-v-72f15439> Return to top </a></div><aside class="VPSidebar" data-v-82528fa6 data-v-240a42a7><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-240a42a7><span class="visually-hidden" id="sidebar-aria-label" data-v-240a42a7> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-240a42a7><section class="VPSidebarGroup collapsible" data-v-240a42a7 data-v-a094e895><div class="title" role="button" data-v-a094e895><h2 class="title-text" data-v-a094e895>Vue</h2><div class="action" data-v-a094e895><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-a094e895><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-a094e895><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-a094e895><!--[--><!--[--><a class="VPLink link link" href="/Framework/Vue/Vue2.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>框架设计与实现</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Vue/Vue3.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>响应式系统</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Vue/Vue3Tsx.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Vue3+TSX语法</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Vue/VirtualDOM.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>虚拟DOM原理</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Vue/Vue3Code.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Vue3源码解析</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Vue/Component.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Vue 组件库</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Vue/VueRouter.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Vue Router</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Vue/Vuex.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Vuex</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Vue/QA1.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Q&A-1</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Vue/QA2.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Q&A-2</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Vue/QA3.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Q&A-3</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-240a42a7><section class="VPSidebarGroup collapsible" data-v-240a42a7 data-v-a094e895><div class="title" role="button" data-v-a094e895><h2 class="title-text" data-v-a094e895>React</h2><div class="action" data-v-a094e895><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-a094e895><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-a094e895><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-a094e895><!--[--><!--[--><a class="VPLink link link" href="/Framework/React/React.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>框架设计与实现</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/React/ReactHooks.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>响应式系统</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/React/ReactBase.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>React 基础</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/React/ReactDiff.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Diff 算法</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/React/ReactFilber.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>React Fiber</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link active" href="/Framework/React/React16Code.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>React16+源码解析</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/React/ReactRouter.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>React Router</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/React/Redux.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Redux</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/React/ReduxCode.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Redux源码及应用</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/React/MobX6.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>MobX6基础</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/React/ReactRedux.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>ReactRedux</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/React/QA1.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Q&A-1</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/React/QA2.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Q&A-2</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-240a42a7><section class="VPSidebarGroup collapsible" data-v-240a42a7 data-v-a094e895><div class="title" role="button" data-v-a094e895><h2 class="title-text" data-v-a094e895>Nuxt</h2><div class="action" data-v-a094e895><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-a094e895><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-a094e895><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-a094e895><!--[--><!--[--><a class="VPLink link link" href="/Framework/Nuxt/ServeRender.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>服务端渲染</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Nuxt/MySSR.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>搭建SSR</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Nuxt/NuxtBase.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Nuxt基础</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Nuxt/" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Nuxt最佳实践</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Nuxt/StaticSite.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>静态站点生成</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-240a42a7><section class="VPSidebarGroup collapsible" data-v-240a42a7 data-v-a094e895><div class="title" role="button" data-v-a094e895><h2 class="title-text" data-v-a094e895>Next</h2><div class="action" data-v-a094e895><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-a094e895><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-a094e895><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-a094e895><!--[--><!--[--><a class="VPLink link link" href="/Framework/Next/NextJS.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>NextJS</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Next/ServeRender.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>React SSR简介及应用</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/Framework/Next/Gatsby.html" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>Gatsby 基础</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-240a42a7><section class="VPSidebarGroup collapsible" data-v-240a42a7 data-v-a094e895><div class="title" role="button" data-v-a094e895><h2 class="title-text" data-v-a094e895>杂记</h2><div class="action" data-v-a094e895><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-a094e895><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-a094e895><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-a094e895><!--[--><!--[--><a class="VPLink link link" href="/Framework/Module/" style="padding-left:0px;" data-v-63c070bf data-v-97a44ddd><!--[--><span class="link-text" data-v-63c070bf>基础问答</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-82528fa6 data-v-b2b5ab3c><div class="VPDoc has-sidebar has-aside" data-v-b2b5ab3c data-v-6b6fcb79><div class="container" data-v-6b6fcb79><div class="aside" data-v-6b6fcb79><div class="aside-curtain" data-v-6b6fcb79></div><div class="aside-container" data-v-6b6fcb79><div class="aside-content" data-v-6b6fcb79><div class="VPDocAside" data-v-6b6fcb79 data-v-c8158c08><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-c8158c08 data-v-1c535019><div class="content" data-v-1c535019><div class="outline-marker" data-v-1c535019></div><div class="outline-title" data-v-1c535019>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-1c535019><span class="visually-hidden" id="doc-outline-aria-label" data-v-1c535019> Table of Contents for current page </span><ul class="root" data-v-1c535019 data-v-f1f7b818><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-c8158c08></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-6b6fcb79><div class="content-container" data-v-6b6fcb79><!--[--><!--]--><main class="main" data-v-6b6fcb79><div style="position:relative;" class="vp-doc _Framework_React_React16Code" data-v-6b6fcb79><div><h1 id="react16-源码解析" tabindex="-1">React16+源码解析 <a class="header-anchor" href="#react16-源码解析" aria-hidden="true">#</a></h1><h2 id="_1-配置-react-源码本地调试环境" tabindex="-1">1. 配置 React 源码本地调试环境 <a class="header-anchor" href="#_1-配置-react-源码本地调试环境" aria-hidden="true">#</a></h2><ol><li><p>使用 create-react-app 脚手架创建项目</p><p><code>npx create-react-app react-test</code></p></li><li><p>弹射 create-react-app 脚手架内部配置</p><p><code>npm run eject</code></p></li><li><p>克隆 react 官方源码 (在项目的根目录下进行克隆)</p><p><code>git clone --branch v16.13.1 --depth=1 https://github.com/facebook/react.git src/react</code></p></li><li><p>链接本地源码</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 文件位置: react-test/config/webpack.config.js</span></span>
<span class="line"><span style="color:#80A665;">resolve</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">alias</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">react-native</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#DBD7CAEE;">: </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">react-native-web</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">react</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">../src/react/packages/react</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">react-dom</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">../src/react/packages/react-dom</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">shared</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">../src/react/packages/shared</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">react-reconciler</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">../src/react/packages/react-reconciler</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">legacy-events</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">path</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">__dirname</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">../src/react/packages/legacy-events</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 文件位置: react-test/config/webpack.config.js</span></span>
<span class="line"><span style="color:#59873A;">resolve</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">alias</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">react-native</span><span style="color:#B56959AA;">&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">react-native-web</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">react</span><span style="color:#B56959AA;">&quot;</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">../src/react/packages/react</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">),</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">react-dom</span><span style="color:#B56959AA;">&quot;</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">../src/react/packages/react-dom</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">),</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">shared</span><span style="color:#B56959AA;">&quot;</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">../src/react/packages/shared</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">),</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">react-reconciler</span><span style="color:#B56959AA;">&quot;</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">../src/react/packages/react-reconciler</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">),</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">legacy-events</span><span style="color:#B56959AA;">&quot;</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">path</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">__dirname</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">../src/react/packages/legacy-events</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div></li><li><p>修改环境变量</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 文件位置: react-test/config/env.js</span></span>
<span class="line"><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">stringified</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">p<wbr>rocess.env</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Object</span><span style="color:#666666;">.</span><span style="color:#80A665;">keys</span><span style="color:#666666;">(</span><span style="color:#BD976A;">raw</span><span style="color:#666666;">).</span><span style="color:#80A665;">reduce</span><span style="color:#666666;">((</span><span style="color:#BD976A;">env</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">key</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">env</span><span style="color:#666666;">[</span><span style="color:#BD976A;">key</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">JSON</span><span style="color:#666666;">.</span><span style="color:#80A665;">stringify</span><span style="color:#666666;">(</span><span style="color:#BD976A;">raw</span><span style="color:#666666;">[</span><span style="color:#BD976A;">key</span><span style="color:#666666;">]);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">env</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">},</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{}),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">__DEV__</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">SharedArrayBuffer</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">spyOnDev</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">spyOnDevAndProd</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">spyOnProd</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">__PROFILE__</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">__UMD__</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">__EXPERIMENTAL__</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">__VARIANT__</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">gate</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">trustedTypes</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">};</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 文件位置: react-test/config/env.js</span></span>
<span class="line"><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">stringified</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">p<wbr>rocess.env</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Object</span><span style="color:#999999;">.</span><span style="color:#59873A;">keys</span><span style="color:#999999;">(</span><span style="color:#B07D48;">raw</span><span style="color:#999999;">).</span><span style="color:#59873A;">reduce</span><span style="color:#999999;">((</span><span style="color:#B07D48;">env</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">key</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">env</span><span style="color:#999999;">[</span><span style="color:#B07D48;">key</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">JSON</span><span style="color:#999999;">.</span><span style="color:#59873A;">stringify</span><span style="color:#999999;">(</span><span style="color:#B07D48;">raw</span><span style="color:#999999;">[</span><span style="color:#B07D48;">key</span><span style="color:#999999;">]);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">env</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">},</span><span style="color:#393A34;"> </span><span style="color:#999999;">{}),</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">__DEV__</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">SharedArrayBuffer</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">spyOnDev</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">spyOnDevAndProd</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">spyOnProd</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">__PROFILE__</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">__UMD__</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">__EXPERIMENTAL__</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">__VARIANT__</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">gate</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">trustedTypes</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">};</span></span>
<span class="line"></span></code></pre></div></li><li><p>告诉 babel 在转换代码时忽略类型检查</p><p><code>npm install @babel/plugin-transform-flow-strip-types -D</code></p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 文件位置: react-test/config/webpack.config.js [babel-loader]</span></span>
<span class="line"><span style="color:#80A665;">plugins</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span><span style="color:#BD976A;">require</span><span style="color:#666666;">.</span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">@babel/plugin-transform-flow-strip-types</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">)];</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 文件位置: react-test/config/webpack.config.js [babel-loader]</span></span>
<span class="line"><span style="color:#59873A;">plugins</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span><span style="color:#B07D48;">require</span><span style="color:#999999;">.</span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">@babel/plugin-transform-flow-strip-types</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">)];</span></span>
<span class="line"></span></code></pre></div></li><li><p>导出 HostConfig</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 文件位置: /react/packages/react-reconciler/src/ReactFiberHostConfig.js</span></span>
<span class="line"><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">*</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">./forks/ReactFiberHostConfig.dom</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">-</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">invariant</span><span style="color:#666666;">(</span><span style="color:#4D9375;">false</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">This module must be shimmed by a specific renderer.</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">);</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 文件位置: /react/packages/react-reconciler/src/ReactFiberHostConfig.js</span></span>
<span class="line"><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">*</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">./forks/ReactFiberHostConfig.dom</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">-</span><span style="color:#393A34;"> </span><span style="color:#59873A;">invariant</span><span style="color:#999999;">(</span><span style="color:#1E754F;">false</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">This module must be shimmed by a specific renderer.</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">);</span></span>
<span class="line"></span></code></pre></div></li><li><p>修改 ReactSharedInternals.js 文件</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 文件位置: /react/packages/shared/ReactSharedInternals.js</span></span>
<span class="line"><span style="color:#CB7676;">-</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">*</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">as</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">React</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">react</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">-</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ReactSharedInternals</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">React</span><span style="color:#666666;">.</span><span style="color:#BD976A;">__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ReactSharedInternals</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">../react/src/ReactSharedInternals</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 文件位置: /react/packages/shared/ReactSharedInternals.js</span></span>
<span class="line"><span style="color:#AB5959;">-</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">*</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">as</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">React</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">react</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">-</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ReactSharedInternals</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">React</span><span style="color:#999999;">.</span><span style="color:#B07D48;">__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ReactSharedInternals</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">../react/src/ReactSharedInternals</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"></span></code></pre></div></li><li><p>关闭 eslint 扩展</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 文件位置: react/.eslingrc.js [module.exports]</span></span>
<span class="line"><span style="color:#758575DD;">// 删除 extends</span></span>
<span class="line"><span style="color:#80A665;">extends</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">fbjs</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">prettier</span><span style="color:#C98A7DAA;">&#39;</span></span>
<span class="line"><span style="color:#666666;">]</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 文件位置: react/.eslingrc.js [module.exports]</span></span>
<span class="line"><span style="color:#A0ADA0;">// 删除 extends</span></span>
<span class="line"><span style="color:#59873A;">extends</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">[</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">fbjs</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">prettier</span><span style="color:#B56959AA;">&#39;</span></span>
<span class="line"><span style="color:#999999;">]</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div></li><li><p>禁止 invariant 报错</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 文件位置: /react/packages/shared/invariant.js</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">default</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">invariant</span><span style="color:#666666;">(</span><span style="color:#BD976A;">condition</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">format</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">a</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">b</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">c</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">d</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">e</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">f</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">condition</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">throw</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">Error</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">Internal React error: invariant() is meant to be replaced at compile </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">time. There is no runtime version.</span><span style="color:#C98A7DAA;">&#39;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 文件位置: /react/packages/shared/invariant.js</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">default</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">invariant</span><span style="color:#999999;">(</span><span style="color:#B07D48;">condition</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">format</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">a</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">b</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">c</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">d</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">e</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">f</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">condition</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">throw</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">Error</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">Internal React error: invariant() is meant to be replaced at compile </span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">time. There is no runtime version.</span><span style="color:#B56959AA;">&#39;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div></li><li><p>eslint 配置</p><p>在 react 源码文件夹中新建 .eslintrc.json 并添加如下配置</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">extends</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#DBD7CAEE;">: </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">react-app</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">globals</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#DBD7CAEE;">: </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">SharedArrayBuffer</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">spyOnDev</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">spyOnDevAndProd</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">spyOnProd</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">__PROFILE__</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">__UMD__</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">__EXPERIMENTAL__</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">__VARIANT__</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">gate</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">trustedTypes</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">extends</span><span style="color:#B56959AA;">&quot;</span><span style="color:#393A34;">: </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">react-app</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">globals</span><span style="color:#B56959AA;">&quot;</span><span style="color:#393A34;">: </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">SharedArrayBuffer</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">spyOnDev</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">spyOnDevAndProd</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">spyOnProd</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">__PROFILE__</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">__UMD__</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">__EXPERIMENTAL__</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">__VARIANT__</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">gate</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">trustedTypes</span><span style="color:#B56959AA;">&quot;</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div></li><li><p>修改 react react-dom 引入方式</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">*</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">as</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">React</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">react</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">import</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">*</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">as</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ReactDOM</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">from</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">react-dom</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">*</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">as</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">React</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">react</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">import</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">*</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">as</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ReactDOM</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">from</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">react-dom</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"></span></code></pre></div></li><li><p>解决 vsCode 中 flow 报错</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#C98A7DAA;">&quot;</span><span style="color:#C98A7D;">javascript.validate.enable</span><span style="color:#C98A7DAA;">&quot;</span><span style="color:#DBD7CAEE;">: </span><span style="color:#4D9375;">false</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#B56959AA;">&quot;</span><span style="color:#B56959;">javascript.validate.enable</span><span style="color:#B56959AA;">&quot;</span><span style="color:#393A34;">: </span><span style="color:#1E754F;">false</span></span>
<span class="line"></span></code></pre></div></li><li><p>可选项配置</p><p>如果你的 vscode 编辑器安装了 prettier 插件并且在保存 react 源码文件时右下角出现如下错误，按照如下步骤解决</p></li></ol><p><img src="/assets/image12.bf98e6ff.png" alt="1.png"></p><pre><code>1. 全局安装 prettier

   `npm i prettier -g`

2. 配置 prettier path

   Settings &gt; Extensions &gt; Prettier &gt; Prettier path
</code></pre><p><img src="/assets/image13.d55ec80e.png" alt="1.png"></p><ol start="15"><li><p>__DEV__ 报错</p><p>删除 node_modules 文件夹，执行 npm install</p></li></ol><h2 id="_2-创建-react-元素" tabindex="-1">2. 创建 React 元素 <a class="header-anchor" href="#_2-创建-react-元素" aria-hidden="true">#</a></h2><p>JSX 被 Babel 编译为 React.createElement 方法的调用，createElement 方法在调用后返回的就是 ReactElement，就是 virtualDOM。</p><h3 id="_2-1-createelement" tabindex="-1">2.1 createElement <a class="header-anchor" href="#_2-1-createelement" aria-hidden="true">#</a></h3><p><code>文件位置：packages/react/src/ReactElement.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 创建 React Element</span></span>
<span class="line"><span style="color:#758575DD;"> * type      元素类型</span></span>
<span class="line"><span style="color:#758575DD;"> * config    配置属性</span></span>
<span class="line"><span style="color:#758575DD;"> * children  子元素</span></span>
<span class="line"><span style="color:#758575DD;"> * 1. 分离 props 属性和特殊属性</span></span>
<span class="line"><span style="color:#758575DD;"> * 2. 将子元素挂载到 props.children 中</span></span>
<span class="line"><span style="color:#758575DD;"> * 3. 为 props 属性赋默认值 (defaultProps)</span></span>
<span class="line"><span style="color:#758575DD;"> * 4. 创建并返回 ReactElement</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createElement</span><span style="color:#666666;">(</span><span style="color:#BD976A;">type</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">children</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">     * propName -&gt; 属性名称</span></span>
<span class="line"><span style="color:#758575DD;">     * 用于后面的 for 循环</span></span>
<span class="line"><span style="color:#758575DD;">     */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">propName</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">     * 存储 React Element 中的普通元素属性 即不包含 key ref self source</span></span>
<span class="line"><span style="color:#758575DD;">     */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">props</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">     * 待提取属性</span></span>
<span class="line"><span style="color:#758575DD;">     * React 内部为了实现某些功能而存在的属性</span></span>
<span class="line"><span style="color:#758575DD;">     */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">key</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ref</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">self</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">source</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果 config 不为 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果 config 对象中有合法的 ref 属性</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#80A665;">hasValidRef</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 将 config.ref 属性提取到 ref 变量中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">ref</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">ref</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 在开发环境中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">__DEV__</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 如果 ref 属性的值被设置成了字符串形式就报一个提示</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 说明此用法在将来的版本中会被删除</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">warnIfStringRefCannotBeAutoConverted</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果在 config 对象中拥有合法的 key 属性</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#80A665;">hasValidKey</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 将 config.key 属性中的值提取到 key 变量中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">key</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">key</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">self</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">__self</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">__self</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">source</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">__source</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">__source</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 遍历 config 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">propName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">in</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果当前遍历到的属性是对象自身属性</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 并且在 RESERVED_PROPS 对象中不存在该属性</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">hasOwnProperty</span><span style="color:#666666;">.</span><span style="color:#80A665;">call</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">propName</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">RESERVED_PROPS</span><span style="color:#666666;">.</span><span style="color:#80A665;">hasOwnProperty</span><span style="color:#666666;">(</span><span style="color:#BD976A;">propName</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 将满足条件的属性添加到 props 对象中 (普通属性)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">props</span><span style="color:#666666;">[</span><span style="color:#BD976A;">propName</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">[</span><span style="color:#BD976A;">propName</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">     * 将第三个及之后的参数挂载到 props.children 属性中</span></span>
<span class="line"><span style="color:#758575DD;">     * 如果子元素是多个 props.children 是数组</span></span>
<span class="line"><span style="color:#758575DD;">     * 如果子元素是一个 props.children 是对象</span></span>
<span class="line"><span style="color:#758575DD;">     */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 由于从第三个参数开始及以后都表示子元素</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 所以减去前两个参数的结果就是子元素的数量</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">childrenLength</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">arguments</span><span style="color:#666666;">.</span><span style="color:#B8A965;">length</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">-</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">2</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果子元素的数量是 1</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">childrenLength</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">1</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 直接将子元素挂载到到 props.children 属性上</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 此时 children 是对象类型</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">props</span><span style="color:#666666;">.</span><span style="color:#BD976A;">children</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">children</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果子元素的数量大于 1</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">childrenLength</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">1</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 创建数组, 数组中元素的数量等于子元素的数量</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">childArray</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">Array</span><span style="color:#666666;">(</span><span style="color:#BD976A;">childrenLength</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 开启循环 循环次匹配子元素的数量</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">childrenLength</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#CB7676;">++</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 将子元素添加到 childArray 数组中</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// i + 2 的原因是实参集合的前两个参数不是子元素</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">childArray</span><span style="color:#666666;">[</span><span style="color:#BD976A;">i</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">arguments</span><span style="color:#666666;">[</span><span style="color:#BD976A;">i</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">2</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果是开发环境</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">__DEV__</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果 Object 对象中存在 freeze 方法</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">Object</span><span style="color:#666666;">.</span><span style="color:#BD976A;">freeze</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 调用 freeze 方法 冻结 childArray 数组</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 防止 React 核心对象被修改 冻结对象提高性能</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">Object</span><span style="color:#666666;">.</span><span style="color:#80A665;">freeze</span><span style="color:#666666;">(</span><span style="color:#BD976A;">childArray</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 将子元素数组挂载到 props.children 属性中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">props</span><span style="color:#666666;">.</span><span style="color:#BD976A;">children</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">childArray</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">     * 如果当前处理是组件</span></span>
<span class="line"><span style="color:#758575DD;">     * 看组件身上是否有 defaultProps 属性</span></span>
<span class="line"><span style="color:#758575DD;">     * 这个属性中存储的是 props 对象中属性的默认值</span></span>
<span class="line"><span style="color:#758575DD;">     * 遍历 defaultProps 对象 查看对应的 props 属性的值是否为 undefined</span></span>
<span class="line"><span style="color:#758575DD;">     * 如果为undefined 就将默认值赋值给对应的 props 属性值</span></span>
<span class="line"><span style="color:#758575DD;">     */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 将 type 属性值视为函数 查看其中是否具有 defaultProps 属性</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">type</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">type</span><span style="color:#666666;">.</span><span style="color:#BD976A;">defaultProps</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 将 type 函数下的 defaultProps 属性赋值给 defaultProps 变量</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">defaultProps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">type</span><span style="color:#666666;">.</span><span style="color:#BD976A;">defaultProps</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 遍历 defaultProps 对象中的属性 将属性名称赋值给 propName 变量</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">propName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">in</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">defaultProps</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果 props 对象中的该属性的值为 undefined</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">props</span><span style="color:#666666;">[</span><span style="color:#BD976A;">propName</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 将 defaultProps 对象中的对应属性的值赋值给 props 对象中的对应属性的值</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">props</span><span style="color:#666666;">[</span><span style="color:#BD976A;">propName</span><span style="color:#666666;">]</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">defaultProps</span><span style="color:#666666;">[</span><span style="color:#BD976A;">propName</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">     * 在开发环境中 如果元素的 key 属性 或者 ref 属性存在</span></span>
<span class="line"><span style="color:#758575DD;">     * 监测开发者是否在组件内部通过 props 对象获取了 key 属性或者 ref 属性</span></span>
<span class="line"><span style="color:#758575DD;">     * 如果获取了 就报错</span></span>
<span class="line"><span style="color:#758575DD;">     */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果处于开发环境</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">__DEV__</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 元素具有 key 属性或者 ref 属性</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">key</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ref</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 看一下 type 属性中存储的是否是函数 如果是函数就表示当前元素是组件</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果元素不是组件 就直接返回元素类型字符串</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// displayName 用于在报错过程中显示是哪一个组件报错了</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果开发者显式定义了 displayName 属性 就显示开发者定义的</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 否者就显示组件名称 如果组件也没有名称 就显示 &#39;Unknown&#39;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">displayName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">type</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">function</span><span style="color:#C98A7DAA;">&#39;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">type</span><span style="color:#666666;">.</span><span style="color:#BD976A;">displayName</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">type</span><span style="color:#666666;">.</span><span style="color:#BD976A;">name</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">Unknown</span><span style="color:#C98A7DAA;">&#39;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">type</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果 key 属性存在</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">key</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 为 props 对象添加key 属性</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 并指定当通过 props 对象获取 key 属性时报错</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">defineKeyPropWarningGetter</span><span style="color:#666666;">(</span><span style="color:#BD976A;">props</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">displayName</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果 ref 属性存在</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">ref</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 为 props 对象添加 ref 属性</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 并指定当通过 props 对象获取 ref 属性时报错</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">defineRefPropWarningGetter</span><span style="color:#666666;">(</span><span style="color:#BD976A;">props</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">displayName</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 返回 ReactElement</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">ReactElement</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">type</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">key</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">ref</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">self</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">source</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 在 Virtual DOM 中用于识别自定义组件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">ReactCurrentOwner</span><span style="color:#666666;">.</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">props</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 创建 React Element</span></span>
<span class="line"><span style="color:#A0ADA0;"> * type      元素类型</span></span>
<span class="line"><span style="color:#A0ADA0;"> * config    配置属性</span></span>
<span class="line"><span style="color:#A0ADA0;"> * children  子元素</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 1. 分离 props 属性和特殊属性</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 2. 将子元素挂载到 props.children 中</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 3. 为 props 属性赋默认值 (defaultProps)</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 4. 创建并返回 ReactElement</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createElement</span><span style="color:#999999;">(</span><span style="color:#B07D48;">type</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">children</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">     * propName -&gt; 属性名称</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 用于后面的 for 循环</span></span>
<span class="line"><span style="color:#A0ADA0;">     */</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">propName</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 存储 React Element 中的普通元素属性 即不包含 key ref self source</span></span>
<span class="line"><span style="color:#A0ADA0;">     */</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">props</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 待提取属性</span></span>
<span class="line"><span style="color:#A0ADA0;">     * React 内部为了实现某些功能而存在的属性</span></span>
<span class="line"><span style="color:#A0ADA0;">     */</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">key</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ref</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">self</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">source</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果 config 不为 null</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果 config 对象中有合法的 ref 属性</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#59873A;">hasValidRef</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 将 config.ref 属性提取到 ref 变量中</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">ref</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">ref</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 在开发环境中</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">__DEV__</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 如果 ref 属性的值被设置成了字符串形式就报一个提示</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 说明此用法在将来的版本中会被删除</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">warnIfStringRefCannotBeAutoConverted</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果在 config 对象中拥有合法的 key 属性</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#59873A;">hasValidKey</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 将 config.key 属性中的值提取到 key 变量中</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">key</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">key</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">self</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">__self</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">__self</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">source</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">__source</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">__source</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 遍历 config 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">for</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">propName</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">in</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果当前遍历到的属性是对象自身属性</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 并且在 RESERVED_PROPS 对象中不存在该属性</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">hasOwnProperty</span><span style="color:#999999;">.</span><span style="color:#59873A;">call</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">propName</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">RESERVED_PROPS</span><span style="color:#999999;">.</span><span style="color:#59873A;">hasOwnProperty</span><span style="color:#999999;">(</span><span style="color:#B07D48;">propName</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 将满足条件的属性添加到 props 对象中 (普通属性)</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">props</span><span style="color:#999999;">[</span><span style="color:#B07D48;">propName</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">[</span><span style="color:#B07D48;">propName</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 将第三个及之后的参数挂载到 props.children 属性中</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 如果子元素是多个 props.children 是数组</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 如果子元素是一个 props.children 是对象</span></span>
<span class="line"><span style="color:#A0ADA0;">     */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 由于从第三个参数开始及以后都表示子元素</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 所以减去前两个参数的结果就是子元素的数量</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">childrenLength</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">arguments</span><span style="color:#999999;">.</span><span style="color:#998418;">length</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">-</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">2</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果子元素的数量是 1</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">childrenLength</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">1</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 直接将子元素挂载到到 props.children 属性上</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 此时 children 是对象类型</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">props</span><span style="color:#999999;">.</span><span style="color:#B07D48;">children</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">children</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果子元素的数量大于 1</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">childrenLength</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">1</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 创建数组, 数组中元素的数量等于子元素的数量</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">childArray</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">Array</span><span style="color:#999999;">(</span><span style="color:#B07D48;">childrenLength</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 开启循环 循环次匹配子元素的数量</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">for</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">childrenLength</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#AB5959;">++</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 将子元素添加到 childArray 数组中</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// i + 2 的原因是实参集合的前两个参数不是子元素</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">childArray</span><span style="color:#999999;">[</span><span style="color:#B07D48;">i</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">arguments</span><span style="color:#999999;">[</span><span style="color:#B07D48;">i</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">2</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果是开发环境</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">__DEV__</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果 Object 对象中存在 freeze 方法</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">Object</span><span style="color:#999999;">.</span><span style="color:#B07D48;">freeze</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 调用 freeze 方法 冻结 childArray 数组</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 防止 React 核心对象被修改 冻结对象提高性能</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">Object</span><span style="color:#999999;">.</span><span style="color:#59873A;">freeze</span><span style="color:#999999;">(</span><span style="color:#B07D48;">childArray</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 将子元素数组挂载到 props.children 属性中</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">props</span><span style="color:#999999;">.</span><span style="color:#B07D48;">children</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">childArray</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 如果当前处理是组件</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 看组件身上是否有 defaultProps 属性</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 这个属性中存储的是 props 对象中属性的默认值</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 遍历 defaultProps 对象 查看对应的 props 属性的值是否为 undefined</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 如果为undefined 就将默认值赋值给对应的 props 属性值</span></span>
<span class="line"><span style="color:#A0ADA0;">     */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 将 type 属性值视为函数 查看其中是否具有 defaultProps 属性</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">type</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">type</span><span style="color:#999999;">.</span><span style="color:#B07D48;">defaultProps</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 将 type 函数下的 defaultProps 属性赋值给 defaultProps 变量</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">defaultProps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">type</span><span style="color:#999999;">.</span><span style="color:#B07D48;">defaultProps</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 遍历 defaultProps 对象中的属性 将属性名称赋值给 propName 变量</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">for</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">propName</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">in</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">defaultProps</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果 props 对象中的该属性的值为 undefined</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">props</span><span style="color:#999999;">[</span><span style="color:#B07D48;">propName</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 将 defaultProps 对象中的对应属性的值赋值给 props 对象中的对应属性的值</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">props</span><span style="color:#999999;">[</span><span style="color:#B07D48;">propName</span><span style="color:#999999;">]</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">defaultProps</span><span style="color:#999999;">[</span><span style="color:#B07D48;">propName</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 在开发环境中 如果元素的 key 属性 或者 ref 属性存在</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 监测开发者是否在组件内部通过 props 对象获取了 key 属性或者 ref 属性</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 如果获取了 就报错</span></span>
<span class="line"><span style="color:#A0ADA0;">     */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果处于开发环境</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">__DEV__</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 元素具有 key 属性或者 ref 属性</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">key</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ref</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 看一下 type 属性中存储的是否是函数 如果是函数就表示当前元素是组件</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果元素不是组件 就直接返回元素类型字符串</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// displayName 用于在报错过程中显示是哪一个组件报错了</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果开发者显式定义了 displayName 属性 就显示开发者定义的</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 否者就显示组件名称 如果组件也没有名称 就显示 &#39;Unknown&#39;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">displayName</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">type</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">function</span><span style="color:#B56959AA;">&#39;</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">type</span><span style="color:#999999;">.</span><span style="color:#B07D48;">displayName</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">type</span><span style="color:#999999;">.</span><span style="color:#B07D48;">name</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">Unknown</span><span style="color:#B56959AA;">&#39;</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">type</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果 key 属性存在</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">key</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 为 props 对象添加key 属性</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 并指定当通过 props 对象获取 key 属性时报错</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">defineKeyPropWarningGetter</span><span style="color:#999999;">(</span><span style="color:#B07D48;">props</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">displayName</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果 ref 属性存在</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">ref</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 为 props 对象添加 ref 属性</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 并指定当通过 props 对象获取 ref 属性时报错</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">defineRefPropWarningGetter</span><span style="color:#999999;">(</span><span style="color:#B07D48;">props</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">displayName</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 返回 ReactElement</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">ReactElement</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">type</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">key</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">ref</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">self</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">source</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 在 Virtual DOM 中用于识别自定义组件</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">ReactCurrentOwner</span><span style="color:#999999;">.</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">props</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_2-2-reactelement" tabindex="-1">2.2 ReactElement <a class="header-anchor" href="#_2-2-reactelement" aria-hidden="true">#</a></h3><p><code>文件位置：packages/react/src/ReactElement.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 接收参数 返回 ReactElement</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">ReactElement</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">type</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">key</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ref</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">self</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">source</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">owner</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">props</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">element</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">         * 组件的类型, 十六进制数值或者 Symbol 值</span></span>
<span class="line"><span style="color:#758575DD;">         * React 在最终在渲染 DOM 的时候, 需要确保元素的类型是 REACT_ELEMENT_TYPE</span></span>
<span class="line"><span style="color:#758575DD;">         * 需要此属性作为判断的依据</span></span>
<span class="line"><span style="color:#758575DD;">         */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">$$typeof</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">REACT_ELEMENT_TYPE</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">         * 元素具体的类型值 如果是元素节点 type 属性中存储的就是 div span 等等</span></span>
<span class="line"><span style="color:#758575DD;">         * 如果元素是组件 type 属性中存储的就是组件的构造函数</span></span>
<span class="line"><span style="color:#758575DD;">         */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">type</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">type</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">         * 元素的唯一标识</span></span>
<span class="line"><span style="color:#758575DD;">         * 用作内部 vdom 比对 提升 DOM 操作性能</span></span>
<span class="line"><span style="color:#758575DD;">         */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">key</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">key</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">         * 存储元素 DOM 对象或者组件 实例对象</span></span>
<span class="line"><span style="color:#758575DD;">         */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">ref</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ref</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">         * 存储向组件内部传递的数据</span></span>
<span class="line"><span style="color:#758575DD;">         */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">props</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">props</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">         * 记录当前元素所属组件 (记录当前元素是哪个组件创建的)</span></span>
<span class="line"><span style="color:#758575DD;">         */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">_owner</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">owner</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 返回 ReactElement</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">element</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">};</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 接收参数 返回 ReactElement</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#59873A;">ReactElement</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">type</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">key</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ref</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">self</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">source</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">owner</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">props</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">element</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 组件的类型, 十六进制数值或者 Symbol 值</span></span>
<span class="line"><span style="color:#A0ADA0;">         * React 在最终在渲染 DOM 的时候, 需要确保元素的类型是 REACT_ELEMENT_TYPE</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 需要此属性作为判断的依据</span></span>
<span class="line"><span style="color:#A0ADA0;">         */</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">$$typeof</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">REACT_ELEMENT_TYPE</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 元素具体的类型值 如果是元素节点 type 属性中存储的就是 div span 等等</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 如果元素是组件 type 属性中存储的就是组件的构造函数</span></span>
<span class="line"><span style="color:#A0ADA0;">         */</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">type</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">type</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 元素的唯一标识</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 用作内部 vdom 比对 提升 DOM 操作性能</span></span>
<span class="line"><span style="color:#A0ADA0;">         */</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">key</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">key</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 存储元素 DOM 对象或者组件 实例对象</span></span>
<span class="line"><span style="color:#A0ADA0;">         */</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">ref</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ref</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 存储向组件内部传递的数据</span></span>
<span class="line"><span style="color:#A0ADA0;">         */</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">props</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">props</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 记录当前元素所属组件 (记录当前元素是哪个组件创建的)</span></span>
<span class="line"><span style="color:#A0ADA0;">         */</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">_owner</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">owner</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 返回 ReactElement</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">element</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">};</span></span>
<span class="line"></span></code></pre></div><h3 id="_2-3-hasvalidref" tabindex="-1">2.3 hasValidRef <a class="header-anchor" href="#_2-3-hasvalidref" aria-hidden="true">#</a></h3><p><code>文件位置：packages/react/src/ReactElement.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 查看参数对象中是否有合法的 ref 属性</span></span>
<span class="line"><span style="color:#758575DD;"> * 返回布尔值</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">hasValidRef</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">ref</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 查看参数对象中是否有合法的 ref 属性</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 返回布尔值</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">hasValidRef</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">ref</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_2-4-hasvalidkey" tabindex="-1">2.4 hasValidKey <a class="header-anchor" href="#_2-4-hasvalidkey" aria-hidden="true">#</a></h3><p><code>文件位置：packages/react/src/ReactElement.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 查看参数对象中是否有合法的 key 属性</span></span>
<span class="line"><span style="color:#758575DD;"> * 返回布尔值</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">hasValidKey</span><span style="color:#666666;">(</span><span style="color:#BD976A;">config</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">config</span><span style="color:#666666;">.</span><span style="color:#BD976A;">key</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 查看参数对象中是否有合法的 key 属性</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 返回布尔值</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">hasValidKey</span><span style="color:#999999;">(</span><span style="color:#B07D48;">config</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">config</span><span style="color:#999999;">.</span><span style="color:#B07D48;">key</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_2-5-isvalidelement" tabindex="-1">2.5 isValidElement <a class="header-anchor" href="#_2-5-isvalidelement" aria-hidden="true">#</a></h3><p><code>文件位置：packages/react/src/ReactElement.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 验证 object 参数是否是 ReactElement. 返回布尔值</span></span>
<span class="line"><span style="color:#758575DD;"> * 验证成功的条件:</span></span>
<span class="line"><span style="color:#758575DD;"> * object 是对象</span></span>
<span class="line"><span style="color:#758575DD;"> * object 不为null</span></span>
<span class="line"><span style="color:#758575DD;"> * object对象中的 $$typeof 属性值为 REACT_ELEMENT_TYPE</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">isValidElement</span><span style="color:#666666;">(</span><span style="color:#BD976A;">object</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">object</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">object</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">object</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">object</span><span style="color:#666666;">.</span><span style="color:#BD976A;">$$typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">REACT_ELEMENT_TYPE</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 验证 object 参数是否是 ReactElement. 返回布尔值</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 验证成功的条件:</span></span>
<span class="line"><span style="color:#A0ADA0;"> * object 是对象</span></span>
<span class="line"><span style="color:#A0ADA0;"> * object 不为null</span></span>
<span class="line"><span style="color:#A0ADA0;"> * object对象中的 $$typeof 属性值为 REACT_ELEMENT_TYPE</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">isValidElement</span><span style="color:#999999;">(</span><span style="color:#B07D48;">object</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">object</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">object</span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">object</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">object</span><span style="color:#999999;">.</span><span style="color:#B07D48;">$$typeof</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">REACT_ELEMENT_TYPE</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_2-6-definekeypropwarninggetter" tabindex="-1">2.6 defineKeyPropWarningGetter <a class="header-anchor" href="#_2-6-definekeypropwarninggetter" aria-hidden="true">#</a></h3><p><code>文件位置：packages/react/src/ReactElement.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki has-diff vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> *  指定当通过 props 对象获取 key 属性时报错</span></span>
<span class="line"><span style="color:#758575DD;"> *  props        组件中的 props 对象</span></span>
<span class="line"><span style="color:#758575DD;"> *  displayName  组件名称标识</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">defineKeyPropWarningGetter</span><span style="color:#666666;">(</span><span style="color:#BD976A;">props</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">displayName</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 通过 props 对象获取 key 属性报错</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">warnAboutAccessingKey</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 在开发环境中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">__DEV__</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// specialPropKeyWarningShown 控制错误只输出一次的变量</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">specialPropKeyWarningShown</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 通过 specialPropKeyWarningShown 变量锁住判断条件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">specialPropKeyWarningShown</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 指定报错信息和组件名称</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">error</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">%s: `key` is not a prop. Trying to access it will result </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">in `undefined` being returned. If you need to access the same </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">value within the child component, you should pass it as a different </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">prop. (https://reactjs.org/link/special-props)</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">displayName</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">warnAboutAccessingKey</span><span style="color:#666666;">.</span><span style="color:#BD976A;">isReactWarning</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 为 props 对象添加 key 属性</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">Object</span><span style="color:#666666;">.</span><span style="color:#80A665;">defineProperty</span><span style="color:#666666;">(</span><span style="color:#BD976A;">props</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">key</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 当获取 key 属性时调用 warnAboutAccessingKey 方法进行报错</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">get</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">warnAboutAccessingKey</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">configurable</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki has-diff vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> *  指定当通过 props 对象获取 key 属性时报错</span></span>
<span class="line"><span style="color:#A0ADA0;"> *  props        组件中的 props 对象</span></span>
<span class="line"><span style="color:#A0ADA0;"> *  displayName  组件名称标识</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">defineKeyPropWarningGetter</span><span style="color:#999999;">(</span><span style="color:#B07D48;">props</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">displayName</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 通过 props 对象获取 key 属性报错</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#59873A;">warnAboutAccessingKey</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 在开发环境中</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">__DEV__</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// specialPropKeyWarningShown 控制错误只输出一次的变量</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">specialPropKeyWarningShown</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 通过 specialPropKeyWarningShown 变量锁住判断条件</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">specialPropKeyWarningShown</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 指定报错信息和组件名称</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">error</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">%s: `key` is not a prop. Trying to access it will result </span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">in `undefined` being returned. If you need to access the same </span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">value within the child component, you should pass it as a different </span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">prop. (https://reactjs.org/link/special-props)</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">displayName</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">warnAboutAccessingKey</span><span style="color:#999999;">.</span><span style="color:#B07D48;">isReactWarning</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 为 props 对象添加 key 属性</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">Object</span><span style="color:#999999;">.</span><span style="color:#59873A;">defineProperty</span><span style="color:#999999;">(</span><span style="color:#B07D48;">props</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">key</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 当获取 key 属性时调用 warnAboutAccessingKey 方法进行报错</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">get</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">warnAboutAccessingKey</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">configurable</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_2-7-definerefpropwarninggetter" tabindex="-1">2.7 defineRefPropWarningGetter <a class="header-anchor" href="#_2-7-definerefpropwarninggetter" aria-hidden="true">#</a></h3><p><code>文件位置：packages/react/src/ReactElement.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki has-diff vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> *  指定当通过 props 对象获取 ref 属性时报错</span></span>
<span class="line"><span style="color:#758575DD;"> *  props        组件中的 props 对象</span></span>
<span class="line"><span style="color:#758575DD;"> *  displayName  组件名称标识</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">defineRefPropWarningGetter</span><span style="color:#666666;">(</span><span style="color:#BD976A;">props</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">displayName</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 通过 props 对象获取 ref 属性报错</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">warnAboutAccessingRef</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">__DEV__</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// specialPropRefWarningShown 控制错误只输出一次的变量</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">specialPropRefWarningShown</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 通过 specialPropRefWarningShown 变量锁住判断条件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">specialPropRefWarningShown</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 指定报错信息和组件名称</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">error</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">%s: `ref` is not a prop. Trying to access it will result </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">in `undefined` being returned. If you need to access the same </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">value within the child component, you should pass it as a different </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">prop. (https://reactjs.org/link/special-props)</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">displayName</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">warnAboutAccessingRef</span><span style="color:#666666;">.</span><span style="color:#BD976A;">isReactWarning</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 为 props 对象添加 key 属性</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">Object</span><span style="color:#666666;">.</span><span style="color:#80A665;">defineProperty</span><span style="color:#666666;">(</span><span style="color:#BD976A;">props</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">ref</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">get</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">warnAboutAccessingRef</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">configurable</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki has-diff vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> *  指定当通过 props 对象获取 ref 属性时报错</span></span>
<span class="line"><span style="color:#A0ADA0;"> *  props        组件中的 props 对象</span></span>
<span class="line"><span style="color:#A0ADA0;"> *  displayName  组件名称标识</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">defineRefPropWarningGetter</span><span style="color:#999999;">(</span><span style="color:#B07D48;">props</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">displayName</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 通过 props 对象获取 ref 属性报错</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#59873A;">warnAboutAccessingRef</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">__DEV__</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// specialPropRefWarningShown 控制错误只输出一次的变量</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">specialPropRefWarningShown</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 通过 specialPropRefWarningShown 变量锁住判断条件</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">specialPropRefWarningShown</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 指定报错信息和组件名称</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">error</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">%s: `ref` is not a prop. Trying to access it will result </span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">in `undefined` being returned. If you need to access the same </span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">value within the child component, you should pass it as a different </span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">prop. (https://reactjs.org/link/special-props)</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">displayName</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">warnAboutAccessingRef</span><span style="color:#999999;">.</span><span style="color:#B07D48;">isReactWarning</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 为 props 对象添加 key 属性</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">Object</span><span style="color:#999999;">.</span><span style="color:#59873A;">defineProperty</span><span style="color:#999999;">(</span><span style="color:#B07D48;">props</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">ref</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">get</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">warnAboutAccessingRef</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">configurable</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="_3-react-架构" tabindex="-1">3. React 架构 <a class="header-anchor" href="#_3-react-架构" aria-hidden="true">#</a></h2><p>React 16 版本的架构可以分为三层：调度层、协调层、渲染层。</p><ul><li>Scheduler (调度层)：调度任务的优先级，高优任务优先进入协调器</li><li>Reconciler (协调层)：构建 Fiber 数据结构，比对 Fiber 对象找出差异, 记录 Fiber 对象要进行的 DOM 操作</li><li>Renderer (渲染层)：负责将发生变化的部分渲染到页面上</li></ul><h3 id="_3-1-scheduler-调度层" tabindex="-1">3.1 Scheduler 调度层 <a class="header-anchor" href="#_3-1-scheduler-调度层" aria-hidden="true">#</a></h3><p>在 React 15 的版本中，采用了循环加递归的方式进行了 virtualDOM 的比对，由于递归使用 JavaScript 自身的执行栈，一旦开始就无法停止，直到任务执行完成。如果 VirtualDOM 树的层级比较深，virtualDOM 的比对就会长期占用 JavaScript 主线程，由于 JavaScript 又是单线程的无法同时执行其他任务，所以在比对的过程中无法响应用户操作，无法即时执行元素动画，造成了页面卡顿的现象。</p><p>在 React 16 的版本中，放弃了 JavaScript 递归的方式进行 virtualDOM 的比对，而是采用循环模拟递归。而且比对的过程是利用浏览器的空闲时间完成的，不会长期占用主线程，这就解决了 virtualDOM 比对造成页面卡顿的问题。</p><p>在 window 对象中提供了 requestIdleCallback API，它可以利用浏览器的空闲时间执行任务，但是它自身也存在一些问题，比如说并不是所有的浏览器都支持它，而且它的触发频率也不是很稳定，所以 React 最终放弃了 requestIdleCallback 的使用。</p><p>在 React 中，官方实现了自己的任务调度库，这个库就叫做 Scheduler。它也可以实现在浏览器空闲时执行任务，而且还可以设置任务的优先级，高优先级任务先执行，低优先级任务后执行。</p><p>Scheduler 存储在 <code>packages/scheduler</code> 文件夹中。</p><h3 id="_3-2-reconciler-协调层" tabindex="-1">3.2 Reconciler 协调层 <a class="header-anchor" href="#_3-2-reconciler-协调层" aria-hidden="true">#</a></h3><p>在 React 15 的版本中，协调器和渲染器交替执行，即找到了差异就直接更新差异。在 React 16 的版本中，这种情况发生了变化，协调器和渲染器不再交替执行。协调器负责找出差异，在所有差异找出之后，统一交给渲染器进行 DOM 的更新。也就是说协调器的主要任务就是找出差异部分，并为差异打上标记。</p><h3 id="_3-3-renderer-渲染层" tabindex="-1">3.3 Renderer 渲染层 <a class="header-anchor" href="#_3-3-renderer-渲染层" aria-hidden="true">#</a></h3><p>渲染器根据协调器为 Fiber 节点打的标记，同步执行对应的 DOM 操作。</p><p>既然比对的过程从递归变成了可以中断的循环，那么 React 是如何解决中断更新时 DOM 渲染不完全的问题呢？</p><p>其实根本就不存在这个问题，因为在整个过程中，调度器和协调器的工作是在内存中完成的是可以被打断的，渲染器的工作被设定成不可以被打断，所以不存在 DOM 渲染不完全的问题。</p><h2 id="_4-数据结构" tabindex="-1">4. 数据结构 <a class="header-anchor" href="#_4-数据结构" aria-hidden="true">#</a></h2><h3 id="_4-1-fiber" tabindex="-1">4.1 Fiber <a class="header-anchor" href="#_4-1-fiber" aria-hidden="true">#</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">type</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#758575DD;">/************************  DOM 实例相关  *****************************/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 标记不同的组件类型, 值详见 WorkTag</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">WorkTag</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 组件类型 div、span、组件构造函数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">type</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 实例对象, 如类组件的实例、原生 dom 实例, 而 function 组件没有实例, 因此该属性是空</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">stateNode</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#758575DD;">/************************  构建 Fiber 树相关  ***************************/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 指向自己的父级 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">return</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 指向自己的第一个子级 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">child</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 指向自己的下一个兄弟 iber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">sibling</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 在 Fiber 树更新的过程中，每个 Fiber 都会有一个跟其对应的 Fiber</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 我们称他为 current &lt;==&gt; workInProgress</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 在渲染完成之后他们会交换位置</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// alternate 指向当前 Fiber 在 workInProgress 树中的对应 Fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">alternate</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#758575DD;">/************************  状态数据相关  ********************************/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 即将更新的 props</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">pendingProps</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 旧的 props</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">memoizedProps</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 旧的 state</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">memoizedState</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#758575DD;">/************************  副作用相关 ******************************/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 该 Fiber 对应的组件产生的状态更新会存放在这个队列里面</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">updateQueue</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">UpdateQueue</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">&gt; | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 用来记录当前 Fiber 要执行的 DOM 操作</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">effectTag</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">SideEffectTag</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 存储第一个要执行副作用的子级 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">firstEffect</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 存储下一个要执行副作用的子级 Fiber 对象</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 执行 DOM 渲染时要先通过 first 找到第一个, 然后通过 next 一直向后查找</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 存储 DOM 操作完后的副作用 比如调用生命周期函数或者钩子函数的调用</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">lastEffect</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 任务的过期时间</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExpirationTime</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 当前组件及子组件处于何种渲染模式 详见 TypeOfMode</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">mode</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">TypeOfMode</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">};</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">type</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Fiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">/************************  DOM 实例相关  *****************************/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 标记不同的组件类型, 值详见 WorkTag</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">: </span><span style="color:#2E808F;">WorkTag</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 组件类型 div、span、组件构造函数</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">type</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 实例对象, 如类组件的实例、原生 dom 实例, 而 function 组件没有实例, 因此该属性是空</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">stateNode</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">/************************  构建 Fiber 树相关  ***************************/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 指向自己的父级 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">return</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 指向自己的第一个子级 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">child</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 指向自己的下一个兄弟 iber 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">sibling</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 在 Fiber 树更新的过程中，每个 Fiber 都会有一个跟其对应的 Fiber</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 我们称他为 current &lt;==&gt; workInProgress</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 在渲染完成之后他们会交换位置</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// alternate 指向当前 Fiber 在 workInProgress 树中的对应 Fiber</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">alternate</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">/************************  状态数据相关  ********************************/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 即将更新的 props</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">pendingProps</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 旧的 props</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">memoizedProps</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 旧的 state</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">memoizedState</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">/************************  副作用相关 ******************************/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 该 Fiber 对应的组件产生的状态更新会存放在这个队列里面</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">updateQueue</span><span style="color:#999999;">: </span><span style="color:#2E808F;">UpdateQueue</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">any</span><span style="color:#999999;">&gt; | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 用来记录当前 Fiber 要执行的 DOM 操作</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">effectTag</span><span style="color:#999999;">: </span><span style="color:#2E808F;">SideEffectTag</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 存储第一个要执行副作用的子级 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">firstEffect</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 存储下一个要执行副作用的子级 Fiber 对象</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 执行 DOM 渲染时要先通过 first 找到第一个, 然后通过 next 一直向后查找</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 存储 DOM 操作完后的副作用 比如调用生命周期函数或者钩子函数的调用</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">lastEffect</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 任务的过期时间</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExpirationTime</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 当前组件及子组件处于何种渲染模式 详见 TypeOfMode</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">mode</span><span style="color:#999999;">: </span><span style="color:#2E808F;">TypeOfMode</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">};</span></span>
<span class="line"></span></code></pre></div><p><img src="/assets/image14.18bf33a2.png" alt="1.png"></p><h3 id="_4-2-worktag" tabindex="-1">4.2 WorkTag <a class="header-anchor" href="#_4-2-worktag" aria-hidden="true">#</a></h3><p><code>文件位置：packages/shared/ReactWorkTags.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">type</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">WorkTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">1</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">2</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">3</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">4</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">5</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">6</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">7</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">8</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">9</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">10</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">11</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">12</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">13</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">14</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">15</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">16</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">17</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">18</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">19</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">20</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">21</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">22</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">FunctionComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ClassComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">1</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">IndeterminateComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">2</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostRoot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">3</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostPortal</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">4</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">5</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostText</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">6</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Fragment</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">7</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Mode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">8</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ContextConsumer</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">9</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ContextProvider</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">10</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ForwardRef</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">11</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Profiler</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">12</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">SuspenseComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">13</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">MemoComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">14</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">SimpleMemoComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">15</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">LazyComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">16</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">IncompleteClassComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">17</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">DehydratedFragment</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">18</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">SuspenseListComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">19</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">FundamentalComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">20</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ScopeComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">21</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Block</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">22</span><span style="color:#666666;">;</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">type</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">WorkTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">1</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">2</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">3</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">4</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">5</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">6</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">7</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">8</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">9</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">10</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">11</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">12</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">13</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">14</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">15</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">16</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">17</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">18</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">19</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">20</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">21</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">22</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">FunctionComponent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ClassComponent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">1</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">IndeterminateComponent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">2</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostRoot</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">3</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostPortal</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">4</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostComponent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">5</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostText</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">6</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Fragment</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">7</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Mode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">8</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ContextConsumer</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">9</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ContextProvider</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">10</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ForwardRef</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">11</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Profiler</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">12</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">SuspenseComponent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">13</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">MemoComponent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">14</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">SimpleMemoComponent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">15</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">LazyComponent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">16</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">IncompleteClassComponent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">17</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">DehydratedFragment</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">18</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">SuspenseListComponent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">19</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">FundamentalComponent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">20</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ScopeComponent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">21</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Block</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">22</span><span style="color:#999999;">;</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-3-typeofmode" tabindex="-1">4.3 TypeOfMode <a class="header-anchor" href="#_4-3-typeofmode" aria-hidden="true">#</a></h3><p><code>文件位置: packages/react-reconciler/src/ReactTypeOfMode.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">type</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">TypeOfMode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">number</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// 0 同步渲染模式</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoMode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0000</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#758575DD;">// 1 严格模式</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">StrictMode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0001</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#758575DD;">// 10 异步渲染过渡模式</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">BlockingMode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0010</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#758575DD;">// 100 异步渲染模式</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ConcurrentMode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0100</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#758575DD;">// 1000 性能测试模式</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ProfileMode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b1000</span><span style="color:#666666;">;</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">type</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">TypeOfMode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">number</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// 0 同步渲染模式</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoMode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0000</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#A0ADA0;">// 1 严格模式</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">StrictMode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0001</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#A0ADA0;">// 10 异步渲染过渡模式</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">BlockingMode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0010</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#A0ADA0;">// 100 异步渲染模式</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ConcurrentMode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0100</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#A0ADA0;">// 1000 性能测试模式</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ProfileMode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b1000</span><span style="color:#999999;">;</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-3-sideeffecttag" tabindex="-1">4.3 SideEffectTag <a class="header-anchor" href="#_4-3-sideeffecttag" aria-hidden="true">#</a></h3><p><code>文件位置：packages/shared/ReactSideEffectTags.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">type</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">SideEffectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">number</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// Don&#39;t change these two values. They&#39;re used by React Dev Tools.</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*              */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0000000000000</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 0</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">PerformedWork</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*         */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0000000000001</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// You can change the rest (and add more).</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Placement</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*             */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0000000000010</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 2</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Update</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*                */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0000000000100</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 4</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">PlacementAndUpdate</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*    */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0000000000110</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 6</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Deletion</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*              */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0000000001000</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 8</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ContentReset</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*          */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0000000010000</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 16</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Callback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*              */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0000000100000</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 32</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">DidCapture</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*            */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0000001000000</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 64</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Ref</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*                   */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0000010000000</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 128</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Snapshot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*              */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0000100000000</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 256</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Passive</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*               */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0001000000000</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 512</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Hydrating</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*             */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0010000000000</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 1024</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HydratingAndUpdate</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*    */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0010000000100</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 1028</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// Passive &amp; Update &amp; Callback &amp; Ref &amp; Snapshot</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">LifecycleEffectMask</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*   */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0001110100100</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 932</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// Union of all host effects</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostEffectMask</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*        */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0011111111111</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 2047</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Incomplete</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*            */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b0100000000000</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 2048</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ShouldCapture</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">/*         */</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0b1000000000000</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">// 4096</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">type</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">SideEffectTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">number</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// Don&#39;t change these two values. They&#39;re used by React Dev Tools.</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*              */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0000000000000</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 0</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">PerformedWork</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*         */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0000000000001</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// You can change the rest (and add more).</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Placement</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*             */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0000000000010</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 2</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Update</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*                */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0000000000100</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 4</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">PlacementAndUpdate</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*    */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0000000000110</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 6</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Deletion</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*              */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0000000001000</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 8</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ContentReset</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*          */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0000000010000</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 16</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Callback</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*              */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0000000100000</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 32</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">DidCapture</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*            */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0000001000000</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 64</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Ref</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*                   */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0000010000000</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 128</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Snapshot</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*              */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0000100000000</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 256</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Passive</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*               */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0001000000000</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 512</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Hydrating</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*             */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0010000000000</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 1024</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HydratingAndUpdate</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*    */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0010000000100</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 1028</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// Passive &amp; Update &amp; Callback &amp; Ref &amp; Snapshot</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">LifecycleEffectMask</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*   */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0001110100100</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 932</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// Union of all host effects</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostEffectMask</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*        */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0011111111111</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 2047</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Incomplete</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*            */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b0100000000000</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 2048</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ShouldCapture</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">/*         */</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0b1000000000000</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">// 4096</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-4-update" tabindex="-1">4.4 Update <a class="header-anchor" href="#_4-4-update" aria-hidden="true">#</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">update</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Update</span><span style="color:#666666;">&lt;*&gt; =</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">suspenseConfig</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">tag</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">UpdateState</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">payload</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">callback</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">next</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">null</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">};</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">update</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Update</span><span style="color:#999999;">&lt;*&gt; =</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">suspenseConfig</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">tag</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">UpdateState</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">payload</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">callback</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">next</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">null</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">)</span><span style="color:#393A34;">,</span></span>
<span class="line"><span style="color:#393A34;">};</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-5-updatequeue" tabindex="-1">4.5 UpdateQueue <a class="header-anchor" href="#_4-5-updatequeue" aria-hidden="true">#</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">queue</span><span style="color:#666666;">: &lt;</span><span style="color:#5DA9A7;">State</span><span style="color:#666666;">&gt; =</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 上一次更新之后的 state, 作为下一次更新的基础</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">baseState</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedState</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">baseQueue</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">shared</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#B8A965;">pending</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#B8A965;">effects</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#BD976A;">fiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">updateQueue</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">queue</span><span style="color:#666666;">;</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#59873A;">queue</span><span style="color:#999999;">: &lt;</span><span style="color:#2E808F;">State</span><span style="color:#999999;">&gt; =</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 上一次更新之后的 state, 作为下一次更新的基础</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">baseState</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedState</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">baseQueue</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">shared</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#998418;">pending</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#998418;">effects</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#B07D48;">fiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">updateQueue</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">queue</span><span style="color:#999999;">;</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-6-roottag" tabindex="-1">4.6 RootTag <a class="header-anchor" href="#_4-6-roottag" aria-hidden="true">#</a></h3><p><code>文件位置：packages/shared/ReactRootTags.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">type</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">RootTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">1</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">2</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD;">// ReactDOM.render</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">LegacyRoot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#758575DD;">// ReactDOM.createBlockingRoot</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">BlockingRoot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">1</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#758575DD;">// ReactDOM.createRoot</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ConcurrentRoot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">2</span><span style="color:#666666;">;</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">type</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">RootTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span><span style="color:#393A34;"> </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">1</span><span style="color:#393A34;"> </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">2</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;">// ReactDOM.render</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">LegacyRoot</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#A0ADA0;">// ReactDOM.createBlockingRoot</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">BlockingRoot</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">1</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#A0ADA0;">// ReactDOM.createRoot</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ConcurrentRoot</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">2</span><span style="color:#999999;">;</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-7-双缓存技术" tabindex="-1">4.7 双缓存技术 <a class="header-anchor" href="#_4-7-双缓存技术" aria-hidden="true">#</a></h3><p>在 React 中，DOM 的更新采用了双缓存技术，双缓存技术致力于更快速的 DOM 更新。</p><p>什么是双缓存？举个例子，使用 canvas 绘制动画时，在绘制每一帧前都会清除上一帧的画面，清除上一帧需要花费时间，如果当前帧画面计算量又比较大，又需要花费比较长的时间，这就导致上一帧清除到下一帧显示中间会有较长的间隙，就会出现白屏。</p><p>为了解决这个问题，我们可以在内存中绘制当前帧动画，绘制完毕后直接用当前帧替换上一帧画面，这样的话在帧画面替换的过程中就会节约非常多的时间，就不会出现白屏问题。这种在内存中构建并直接替换的技术叫做双缓存。</p><p>React 使用双缓存技术完成 Fiber 树的构建与替换，实现 DOM 对象的快速更新。</p><p>在 React 中最多会同时存在两棵 Fiber 树，当前在屏幕中显示的内容对应的 Fiber 树叫做 current Fiber 树，当发生更新时，React 会在内存中重新构建一颗新的 Fiber 树，这颗正在构建的 Fiber 树叫做 workInProgress Fiber 树。在双缓存技术中，workInProgress Fiber 树就是即将要显示在页面中的 Fiber 树，当这颗 Fiber 树构建完成后，React 会使用它直接替换 current Fiber 树达到快速更新 DOM 的目的，因为 workInProgress Fiber 树是在内存中构建的所以构建它的速度是非常快的。</p><p>一旦 workInProgress Fiber 树在屏幕上呈现，它就会变成 current Fiber 树。</p><p>在 current Fiber 节点对象中有一个 alternate 属性指向对应的 workInProgress Fiber 节点对象，在 workInProgress Fiber 节点中有一个 alternate 属性也指向对应的 current Fiber 节点对象。</p><p><img src="/assets/image15.d280467b.png" alt="3.png"><img src="/assets/image16.5ba1f22a.png" alt="3.png"></p><h3 id="_4-8-区分-fiberroot-与-rootfiber" tabindex="-1">4.8 区分 fiberRoot 与 rootFiber <a class="header-anchor" href="#_4-8-区分-fiberroot-与-rootfiber" aria-hidden="true">#</a></h3><p>fiberRoot 表示 Fiber 数据结构对象，是 Fiber 数据结构中的最外层对象</p><p>rootFiber 表示组件挂载点对应的 Fiber 对象，比如 React 应用中默认的组件挂载点就是 id 为 root 的 div</p><p>fiberRoot 包含 rootFiber，在 fiberRoot 对象中有一个 current 属性，存储 rootFiber</p><p>rootFiber 指向 fiberRoot，在 rootFiber 对象中有一个 stateNode 属性，指向 fiberRoot</p><p>在 React 应用中 FiberRoot 只有一个，而 rootFiber 可以有多个，因为 render 方法是可以调用多次的</p><p>fiberRoot 会记录应用的更新信息，比如协调器在完成工作后，会将工作成果存储在 fiberRoot 中。</p><p><img src="/assets/image17.4fffedf8.png" alt="3.png"></p><h2 id="_5-初始化渲染" tabindex="-1">5. 初始化渲染 <a class="header-anchor" href="#_5-初始化渲染" aria-hidden="true">#</a></h2><p>要将 React 元素渲染到页面中，分为两个阶段，render 阶段和 commit 阶段。</p><p>render 阶段负责创建 Fiber 数据结构并为 Fiber 节点打标记，标记当前 Fiber 节点要进行的 DOM 操作。</p><p>commit 阶段负责根据 Fiber 节点标记 ( effectTag ) 进行相应的 DOM 操作。</p><h3 id="_5-1-render-阶段" tabindex="-1">5.1 render 阶段 <a class="header-anchor" href="#_5-1-render-阶段" aria-hidden="true">#</a></h3><h4 id="_5-1-1-render" tabindex="-1">5.1.1 render <a class="header-anchor" href="#_5-1-1-render" aria-hidden="true">#</a></h4><p><code>文件位置：packages/react-dom/src/client/ReactDOMLegacy.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 渲染入口</span></span>
<span class="line"><span style="color:#758575DD;"> * element 要进行渲染的 ReactElement, createElement 方法的返回值</span></span>
<span class="line"><span style="color:#758575DD;"> * container 渲染容器 &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#758575DD;"> * callback 渲染完成后执行的回调函数</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">render</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">element</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">React$Element</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">&gt;,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">container</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Container</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">callback</span><span style="color:#666666;">: </span><span style="color:#CB7676;">?</span><span style="color:#5DA9A7;">Function</span></span>
<span class="line"><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 检测 container 是否是符合要求的渲染容器</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 即检测 container 是否是真实的DOM对象</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果不符合要求就报错</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">invariant</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">isValidContainer</span><span style="color:#666666;">(</span><span style="color:#BD976A;">container</span><span style="color:#666666;">),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">Target container is not a DOM element.</span><span style="color:#C98A7DAA;">&#39;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">legacyRenderSubtreeIntoContainer</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 父组件 初始渲染没有父组件 传递 null 占位</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">element</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">container</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 是否为服务器端渲染 false 不是服务器端渲染 true 是服务器端渲染</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">false</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">callback</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 渲染入口</span></span>
<span class="line"><span style="color:#A0ADA0;"> * element 要进行渲染的 ReactElement, createElement 方法的返回值</span></span>
<span class="line"><span style="color:#A0ADA0;"> * container 渲染容器 &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#A0ADA0;"> * callback 渲染完成后执行的回调函数</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">render</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">element</span><span style="color:#999999;">: </span><span style="color:#2E808F;">React$Element</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">any</span><span style="color:#999999;">&gt;,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">container</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Container</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">callback</span><span style="color:#999999;">: </span><span style="color:#AB5959;">?</span><span style="color:#2E808F;">Function</span></span>
<span class="line"><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 检测 container 是否是符合要求的渲染容器</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 即检测 container 是否是真实的DOM对象</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果不符合要求就报错</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">invariant</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">isValidContainer</span><span style="color:#999999;">(</span><span style="color:#B07D48;">container</span><span style="color:#999999;">),</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">Target container is not a DOM element.</span><span style="color:#B56959AA;">&#39;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">legacyRenderSubtreeIntoContainer</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 父组件 初始渲染没有父组件 传递 null 占位</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">element</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">container</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 是否为服务器端渲染 false 不是服务器端渲染 true 是服务器端渲染</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">false</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">callback</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-1-2-isvalidcontainer" tabindex="-1">5.1.2 isValidContainer <a class="header-anchor" href="#_5-1-2-isvalidcontainer" aria-hidden="true">#</a></h4><p><code>文件位置：packages/react-dom/src/client/ReactDOMRoot.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 判断 node 是否是符合要求的 DOM 节点</span></span>
<span class="line"><span style="color:#758575DD;"> * 1. node 可以是元素节点</span></span>
<span class="line"><span style="color:#758575DD;"> * 2. node 可以是 document 节点</span></span>
<span class="line"><span style="color:#758575DD;"> * 3. node 可以是 文档碎片节点</span></span>
<span class="line"><span style="color:#758575DD;"> * 4. node 可以是注释节点但注释内容必须是 react-mount-point-unstable</span></span>
<span class="line"><span style="color:#758575DD;"> * 		react 内部会找到注释节点的父级 通过调用父级元素的 insertBefore 方法, 将 element 插入到注释节点的前面</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">isValidContainer</span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">mixed</span><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">boolean</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!!</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">node</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nodeType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ELEMENT_NODE</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nodeType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">DOCUMENT_NODE</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nodeType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">DOCUMENT_FRAGMENT_NODE</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nodeType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">COMMENT_NODE</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;">.nodeValue === &#39; react-mount-point-unstable &#39;))</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    );</span></span>
<span class="line"><span style="color:#DBD7CAEE;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 判断 node 是否是符合要求的 DOM 节点</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 1. node 可以是元素节点</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 2. node 可以是 document 节点</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 3. node 可以是 文档碎片节点</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 4. node 可以是注释节点但注释内容必须是 react-mount-point-unstable</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 		react 内部会找到注释节点的父级 通过调用父级元素的 insertBefore 方法, 将 element 插入到注释节点的前面</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">isValidContainer</span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#999999;">: </span><span style="color:#2E808F;">mixed</span><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">boolean</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!!</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">node</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nodeType</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ELEMENT_NODE</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nodeType</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">DOCUMENT_NODE</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nodeType</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">DOCUMENT_FRAGMENT_NODE</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nodeType</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">COMMENT_NODE</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">)</span><span style="color:#393A34;">.nodeValue === &#39; react-mount-point-unstable &#39;))</span></span>
<span class="line"><span style="color:#393A34;">    );</span></span>
<span class="line"><span style="color:#393A34;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-1-3-初始化-fiberroot" tabindex="-1">5.1.3 初始化 FiberRoot <a class="header-anchor" href="#_5-1-3-初始化-fiberroot" aria-hidden="true">#</a></h4><h5 id="_5-1-3-1-legacyrendersubtreeintocontainer" tabindex="-1">5.1.3.1 legacyRenderSubtreeIntoContainer <a class="header-anchor" href="#_5-1-3-1-legacyrendersubtreeintocontainer" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-dom/src/client/ReactDOMLegacy.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 将子树渲染到容器中 (初始化 Fiber 数据结构: 创建 fiberRoot 及 rootFiber)</span></span>
<span class="line"><span style="color:#758575DD;"> * parentComponent: 父组件, 初始渲染传入了 null</span></span>
<span class="line"><span style="color:#758575DD;"> * children: render 方法中的第一个参数, 要渲染的 ReactElement</span></span>
<span class="line"><span style="color:#758575DD;"> * container: 渲染容器</span></span>
<span class="line"><span style="color:#758575DD;"> * forceHydrate: true 为服务端渲染, false 为客户端渲染</span></span>
<span class="line"><span style="color:#758575DD;"> * callback: 组件渲染完成后需要执行的回调函数</span></span>
<span class="line"><span style="color:#758575DD;"> **/</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">legacyRenderSubtreeIntoContainer</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">parentComponent</span><span style="color:#666666;">: </span><span style="color:#CB7676;">?</span><span style="color:#5DA9A7;">React$Component</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">, </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">&gt;,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">children</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ReactNodeList</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">container</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Container</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">forceHydrate</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">boolean</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">callback</span><span style="color:#666666;">: </span><span style="color:#CB7676;">?</span><span style="color:#5DA9A7;">Function</span></span>
<span class="line"><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">     * 检测 container 是否已经是初始化过的渲染容器</span></span>
<span class="line"><span style="color:#758575DD;">     * react 在初始渲染时会为最外层容器添加 _reactRootContainer 属性</span></span>
<span class="line"><span style="color:#758575DD;">     * react 会根据此属性进行不同的渲染方式</span></span>
<span class="line"><span style="color:#758575DD;">     * root 不存在 表示初始渲染</span></span>
<span class="line"><span style="color:#758575DD;">     * root 存在 表示更新</span></span>
<span class="line"><span style="color:#758575DD;">     */</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取 container 容器对象下是否有 _reactRootContainer 属性</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">RootType</span><span style="color:#666666;"> =</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#BD976A;">_reactRootContainer</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">any</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 即将存储根 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fiberRoot</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">root</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始渲染</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始化根 Fiber 数据结构</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 为 container 容器添加 _reactRootContainer 属性</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 在 _reactRootContainer 对象中有一个属性叫做 _internalRoot</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// _internalRoot 属性值即为 FiberRoot 表示根节点 Fiber 数据结构</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// legacyCreateRootFromDOMContainer</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// createLegacyRoot</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// new ReactDOMBlockingRoot -&gt; this._internalRoot</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// createRootImpl</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">root</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#BD976A;">_reactRootContainer</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">legacyCreateRootFromDOMContainer</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">container</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">forceHydrate</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 获取 Fiber Root 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">fiberRoot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">_internalRoot</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">         * 改变 callback 函数中的 this 指向</span></span>
<span class="line"><span style="color:#758575DD;">         * 使其指向 render 方法第一个参数的真实 DOM 对象</span></span>
<span class="line"><span style="color:#758575DD;">         */</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果 callback 参数是函数类型</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">callback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">function</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 使用 originalCallback 存储 callback 函数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">originalCallback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">callback</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 为 callback 参数重新赋值</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">callback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 获取 render 方法第一个参数的真实 DOM 对象</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 实际上就是 id=&quot;root&quot; 的 div 的子元素</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// rootFiber.child.stateNode</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// rootFiber 就是 id=&quot;root&quot; 的 div</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">instance</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">getPublicRootInstance</span><span style="color:#666666;">(</span><span style="color:#BD976A;">fiberRoot</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 调用 callback 函数并改变函数内部 this 指向</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">originalCallback</span><span style="color:#666666;">.</span><span style="color:#80A665;">call</span><span style="color:#666666;">(</span><span style="color:#BD976A;">instance</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始化渲染不执行批量更新</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 因为批量更新是异步的是可以被打断的, 但是初始化渲染应该尽快完成不能被打断</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 所以不执行批量更新</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">unbatchedUpdates</span><span style="color:#666666;">(()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">updateContainer</span><span style="color:#666666;">(</span><span style="color:#BD976A;">children</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fiberRoot</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentComponent</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">callback</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 非初始化渲染 即更新</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">fiberRoot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">_internalRoot</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">callback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">function</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">originalCallback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">callback</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">callback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">instance</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">getPublicRootInstance</span><span style="color:#666666;">(</span><span style="color:#BD976A;">fiberRoot</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">originalCallback</span><span style="color:#666666;">.</span><span style="color:#80A665;">call</span><span style="color:#666666;">(</span><span style="color:#BD976A;">instance</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// Update</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">updateContainer</span><span style="color:#666666;">(</span><span style="color:#BD976A;">children</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fiberRoot</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentComponent</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">callback</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 返回 render 方法第一个参数的真实 DOM 对象作为 render 方法的返回值</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 就是说渲染谁 返回谁的真实 DOM 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">getPublicRootInstance</span><span style="color:#666666;">(</span><span style="color:#BD976A;">fiberRoot</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 将子树渲染到容器中 (初始化 Fiber 数据结构: 创建 fiberRoot 及 rootFiber)</span></span>
<span class="line"><span style="color:#A0ADA0;"> * parentComponent: 父组件, 初始渲染传入了 null</span></span>
<span class="line"><span style="color:#A0ADA0;"> * children: render 方法中的第一个参数, 要渲染的 ReactElement</span></span>
<span class="line"><span style="color:#A0ADA0;"> * container: 渲染容器</span></span>
<span class="line"><span style="color:#A0ADA0;"> * forceHydrate: true 为服务端渲染, false 为客户端渲染</span></span>
<span class="line"><span style="color:#A0ADA0;"> * callback: 组件渲染完成后需要执行的回调函数</span></span>
<span class="line"><span style="color:#A0ADA0;"> **/</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">legacyRenderSubtreeIntoContainer</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">parentComponent</span><span style="color:#999999;">: </span><span style="color:#AB5959;">?</span><span style="color:#2E808F;">React$Component</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">any</span><span style="color:#999999;">, </span><span style="color:#2E808F;">any</span><span style="color:#999999;">&gt;,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">children</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ReactNodeList</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">container</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Container</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">forceHydrate</span><span style="color:#999999;">: </span><span style="color:#2E808F;">boolean</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">callback</span><span style="color:#999999;">: </span><span style="color:#AB5959;">?</span><span style="color:#2E808F;">Function</span></span>
<span class="line"><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 检测 container 是否已经是初始化过的渲染容器</span></span>
<span class="line"><span style="color:#A0ADA0;">     * react 在初始渲染时会为最外层容器添加 _reactRootContainer 属性</span></span>
<span class="line"><span style="color:#A0ADA0;">     * react 会根据此属性进行不同的渲染方式</span></span>
<span class="line"><span style="color:#A0ADA0;">     * root 不存在 表示初始渲染</span></span>
<span class="line"><span style="color:#A0ADA0;">     * root 存在 表示更新</span></span>
<span class="line"><span style="color:#A0ADA0;">     */</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取 container 容器对象下是否有 _reactRootContainer 属性</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#999999;">: </span><span style="color:#2E808F;">RootType</span><span style="color:#999999;"> =</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#B07D48;">_reactRootContainer</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">any</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 即将存储根 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fiberRoot</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">root</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始渲染</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始化根 Fiber 数据结构</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 为 container 容器添加 _reactRootContainer 属性</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 在 _reactRootContainer 对象中有一个属性叫做 _internalRoot</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// _internalRoot 属性值即为 FiberRoot 表示根节点 Fiber 数据结构</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// legacyCreateRootFromDOMContainer</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// createLegacyRoot</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// new ReactDOMBlockingRoot -&gt; this._internalRoot</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// createRootImpl</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">root</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#B07D48;">_reactRootContainer</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">legacyCreateRootFromDOMContainer</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">container</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">forceHydrate</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 获取 Fiber Root 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">fiberRoot</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">_internalRoot</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 改变 callback 函数中的 this 指向</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 使其指向 render 方法第一个参数的真实 DOM 对象</span></span>
<span class="line"><span style="color:#A0ADA0;">         */</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果 callback 参数是函数类型</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">callback</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">function</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 使用 originalCallback 存储 callback 函数</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">originalCallback</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">callback</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 为 callback 参数重新赋值</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">callback</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 获取 render 方法第一个参数的真实 DOM 对象</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 实际上就是 id=&quot;root&quot; 的 div 的子元素</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// rootFiber.child.stateNode</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// rootFiber 就是 id=&quot;root&quot; 的 div</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">instance</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">getPublicRootInstance</span><span style="color:#999999;">(</span><span style="color:#B07D48;">fiberRoot</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 调用 callback 函数并改变函数内部 this 指向</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">originalCallback</span><span style="color:#999999;">.</span><span style="color:#59873A;">call</span><span style="color:#999999;">(</span><span style="color:#B07D48;">instance</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始化渲染不执行批量更新</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 因为批量更新是异步的是可以被打断的, 但是初始化渲染应该尽快完成不能被打断</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 所以不执行批量更新</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">unbatchedUpdates</span><span style="color:#999999;">(()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">updateContainer</span><span style="color:#999999;">(</span><span style="color:#B07D48;">children</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fiberRoot</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentComponent</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">callback</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 非初始化渲染 即更新</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">fiberRoot</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">_internalRoot</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">callback</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">function</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">originalCallback</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">callback</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">callback</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">instance</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">getPublicRootInstance</span><span style="color:#999999;">(</span><span style="color:#B07D48;">fiberRoot</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">originalCallback</span><span style="color:#999999;">.</span><span style="color:#59873A;">call</span><span style="color:#999999;">(</span><span style="color:#B07D48;">instance</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// Update</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">updateContainer</span><span style="color:#999999;">(</span><span style="color:#B07D48;">children</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fiberRoot</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentComponent</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">callback</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 返回 render 方法第一个参数的真实 DOM 对象作为 render 方法的返回值</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 就是说渲染谁 返回谁的真实 DOM 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">getPublicRootInstance</span><span style="color:#999999;">(</span><span style="color:#B07D48;">fiberRoot</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><p><img src="/assets/image18.cce292c6.png" alt="3.png"></p><h5 id="_5-1-3-2-legacycreaterootfromdomcontainer" tabindex="-1">5.1.3.2 legacyCreateRootFromDOMContainer <a class="header-anchor" href="#_5-1-3-2-legacycreaterootfromdomcontainer" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-dom/src/client/ReactDOMLegacy.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 判断是否为服务器端渲染 如果不是服务器端渲染</span></span>
<span class="line"><span style="color:#758575DD;"> * 清空 container 容器中的节点</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">legacyCreateRootFromDOMContainer</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">container</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Container</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">forceHydrate</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">boolean</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">RootType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 检测是否为服务器端渲染</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">shouldHydrate</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">forceHydrate</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">shouldHydrateDueToLegacyHeuristic</span><span style="color:#666666;">(</span><span style="color:#BD976A;">container</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果不是服务器端渲染</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">shouldHydrate</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">rootSibling</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 开启循环 删除 container 容器中的节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">((</span><span style="color:#BD976A;">rootSibling</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastChild</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 删除 container 容器中的节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#80A665;">removeChild</span><span style="color:#666666;">(</span><span style="color:#BD976A;">rootSibling</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">             * 为什么要清除 container 中的元素 ?</span></span>
<span class="line"><span style="color:#758575DD;">             * 为提供首屏加载的用户体验, 有时需要在 container 中放置一些占位图或者 loading 图</span></span>
<span class="line"><span style="color:#758575DD;">             * 就无可避免的要向 container 中加入 html 标记.</span></span>
<span class="line"><span style="color:#758575DD;">             * 在将 ReactElement 渲染到 container 之前, 必然要先清空 container</span></span>
<span class="line"><span style="color:#758575DD;">             * 因为占位图和 ReactElement 不能同时显示</span></span>
<span class="line"><span style="color:#758575DD;">             *</span></span>
<span class="line"><span style="color:#758575DD;">             * 在加入占位代码时, 最好只有一个父级元素, 可以减少内部代码的循环次数以提高性能</span></span>
<span class="line"><span style="color:#758575DD;">             * &lt;div&gt;</span></span>
<span class="line"><span style="color:#758575DD;">             *  &lt;p&gt;placement&lt;p&gt;</span></span>
<span class="line"><span style="color:#758575DD;">             *  &lt;p&gt;placement&lt;p&gt;</span></span>
<span class="line"><span style="color:#758575DD;">             *  &lt;p&gt;placement&lt;p&gt;</span></span>
<span class="line"><span style="color:#758575DD;">             * &lt;/div&gt;</span></span>
<span class="line"><span style="color:#758575DD;">             */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createLegacyRoot</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">container</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">shouldHydrate</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                  </span><span style="color:#B8A965;">hydrate</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">              </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 判断是否为服务器端渲染 如果不是服务器端渲染</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 清空 container 容器中的节点</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">legacyCreateRootFromDOMContainer</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">container</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Container</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">forceHydrate</span><span style="color:#999999;">: </span><span style="color:#2E808F;">boolean</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">RootType</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 检测是否为服务器端渲染</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">shouldHydrate</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">forceHydrate</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span><span style="color:#393A34;"> </span><span style="color:#59873A;">shouldHydrateDueToLegacyHeuristic</span><span style="color:#999999;">(</span><span style="color:#B07D48;">container</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果不是服务器端渲染</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">shouldHydrate</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">rootSibling</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 开启循环 删除 container 容器中的节点</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">((</span><span style="color:#B07D48;">rootSibling</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastChild</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 删除 container 容器中的节点</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#59873A;">removeChild</span><span style="color:#999999;">(</span><span style="color:#B07D48;">rootSibling</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">             * 为什么要清除 container 中的元素 ?</span></span>
<span class="line"><span style="color:#A0ADA0;">             * 为提供首屏加载的用户体验, 有时需要在 container 中放置一些占位图或者 loading 图</span></span>
<span class="line"><span style="color:#A0ADA0;">             * 就无可避免的要向 container 中加入 html 标记.</span></span>
<span class="line"><span style="color:#A0ADA0;">             * 在将 ReactElement 渲染到 container 之前, 必然要先清空 container</span></span>
<span class="line"><span style="color:#A0ADA0;">             * 因为占位图和 ReactElement 不能同时显示</span></span>
<span class="line"><span style="color:#A0ADA0;">             *</span></span>
<span class="line"><span style="color:#A0ADA0;">             * 在加入占位代码时, 最好只有一个父级元素, 可以减少内部代码的循环次数以提高性能</span></span>
<span class="line"><span style="color:#A0ADA0;">             * &lt;div&gt;</span></span>
<span class="line"><span style="color:#A0ADA0;">             *  &lt;p&gt;placement&lt;p&gt;</span></span>
<span class="line"><span style="color:#A0ADA0;">             *  &lt;p&gt;placement&lt;p&gt;</span></span>
<span class="line"><span style="color:#A0ADA0;">             *  &lt;p&gt;placement&lt;p&gt;</span></span>
<span class="line"><span style="color:#A0ADA0;">             * &lt;/div&gt;</span></span>
<span class="line"><span style="color:#A0ADA0;">             */</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createLegacyRoot</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">container</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">shouldHydrate</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                  </span><span style="color:#998418;">hydrate</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-3-3-createlegacyroot" tabindex="-1">5.1.3.3 createLegacyRoot <a class="header-anchor" href="#_5-1-3-3-createlegacyroot" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-dom/src/client/ReactDOMRoot.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 通过实例化 ReactDOMBlockingRoot 类创建 LegacyRoot</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createLegacyRoot</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">container</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Container</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">options</span><span style="color:#CB7676;">?</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">RootOptions</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">RootType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// LegacyRoot 常量, 值为 0,</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 通过 render 方法创建的 container 就是 LegacyRoot</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">ReactDOMBlockingRoot</span><span style="color:#666666;">(</span><span style="color:#BD976A;">container</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">LegacyRoot</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">options</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 通过实例化 ReactDOMBlockingRoot 类创建 LegacyRoot</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createLegacyRoot</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">container</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Container</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">options</span><span style="color:#AB5959;">?</span><span style="color:#999999;">: </span><span style="color:#2E808F;">RootOptions</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">RootType</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// LegacyRoot 常量, 值为 0,</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 通过 render 方法创建的 container 就是 LegacyRoot</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">ReactDOMBlockingRoot</span><span style="color:#999999;">(</span><span style="color:#B07D48;">container</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">LegacyRoot</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">options</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-3-3-reactdomblockingroot" tabindex="-1">5.1.3.3 ReactDOMBlockingRoot <a class="header-anchor" href="#_5-1-3-3-reactdomblockingroot" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-dom/src/client/ReactDOMRoot.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 类, 通过它可以创建 LegacyRoot 的 Fiber 数据结构</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">ReactDOMBlockingRoot</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">container</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Container</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">RootTag</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">options</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">void</span><span style="color:#666666;"> | </span><span style="color:#5DA9A7;">RootOptions</span></span>
<span class="line"><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// tag =&gt; 0 =&gt; legacyRoot</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// container._reactRootContainer = {_internalRoot: {}}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">_internalRoot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createRootImpl</span><span style="color:#666666;">(</span><span style="color:#BD976A;">container</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">options</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 类, 通过它可以创建 LegacyRoot 的 Fiber 数据结构</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">ReactDOMBlockingRoot</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">container</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Container</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">: </span><span style="color:#2E808F;">RootTag</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">options</span><span style="color:#999999;">: </span><span style="color:#2E808F;">void</span><span style="color:#999999;"> | </span><span style="color:#2E808F;">RootOptions</span></span>
<span class="line"><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// tag =&gt; 0 =&gt; legacyRoot</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// container._reactRootContainer = {_internalRoot: {}}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">_internalRoot</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createRootImpl</span><span style="color:#999999;">(</span><span style="color:#B07D48;">container</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">options</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-3-4-createrootimpl" tabindex="-1">5.1.3.4 createRootImpl <a class="header-anchor" href="#_5-1-3-4-createrootimpl" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-dom/src/client/ReactDOMRoot.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createRootImpl</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">container</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Container</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">RootTag</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">options</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">void</span><span style="color:#666666;"> | </span><span style="color:#5DA9A7;">RootOptions</span></span>
<span class="line"><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// tag =&gt; 0</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// options =&gt; undefined</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createContainer</span><span style="color:#666666;">(</span><span style="color:#BD976A;">container</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">hydrate</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">hydrationCallbacks</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">markContainerAsRoot</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">container</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createRootImpl</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">container</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Container</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">: </span><span style="color:#2E808F;">RootTag</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">options</span><span style="color:#999999;">: </span><span style="color:#2E808F;">void</span><span style="color:#999999;"> | </span><span style="color:#2E808F;">RootOptions</span></span>
<span class="line"><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// tag =&gt; 0</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// options =&gt; undefined</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createContainer</span><span style="color:#999999;">(</span><span style="color:#B07D48;">container</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">hydrate</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">hydrationCallbacks</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">markContainerAsRoot</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">container</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-3-5-createcontainer" tabindex="-1">5.1.3.5 createContainer <a class="header-anchor" href="#_5-1-3-5-createcontainer" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberReconciler.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 创建 container</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createContainer</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">containerInfo</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Container</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">RootTag</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">hydrate</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">boolean</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">hydrationCallbacks</span><span style="color:#666666;">: </span><span style="color:#CB7676;">null</span><span style="color:#666666;"> | </span><span style="color:#5DA9A7;">SuspenseHydrationCallbacks</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">OpaqueRoot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// containerInfo =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// tag: 0</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// hydrate: false</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// hydrationCallbacks: null</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 忽略了和服务器端渲染相关的内容</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createFiberRoot</span><span style="color:#666666;">(</span><span style="color:#BD976A;">containerInfo</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">hydrate</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">hydrationCallbacks</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 创建 container</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createContainer</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">containerInfo</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Container</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">: </span><span style="color:#2E808F;">RootTag</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">hydrate</span><span style="color:#999999;">: </span><span style="color:#2E808F;">boolean</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">hydrationCallbacks</span><span style="color:#999999;">: </span><span style="color:#AB5959;">null</span><span style="color:#999999;"> | </span><span style="color:#2E808F;">SuspenseHydrationCallbacks</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">OpaqueRoot</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// containerInfo =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// tag: 0</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// hydrate: false</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// hydrationCallbacks: null</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 忽略了和服务器端渲染相关的内容</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createFiberRoot</span><span style="color:#999999;">(</span><span style="color:#B07D48;">containerInfo</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">hydrate</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">hydrationCallbacks</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-3-6-createfiberroot" tabindex="-1">5.1.3.6 createFiberRoot <a class="header-anchor" href="#_5-1-3-6-createfiberroot" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberRoot.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 创建根节点对应的 fiber 对象</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createFiberRoot</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">containerInfo</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">RootTag</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">hydrate</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">boolean</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">hydrationCallbacks</span><span style="color:#666666;">: </span><span style="color:#CB7676;">null</span><span style="color:#666666;"> | </span><span style="color:#5DA9A7;">SuspenseHydrationCallbacks</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">FiberRoot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 创建 FiberRoot</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">FiberRoot</span><span style="color:#666666;"> =</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">FiberRootNode</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">containerInfo</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">hydrate</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">any</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 创建根节点对应的 rootFiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">uninitializedFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createHostRootFiber</span><span style="color:#666666;">(</span><span style="color:#BD976A;">tag</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 为 fiberRoot 添加 current 属性 值为 rootFiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">uninitializedFiber</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 为 rootFiber 添加 stateNode 属性 值为 fiberRoot</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">uninitializedFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 为 fiber 对象添加 updateQueue 属性, 初始化 updateQueue 对象</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// updateQueue 用于存放 Update 对象</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// Update 对象用于记录组件状态的改变</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">initializeUpdateQueue</span><span style="color:#666666;">(</span><span style="color:#BD976A;">uninitializedFiber</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 返回 root</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 创建根节点对应的 fiber 对象</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createFiberRoot</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">containerInfo</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">: </span><span style="color:#2E808F;">RootTag</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">hydrate</span><span style="color:#999999;">: </span><span style="color:#2E808F;">boolean</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">hydrationCallbacks</span><span style="color:#999999;">: </span><span style="color:#AB5959;">null</span><span style="color:#999999;"> | </span><span style="color:#2E808F;">SuspenseHydrationCallbacks</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">FiberRoot</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 创建 FiberRoot</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#999999;">: </span><span style="color:#2E808F;">FiberRoot</span><span style="color:#999999;"> =</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">FiberRootNode</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">containerInfo</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">hydrate</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">)</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">any</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 创建根节点对应的 rootFiber</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">uninitializedFiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createHostRootFiber</span><span style="color:#999999;">(</span><span style="color:#B07D48;">tag</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 为 fiberRoot 添加 current 属性 值为 rootFiber</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">uninitializedFiber</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 为 rootFiber 添加 stateNode 属性 值为 fiberRoot</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">uninitializedFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 为 fiber 对象添加 updateQueue 属性, 初始化 updateQueue 对象</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// updateQueue 用于存放 Update 对象</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// Update 对象用于记录组件状态的改变</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">initializeUpdateQueue</span><span style="color:#999999;">(</span><span style="color:#B07D48;">uninitializedFiber</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 返回 root</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-3-7-fiberrootnode" tabindex="-1">5.1.3.7 FiberRootNode <a class="header-anchor" href="#_5-1-3-7-fiberrootnode" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberRoot.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">FiberRootNode</span><span style="color:#666666;">(</span><span style="color:#BD976A;">containerInfo</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">hydrate</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">containerInfo</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">containerInfo</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pendingChildren</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pingCache</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">finishedExpirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoWork</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">finishedWork</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">timeoutHandle</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">noTimeout</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">context</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pendingContext</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hydrate</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">hydrate</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callbackNode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callbackPriority</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoPriority</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">firstPendingTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoWork</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">firstSuspendedTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoWork</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastSuspendedTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoWork</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nextKnownPendingLevel</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoWork</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastPingedTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoWork</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastExpiredTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoWork</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">enableSchedulerTracing</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">interactionThreadID</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">unstable_getThreadID</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedInteractions</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">Set</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pendingInteractionMap</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">Map</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">enableSuspenseCallback</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hydrationCallbacks</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">FiberRootNode</span><span style="color:#999999;">(</span><span style="color:#B07D48;">containerInfo</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">hydrate</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">containerInfo</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">containerInfo</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pendingChildren</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pingCache</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">finishedExpirationTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoWork</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">finishedWork</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">timeoutHandle</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">noTimeout</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">context</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pendingContext</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hydrate</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">hydrate</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callbackNode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callbackPriority</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoPriority</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">firstPendingTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoWork</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">firstSuspendedTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoWork</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastSuspendedTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoWork</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nextKnownPendingLevel</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoWork</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastPingedTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoWork</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastExpiredTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoWork</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">enableSchedulerTracing</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">interactionThreadID</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">unstable_getThreadID</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedInteractions</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">Set</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pendingInteractionMap</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">Map</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">enableSuspenseCallback</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hydrationCallbacks</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-3-1-8-initializeupdatequeue" tabindex="-1">5.3.1.8 initializeUpdateQueue <a class="header-anchor" href="#_5-3-1-8-initializeupdatequeue" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberRoot.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">initializeUpdateQueue</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">State</span><span style="color:#666666;">&gt;(</span><span style="color:#BD976A;">fiber</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">void</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">queue</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">UpdateQueue</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">State</span><span style="color:#666666;">&gt; =</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">baseState</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedState</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">baseQueue</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">shared</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#B8A965;">pending</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">},</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#B8A965;">effects</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">fiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">updateQueue</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">queue</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">initializeUpdateQueue</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">State</span><span style="color:#999999;">&gt;(</span><span style="color:#B07D48;">fiber</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">void</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">queue</span><span style="color:#999999;">: </span><span style="color:#2E808F;">UpdateQueue</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">State</span><span style="color:#999999;">&gt; =</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">baseState</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedState</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">baseQueue</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">shared</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#998418;">pending</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">},</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#998418;">effects</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">fiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">updateQueue</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">queue</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-1-4-获取-rootfiber-child-实例对象" tabindex="-1">5.1.4 获取 rootFiber.child 实例对象 <a class="header-anchor" href="#_5-1-4-获取-rootfiber-child-实例对象" aria-hidden="true">#</a></h4><h5 id="_5-1-4-1-getpublicrootinstance" tabindex="-1">5.1.4.1 getPublicRootInstance <a class="header-anchor" href="#_5-1-4-1-getpublicrootinstance" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberReconciler.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 获取 container 的第一个子元素的实例对象</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">getPublicRootInstance</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// FiberRoot</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">container</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">OpaqueRoot</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">React$Component</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">PublicInstance</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取 rootFiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">containerFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#BD976A;">current</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果 rootFiber 没有子元素</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 指的就是 id=&quot;root&quot; 的 div 没有子元素</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">containerFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 返回 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 匹配子元素的类型</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">switch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">containerFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 普通</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostComponent</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">getPublicInstance</span><span style="color:#666666;">(</span><span style="color:#BD976A;">containerFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">default</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 返回子元素的真实 DOM 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">containerFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 获取 container 的第一个子元素的实例对象</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">getPublicRootInstance</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// FiberRoot</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">container</span><span style="color:#999999;">: </span><span style="color:#2E808F;">OpaqueRoot</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">React$Component</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">any</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">any</span><span style="color:#999999;">&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">PublicInstance</span><span style="color:#393A34;"> </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取 rootFiber</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">containerFiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#B07D48;">current</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果 rootFiber 没有子元素</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 指的就是 id=&quot;root&quot; 的 div 没有子元素</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">containerFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 返回 null</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 匹配子元素的类型</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">switch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">containerFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 普通</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostComponent</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">getPublicInstance</span><span style="color:#999999;">(</span><span style="color:#B07D48;">containerFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">default</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 返回子元素的真实 DOM 对象</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">containerFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-4-2-getpublicinstance" tabindex="-1">5.1.4.2 getPublicInstance <a class="header-anchor" href="#_5-1-4-2-getpublicinstance" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">getPublicInstance</span><span style="color:#666666;">(</span><span style="color:#BD976A;">instance</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Instance</span><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> * </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">instance</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">getPublicInstance</span><span style="color:#999999;">(</span><span style="color:#B07D48;">instance</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Instance</span><span style="color:#999999;">):</span><span style="color:#393A34;"> * </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">instance</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-1-5-updatecontainer" tabindex="-1">5.1.5 updateContainer <a class="header-anchor" href="#_5-1-5-updatecontainer" aria-hidden="true">#</a></h4><p><code>文件位置: packages/react-reconciler/src/ReactFiberReconciler.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 计算任务的过期时间</span></span>
<span class="line"><span style="color:#758575DD;"> * 再根据任务过期时间创建 Update 任务</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">updateContainer</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// element 要渲染的 ReactElement</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">element</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ReactNodeList</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// container Fiber Root 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">container</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">OpaqueRoot</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// parentComponent 父组件 初始渲染为 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">parentComponent</span><span style="color:#666666;">: </span><span style="color:#CB7676;">?</span><span style="color:#5DA9A7;">React$Component</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">, </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">&gt;,</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// ReactElement 渲染完成执行的回调函数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">callback</span><span style="color:#666666;">: </span><span style="color:#CB7676;">?</span><span style="color:#5DA9A7;">Function</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">ExpirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// container 获取 rootFiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#BD976A;">current</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取当前距离 react 应用初始化的时间 1073741805</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">currentTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">requestCurrentTimeForUpdate</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 异步加载设置</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">suspenseConfig</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">requestCurrentSuspenseConfig</span><span style="color:#666666;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 计算过期时间</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 为防止任务因为优先级的原因一直被打断而未能执行</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// react 会设置一个过期时间, 当时间到了过期时间的时候</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果任务还未执行的话, react 将会强制执行该任务</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 初始化渲染时, 任务同步执行不涉及被打断的问题 1073741823</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">expirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">computeExpirationForFiber</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">currentTime</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">suspenseConfig</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 设置FiberRoot.context, 首次执行返回一个emptyContext, 是一个 {}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">context</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">getContextForSubtree</span><span style="color:#666666;">(</span><span style="color:#BD976A;">parentComponent</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 初始渲染时 Fiber Root 对象中的 context 属性值为 null</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 所以会进入到 if 中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#BD976A;">context</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始渲染时将 context 属性值设置为 {}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#BD976A;">context</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">context</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pendingContext</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">context</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 创建一个待执行任务</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">update</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createUpdate</span><span style="color:#666666;">(</span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">suspenseConfig</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 将要更新的内容挂载到更新对象中的 payload 中</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 将要更新的组件存储在 payload 对象中, 方便后期获取</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">update</span><span style="color:#666666;">.</span><span style="color:#BD976A;">payload</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">element</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 判断 callback 是否存在</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">callback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">callback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">undefined</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">callback</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果 callback 存在</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">callback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 将 callback 挂载到 update 对象中</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 其实就是一层层传递 方便 ReactElement 元素渲染完成调用</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 回调函数执行完成后会被清除 可以在代码的后面加上 return 进行验证</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">update</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">callback</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 将 update 对象加入到当前 Fiber 的更新队列当中 (updateQueue)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">enqueueUpdate</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">update</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 调度和更新 current 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">scheduleWork</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 返回过期时间</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 计算任务的过期时间</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 再根据任务过期时间创建 Update 任务</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">updateContainer</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// element 要渲染的 ReactElement</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">element</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ReactNodeList</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// container Fiber Root 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">container</span><span style="color:#999999;">: </span><span style="color:#2E808F;">OpaqueRoot</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// parentComponent 父组件 初始渲染为 null</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">parentComponent</span><span style="color:#999999;">: </span><span style="color:#AB5959;">?</span><span style="color:#2E808F;">React$Component</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">any</span><span style="color:#999999;">, </span><span style="color:#2E808F;">any</span><span style="color:#999999;">&gt;,</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// ReactElement 渲染完成执行的回调函数</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">callback</span><span style="color:#999999;">: </span><span style="color:#AB5959;">?</span><span style="color:#2E808F;">Function</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">ExpirationTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// container 获取 rootFiber</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#B07D48;">current</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取当前距离 react 应用初始化的时间 1073741805</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">currentTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">requestCurrentTimeForUpdate</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 异步加载设置</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">suspenseConfig</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">requestCurrentSuspenseConfig</span><span style="color:#999999;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 计算过期时间</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 为防止任务因为优先级的原因一直被打断而未能执行</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// react 会设置一个过期时间, 当时间到了过期时间的时候</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果任务还未执行的话, react 将会强制执行该任务</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 初始化渲染时, 任务同步执行不涉及被打断的问题 1073741823</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">expirationTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">computeExpirationForFiber</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">currentTime</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">suspenseConfig</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 设置FiberRoot.context, 首次执行返回一个emptyContext, 是一个 {}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">context</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">getContextForSubtree</span><span style="color:#999999;">(</span><span style="color:#B07D48;">parentComponent</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 初始渲染时 Fiber Root 对象中的 context 属性值为 null</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 所以会进入到 if 中</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#B07D48;">context</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始渲染时将 context 属性值设置为 {}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#B07D48;">context</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">context</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pendingContext</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">context</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 创建一个待执行任务</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">update</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createUpdate</span><span style="color:#999999;">(</span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">suspenseConfig</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 将要更新的内容挂载到更新对象中的 payload 中</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 将要更新的组件存储在 payload 对象中, 方便后期获取</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">update</span><span style="color:#999999;">.</span><span style="color:#B07D48;">payload</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">element</span><span style="color:#393A34;"> </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 判断 callback 是否存在</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">callback</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">callback</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">undefined</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">callback</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果 callback 存在</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">callback</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 将 callback 挂载到 update 对象中</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 其实就是一层层传递 方便 ReactElement 元素渲染完成调用</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 回调函数执行完成后会被清除 可以在代码的后面加上 return 进行验证</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">update</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callback</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">callback</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 将 update 对象加入到当前 Fiber 的更新队列当中 (updateQueue)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">enqueueUpdate</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">update</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 调度和更新 current 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">scheduleWork</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 返回过期时间</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-1-6-enqueueupdate" tabindex="-1">5.1.6 enqueueUpdate <a class="header-anchor" href="#_5-1-6-enqueueupdate" aria-hidden="true">#</a></h4><p><code>文件位置: packages/react-reconciler/src/ReactUpdateQueue.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 将任务(Update)存放于任务队列(updateQueue)中</span></span>
<span class="line"><span style="color:#758575DD;">// 创建单向链表结构存放 update, next 用来串联 update</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">enqueueUpdate</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">State</span><span style="color:#666666;">&gt;(</span><span style="color:#BD976A;">fiber</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">update</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Update</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">State</span><span style="color:#666666;">&gt;)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取当前 Fiber 的 更新队列</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">updateQueue</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">updateQueue</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果更新队列不存在 就返回 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">updateQueue</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 仅发生在 fiber 已经被卸载</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取待执行的 Update 任务</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 初始渲染时没有待执行的任务</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sharedQueue</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">updateQueue</span><span style="color:#666666;">.</span><span style="color:#BD976A;">shared</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">pending</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sharedQueue</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pending</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果没有待执行的 Update 任务</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">pending</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 这是第一次更新, 创建一个循环列表.</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">update</span><span style="color:#666666;">.</span><span style="color:#BD976A;">next</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">update</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">update</span><span style="color:#666666;">.</span><span style="color:#BD976A;">next</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">pending</span><span style="color:#666666;">.</span><span style="color:#BD976A;">next</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">pending</span><span style="color:#666666;">.</span><span style="color:#BD976A;">next</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">update</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 将 Update 任务存储在 pending 属性中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">sharedQueue</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pending</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">update</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 将任务(Update)存放于任务队列(updateQueue)中</span></span>
<span class="line"><span style="color:#A0ADA0;">// 创建单向链表结构存放 update, next 用来串联 update</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">enqueueUpdate</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">State</span><span style="color:#999999;">&gt;(</span><span style="color:#B07D48;">fiber</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">update</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Update</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">State</span><span style="color:#999999;">&gt;)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取当前 Fiber 的 更新队列</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">updateQueue</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">updateQueue</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果更新队列不存在 就返回 null</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">updateQueue</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 仅发生在 fiber 已经被卸载</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取待执行的 Update 任务</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 初始渲染时没有待执行的任务</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sharedQueue</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">updateQueue</span><span style="color:#999999;">.</span><span style="color:#B07D48;">shared</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">pending</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sharedQueue</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pending</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果没有待执行的 Update 任务</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">pending</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 这是第一次更新, 创建一个循环列表.</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">update</span><span style="color:#999999;">.</span><span style="color:#B07D48;">next</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">update</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">update</span><span style="color:#999999;">.</span><span style="color:#B07D48;">next</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">pending</span><span style="color:#999999;">.</span><span style="color:#B07D48;">next</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">pending</span><span style="color:#999999;">.</span><span style="color:#B07D48;">next</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">update</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 将 Update 任务存储在 pending 属性中</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">sharedQueue</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pending</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">update</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-1-7-scheduleupdateonfiber" tabindex="-1">5.1.7 scheduleUpdateOnFiber <a class="header-anchor" href="#_5-1-7-scheduleupdateonfiber" aria-hidden="true">#</a></h4><p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 判断任务是否为同步 调用同步任务入口</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">scheduleUpdateOnFiber</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// rootFiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">fiber</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExpirationTime</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">   * fiber: 初始化渲染时为 rootFiber, 即 &lt;div id=&quot;root&quot;&gt;&lt;/div&gt; 对应的 Fiber 对象</span></span>
<span class="line"><span style="color:#758575DD;">   * expirationTime: 任务过期时间 =&gt;1073741823</span></span>
<span class="line"><span style="color:#758575DD;">   */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">   * 判断是否是无限循环的 update 如果是就报错</span></span>
<span class="line"><span style="color:#758575DD;">   * 在 componentWillUpdate 或者 componentDidUpdate 生命周期函数中重复调用</span></span>
<span class="line"><span style="color:#758575DD;">   * setState 方法时, 可能会发生这种情况, React 限制了嵌套更新的数量以防止无限循环</span></span>
<span class="line"><span style="color:#758575DD;">   * 限制的嵌套更新数量为 50, 可通过 NESTED_UPDATE_LIMIT 全局变量获取</span></span>
<span class="line"><span style="color:#758575DD;">   */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">checkForNestedUpdates</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 判断任务是否是同步任务 Sync的值为: 1073741823</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">expirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Sync</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 检查是否处于非批量更新模式</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">(</span><span style="color:#BD976A;">executionContext</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">LegacyUnbatchedContext</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoContext</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 检查是否没有处于正在进行渲染的任务</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">(</span><span style="color:#BD976A;">executionContext</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">RenderContext</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">CommitContext</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoContext</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 同步任务入口点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">performSyncWorkOnRoot</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 忽略了一些初始化渲染不会得到执行的代码</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 判断任务是否为同步 调用同步任务入口</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">scheduleUpdateOnFiber</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// rootFiber</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">fiber</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExpirationTime</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">   * fiber: 初始化渲染时为 rootFiber, 即 &lt;div id=&quot;root&quot;&gt;&lt;/div&gt; 对应的 Fiber 对象</span></span>
<span class="line"><span style="color:#A0ADA0;">   * expirationTime: 任务过期时间 =&gt;1073741823</span></span>
<span class="line"><span style="color:#A0ADA0;">   */</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">   * 判断是否是无限循环的 update 如果是就报错</span></span>
<span class="line"><span style="color:#A0ADA0;">   * 在 componentWillUpdate 或者 componentDidUpdate 生命周期函数中重复调用</span></span>
<span class="line"><span style="color:#A0ADA0;">   * setState 方法时, 可能会发生这种情况, React 限制了嵌套更新的数量以防止无限循环</span></span>
<span class="line"><span style="color:#A0ADA0;">   * 限制的嵌套更新数量为 50, 可通过 NESTED_UPDATE_LIMIT 全局变量获取</span></span>
<span class="line"><span style="color:#A0ADA0;">   */</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">checkForNestedUpdates</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 判断任务是否是同步任务 Sync的值为: 1073741823</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">expirationTime</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Sync</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 检查是否处于非批量更新模式</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">(</span><span style="color:#B07D48;">executionContext</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">LegacyUnbatchedContext</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoContext</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 检查是否没有处于正在进行渲染的任务</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">(</span><span style="color:#B07D48;">executionContext</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">RenderContext</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">CommitContext</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoContext</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 同步任务入口点</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">performSyncWorkOnRoot</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 忽略了一些初始化渲染不会得到执行的代码</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-1-8-构建-fiber-对象" tabindex="-1">5.1.8 构建 Fiber 对象 <a class="header-anchor" href="#_5-1-8-构建-fiber-对象" aria-hidden="true">#</a></h4><h5 id="_5-1-8-1-performsyncworkonroot" tabindex="-1">5.1.8.1 performSyncWorkOnRoot <a class="header-anchor" href="#_5-1-8-1-performsyncworkonroot" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 进入 render 阶段, 构建 workInProgress Fiber 树</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">performSyncWorkOnRoot</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 参数 root 为 fiberRoot 对象</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 检查是否有过期的任务</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果没有过期的任务 值为 0</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 初始化渲染没有过期的任务待执行</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">lastExpiredTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastExpiredTime</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// NoWork 值为 0</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果有过期的任务 将过期时间设置为 lastExpiredTime 否则将过期时间设置为 Sync</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 初始渲染过期时间被设置成了 Sync</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">expirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">lastExpiredTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoWork</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">lastExpiredTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Sync</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果 root 和 workInProgressRoot 不相等</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 说明 workInProgressRoot 不存在, 说明还没有构建 workInProgress Fiber 树</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// workInProgressRoot 为全局变量 默认值为 null, 初始渲染时值为 null</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// expirationTime =&gt; 1073741823</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// renderExpirationTime =&gt; 0</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// true</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">root</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgressRoot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">expirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">renderExpirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 构建 workInProgressFiber 树及rootFiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">prepareFreshStack</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// workInProgress 如果不为 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">do</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">try</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 以同步的方式开始构建 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">workLoopSync</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 跳出 while 循环</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">break</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">catch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">thrownValue</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">handleError</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">thrownValue</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#4D9375;">true</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 这是一个同步渲染, 所以我们应该完成整棵树.</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 无法提交不完整的 root, 此错误可能是由于React中的错误所致. 请提出问题.</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">invariant</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">false</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">Cannot commit an incomplete root. This error is likely caused by a </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">bug in React. Please file an issue.</span><span style="color:#C98A7DAA;">&#39;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 将构建好的新 Fiber 对象存储在 finishedWork 属性中</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 提交阶段使用</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">finishedWork</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">alternate</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">any</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">finishedExpirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 结束 render 阶段</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 进入 commit 阶段</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">finishSyncRender</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 进入 render 阶段, 构建 workInProgress Fiber 树</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">performSyncWorkOnRoot</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 参数 root 为 fiberRoot 对象</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 检查是否有过期的任务</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果没有过期的任务 值为 0</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 初始化渲染没有过期的任务待执行</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">lastExpiredTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastExpiredTime</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// NoWork 值为 0</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果有过期的任务 将过期时间设置为 lastExpiredTime 否则将过期时间设置为 Sync</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 初始渲染过期时间被设置成了 Sync</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">expirationTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">lastExpiredTime</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoWork</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">lastExpiredTime</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Sync</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果 root 和 workInProgressRoot 不相等</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 说明 workInProgressRoot 不存在, 说明还没有构建 workInProgress Fiber 树</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// workInProgressRoot 为全局变量 默认值为 null, 初始渲染时值为 null</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// expirationTime =&gt; 1073741823</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// renderExpirationTime =&gt; 0</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// true</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">root</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgressRoot</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">expirationTime</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">renderExpirationTime</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 构建 workInProgressFiber 树及rootFiber</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">prepareFreshStack</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// workInProgress 如果不为 null</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">do</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">try</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 以同步的方式开始构建 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">workLoopSync</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 跳出 while 循环</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">break</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">catch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">thrownValue</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">handleError</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">thrownValue</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#1E754F;">true</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 这是一个同步渲染, 所以我们应该完成整棵树.</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 无法提交不完整的 root, 此错误可能是由于React中的错误所致. 请提出问题.</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">invariant</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">false</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">Cannot commit an incomplete root. This error is likely caused by a </span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">bug in React. Please file an issue.</span><span style="color:#B56959AA;">&#39;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 将构建好的新 Fiber 对象存储在 finishedWork 属性中</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 提交阶段使用</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">finishedWork</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">alternate</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">any</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">finishedExpirationTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 结束 render 阶段</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 进入 commit 阶段</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">finishSyncRender</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-8-2-preparefreshstack" tabindex="-1">5.1.8.2 prepareFreshStack <a class="header-anchor" href="#_5-1-8-2-preparefreshstack" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 根据 currentFiber 树中的 rootFiber</span></span>
<span class="line"><span style="color:#758575DD;"> * 构建 workInProgressFiber 树中的 rootFiber</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">prepareFreshStack</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 为 FiberRoot 对象添加 finishedWork 属性</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// finishedWork 表示 render 阶段执行完成后构建的待提交的 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">finishedWork</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 初始化 finishedExpirationTime 值为 0</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">finishedExpirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoWork</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 建构 workInProgress Fiber 树的 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgressRoot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 构建 workInProgress Fiber 树中的 rootFiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createWorkInProgress</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">renderExpirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgressRootExitStatus</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">RootIncomplete</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 根据 currentFiber 树中的 rootFiber</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 构建 workInProgressFiber 树中的 rootFiber</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">prepareFreshStack</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 为 FiberRoot 对象添加 finishedWork 属性</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// finishedWork 表示 render 阶段执行完成后构建的待提交的 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">finishedWork</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 初始化 finishedExpirationTime 值为 0</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">finishedExpirationTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoWork</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 建构 workInProgress Fiber 树的 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgressRoot</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 构建 workInProgress Fiber 树中的 rootFiber</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createWorkInProgress</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">renderExpirationTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgressRootExitStatus</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">RootIncomplete</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-8-3-createworkinprogress" tabindex="-1">5.1.8.3 createWorkInProgress <a class="header-anchor" href="#_5-1-8-3-createworkinprogress" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiber.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 构建 workInProgress Fiber 树中的 rootFiber</span></span>
<span class="line"><span style="color:#758575DD;">// 构建完成后会替换 current fiber</span></span>
<span class="line"><span style="color:#758575DD;">// 初始渲染 pendingProps 为 null</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createWorkInProgress</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">pendingProps</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// current: current Fiber 中的 rootFiber</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取 current Fiber 中对应的 workInProgress Fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">alternate</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果 workInProgress 不存在</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 创建 fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createFiber</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">pendingProps</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">key</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">mode</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 属性复用</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">elementType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">elementType</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">type</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">type</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 使用 alternate 存储 current</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">alternate</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 使用 alternate 存储 workInProgress</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">alternate</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">childExpirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">childExpirationTime</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">expirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedProps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedProps</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedState</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedState</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">updateQueue</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">updateQueue</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">sibling</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">sibling</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">index</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">index</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">ref</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">ref</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 返回创建好的 workInProgress Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 构建 workInProgress Fiber 树中的 rootFiber</span></span>
<span class="line"><span style="color:#A0ADA0;">// 构建完成后会替换 current fiber</span></span>
<span class="line"><span style="color:#A0ADA0;">// 初始渲染 pendingProps 为 null</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createWorkInProgress</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">pendingProps</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Fiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// current: current Fiber 中的 rootFiber</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取 current Fiber 中对应的 workInProgress Fiber</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">alternate</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果 workInProgress 不存在</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 创建 fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createFiber</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">pendingProps</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">key</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">mode</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 属性复用</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">elementType</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">elementType</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">type</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">type</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 使用 alternate 存储 current</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">alternate</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 使用 alternate 存储 workInProgress</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">alternate</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">childExpirationTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">childExpirationTime</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">expirationTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedProps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedProps</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedState</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedState</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">updateQueue</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">updateQueue</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">sibling</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">sibling</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">index</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">index</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">ref</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">ref</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 返回创建好的 workInProgress Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-8-4-workloopsync" tabindex="-1">5.1.8.4 workLoopSync <a class="header-anchor" href="#_5-1-8-4-workloopsync" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 以同步的方式构建 workInProgress Fiber 对象</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">workLoopSync</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// workInProgress 是一个 fiber 对象</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 它的值不为 null 意味着该 fiber 对象上仍然有更新要执行</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">performUnitOfWork</span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 以同步的方式构建 workInProgress Fiber 对象</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">workLoopSync</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// workInProgress 是一个 fiber 对象</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 它的值不为 null 意味着该 fiber 对象上仍然有更新要执行</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">performUnitOfWork</span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-8-5-performunitofwork" tabindex="-1">5.1.8.5 performUnitOfWork <a class="header-anchor" href="#_5-1-8-5-performunitofwork" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">performUnitOfWork</span><span style="color:#666666;">(</span><span style="color:#BD976A;">unitOfWork</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// unitOfWork =&gt; workInProgress Fiber 树中的 rootFiber</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// current =&gt; currentFiber 树中的 rootFiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">unitOfWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">alternate</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 存储下一个要构建的子级 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">next</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// false</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">enableProfilerTimer</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">unitOfWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">mode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ProfileMode</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoMode</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始渲染 不执行</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// beginWork: 从父到子, 构建 Fiber 节点对象</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 返回值 next 为当前节点的子节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">next</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">beginWork</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">unitOfWork</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">renderExpirationTime</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 为旧的 props 属性赋值</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 此次更新后 pendingProps 变为 memoizedProps</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">unitOfWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedProps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">unitOfWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pendingProps</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果子节点不存在说明当前节点向下遍历子节点已经到底了</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 继续向上返回 遇到兄弟节点 构建兄弟节点的子 Fiber 对象 直到返回到根 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">next</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 从子到父, 构建其余节点 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">next</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">completeUnitOfWork</span><span style="color:#666666;">(</span><span style="color:#BD976A;">unitOfWork</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">next</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">performUnitOfWork</span><span style="color:#999999;">(</span><span style="color:#B07D48;">unitOfWork</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Fiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// unitOfWork =&gt; workInProgress Fiber 树中的 rootFiber</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// current =&gt; currentFiber 树中的 rootFiber</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">unitOfWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">alternate</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 存储下一个要构建的子级 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">next</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// false</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">enableProfilerTimer</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">unitOfWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">mode</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ProfileMode</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoMode</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始渲染 不执行</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// beginWork: 从父到子, 构建 Fiber 节点对象</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 返回值 next 为当前节点的子节点</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">next</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">beginWork</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">unitOfWork</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">renderExpirationTime</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 为旧的 props 属性赋值</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 此次更新后 pendingProps 变为 memoizedProps</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">unitOfWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedProps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">unitOfWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pendingProps</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果子节点不存在说明当前节点向下遍历子节点已经到底了</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 继续向上返回 遇到兄弟节点 构建兄弟节点的子 Fiber 对象 直到返回到根 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">next</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 从子到父, 构建其余节点 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">next</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">completeUnitOfWork</span><span style="color:#999999;">(</span><span style="color:#B07D48;">unitOfWork</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">next</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-8-6-beginwork" tabindex="-1">5.1.8.6 beginWork <a class="header-anchor" href="#_5-1-8-6-beginwork" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 从父到子, 构建 Fiber 节点对象</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">beginWork</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">current</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">renderExpirationTime</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExpirationTime</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// NoWork 常量 值为0 清空过期时间</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">expirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoWork</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 根据当前 Fiber 的类型决定如何构建起子级 Fiber 对象</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 文件位置: shared/ReactWorkTags.js</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">switch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 2</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 函数型组件在第一次渲染组件时使用</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">IndeterminateComponent</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">mountIndeterminateComponent</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 旧 Fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 新 Fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 新 Fiber 的 type 值 初始渲染时是App组件函数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">type</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 同步 整数最大值 1073741823</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">renderExpirationTime</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 0</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">FunctionComponent</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Component</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">type</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">unresolvedProps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pendingProps</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">resolvedProps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">elementType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Component</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">unresolvedProps</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">resolveDefaultProps</span><span style="color:#666666;">(</span><span style="color:#BD976A;">Component</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">unresolvedProps</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">updateFunctionComponent</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">Component</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">resolvedProps</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">renderExpirationTime</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 1</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ClassComponent</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Component</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">type</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">unresolvedProps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pendingProps</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">resolvedProps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">elementType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Component</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">unresolvedProps</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">resolveDefaultProps</span><span style="color:#666666;">(</span><span style="color:#BD976A;">Component</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">unresolvedProps</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">updateClassComponent</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">Component</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">resolvedProps</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">renderExpirationTime</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 3</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostRoot</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">updateHostRoot</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">renderExpirationTime</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 5</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostComponent</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">updateHostComponent</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">renderExpirationTime</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 6</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostText</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">updateHostText</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 组件类型未知 报错</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#80A665;">invariant</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">false</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">Unknown unit of work tag (%s). This error is likely caused by a bug in </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">React. Please file an issue.</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 从父到子, 构建 Fiber 节点对象</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">beginWork</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">current</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">renderExpirationTime</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExpirationTime</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Fiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// NoWork 常量 值为0 清空过期时间</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">expirationTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoWork</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 根据当前 Fiber 的类型决定如何构建起子级 Fiber 对象</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 文件位置: shared/ReactWorkTags.js</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">switch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 2</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 函数型组件在第一次渲染组件时使用</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">IndeterminateComponent</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">mountIndeterminateComponent</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 旧 Fiber</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 新 Fiber</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 新 Fiber 的 type 值 初始渲染时是App组件函数</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">type</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 同步 整数最大值 1073741823</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">renderExpirationTime</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 0</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">FunctionComponent</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Component</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">type</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">unresolvedProps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pendingProps</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">resolvedProps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">elementType</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Component</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">unresolvedProps</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#59873A;">resolveDefaultProps</span><span style="color:#999999;">(</span><span style="color:#B07D48;">Component</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">unresolvedProps</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">updateFunctionComponent</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">Component</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">resolvedProps</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">renderExpirationTime</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 1</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ClassComponent</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Component</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">type</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">unresolvedProps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pendingProps</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">resolvedProps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">elementType</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Component</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">unresolvedProps</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#59873A;">resolveDefaultProps</span><span style="color:#999999;">(</span><span style="color:#B07D48;">Component</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">unresolvedProps</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">updateClassComponent</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">Component</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">resolvedProps</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">renderExpirationTime</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 3</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostRoot</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">updateHostRoot</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">renderExpirationTime</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 5</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostComponent</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">updateHostComponent</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">renderExpirationTime</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 6</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostText</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">updateHostText</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 组件类型未知 报错</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#59873A;">invariant</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">false</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">Unknown unit of work tag (%s). This error is likely caused by a bug in </span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">React. Please file an issue.</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-8-7-updatehostroot" tabindex="-1">5.1.8.7 updateHostRoot <a class="header-anchor" href="#_5-1-8-7-updatehostroot" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// HostRoot =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt; 对应的 Fiber 对象</span></span>
<span class="line"><span style="color:#758575DD;">// 找出 HostRoot 的子 ReactElement 并为其构建 Fiber 对象</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">updateHostRoot</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">renderExpirationTime</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取更新队列</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">updateQueue</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">updateQueue</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取新的 props 对象 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextProps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pendingProps</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取上一次渲染使用的 state null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">prevState</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedState</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取上一次渲染使用的 children null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">prevChildren</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">prevState</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">prevState</span><span style="color:#666666;">.</span><span style="color:#BD976A;">element</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 浅复制更新队列, 防止引用属性互相影响</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// workInProgress.updateQueue 浅拷贝 current.updateQueue</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">cloneUpdateQueue</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取 updateQueue.payload 并赋值到 workInProgress.memoizedState</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 要更新的内容就是 element 就是 rootFiber 的子元素</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">processUpdateQueue</span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextProps</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">renderExpirationTime</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取 element 所在对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextState</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedState</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 从对象中获取 element</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextChildren</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextState</span><span style="color:#666666;">.</span><span style="color:#BD976A;">element</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取 fiberRoot 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">FiberRoot</span><span style="color:#666666;"> =</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 服务器端渲染走 if</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hydrate</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">enterHydrationState</span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 忽略</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 客户端渲染走 else</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 构建子节点 fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">reconcileChildren</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">nextChildren</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">renderExpirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 返回子节点 fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// HostRoot =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt; 对应的 Fiber 对象</span></span>
<span class="line"><span style="color:#A0ADA0;">// 找出 HostRoot 的子 ReactElement 并为其构建 Fiber 对象</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">updateHostRoot</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">renderExpirationTime</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取更新队列</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">updateQueue</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">updateQueue</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取新的 props 对象 null</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextProps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pendingProps</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取上一次渲染使用的 state null</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">prevState</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedState</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取上一次渲染使用的 children null</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">prevChildren</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">prevState</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">prevState</span><span style="color:#999999;">.</span><span style="color:#B07D48;">element</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 浅复制更新队列, 防止引用属性互相影响</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// workInProgress.updateQueue 浅拷贝 current.updateQueue</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">cloneUpdateQueue</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取 updateQueue.payload 并赋值到 workInProgress.memoizedState</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 要更新的内容就是 element 就是 rootFiber 的子元素</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">processUpdateQueue</span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextProps</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">renderExpirationTime</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取 element 所在对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextState</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedState</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 从对象中获取 element</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextChildren</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextState</span><span style="color:#999999;">.</span><span style="color:#B07D48;">element</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取 fiberRoot 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#999999;">: </span><span style="color:#2E808F;">FiberRoot</span><span style="color:#999999;"> =</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 服务器端渲染走 if</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hydrate</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> </span><span style="color:#59873A;">enterHydrationState</span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 忽略</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 客户端渲染走 else</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 构建子节点 fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">reconcileChildren</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">nextChildren</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">renderExpirationTime</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 返回子节点 fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-8-8-reconcilechildren" tabindex="-1">5.1.8.8 reconcileChildren <a class="header-anchor" href="#_5-1-8-8-reconcilechildren" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">reconcileChildren</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 旧 Fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">current</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 父级 Fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 子级 vdom 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">nextChildren</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 初始渲染 整型最大值 代表同步任务</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">renderExpirationTime</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExpirationTime</span></span>
<span class="line"><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">     * 为什么要传递 current ?</span></span>
<span class="line"><span style="color:#758575DD;">     * 如果不是初始渲染的情况, 要进行新旧 Fiber 对比</span></span>
<span class="line"><span style="color:#758575DD;">     * 初始渲染时则用不到 current</span></span>
<span class="line"><span style="color:#758575DD;">     */</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果就 Fiber 为 null 表示初始渲染</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 为当前构建的 Fiber 对象添加子级 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">mountChildFibers</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">nextChildren</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">renderExpirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 忽略了 else 的情况</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">reconcileChildren</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 旧 Fiber</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">current</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 父级 Fiber</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 子级 vdom 对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">nextChildren</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 初始渲染 整型最大值 代表同步任务</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">renderExpirationTime</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExpirationTime</span></span>
<span class="line"><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 为什么要传递 current ?</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 如果不是初始渲染的情况, 要进行新旧 Fiber 对比</span></span>
<span class="line"><span style="color:#A0ADA0;">     * 初始渲染时则用不到 current</span></span>
<span class="line"><span style="color:#A0ADA0;">     */</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果就 Fiber 为 null 表示初始渲染</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 为当前构建的 Fiber 对象添加子级 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">mountChildFibers</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">nextChildren</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">renderExpirationTime</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 忽略了 else 的情况</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-8-9-childreconciler" tabindex="-1">5.1.8.9 ChildReconciler <a class="header-anchor" href="#_5-1-8-9-childreconciler" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactChildFiber.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * shouldTrackSideEffects 标识, 是否为 Fiber 对象添加 effectTag</span></span>
<span class="line"><span style="color:#758575DD;"> * true 添加 false 不添加</span></span>
<span class="line"><span style="color:#758575DD;"> * 对于初始渲染来说, 只有根组件需要添加, 其他元素不需要添加, 防止过多的 DOM 操作</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#758575DD;">// 用于初始渲染</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">mountChildFibers</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">ChildReconciler</span><span style="color:#666666;">(</span><span style="color:#4D9375;">false</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">ChildReconciler</span><span style="color:#666666;">(</span><span style="color:#BD976A;">shouldTrackSideEffects</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">placeChild</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">newFiber</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">lastPlacedIndex</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">number</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">newIndex</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">number</span></span>
<span class="line"><span style="color:#666666;">    ):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">number</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">newFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">index</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newIndex</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">shouldTrackSideEffects</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">lastPlacedIndex</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 忽略了一部分初始化渲染不执行的代码</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">placeSingleChild</span><span style="color:#666666;">(</span><span style="color:#BD976A;">newFiber</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果是初始渲染 会在根组件(App)上设置 effectTag 属性为 Placement 值为 1</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 其他子级节点具有默认值为 0 防止在 commit 阶段反复操作真实DOM</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始渲染时如果当前处理的是根组件 true 其他组件 false</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">shouldTrackSideEffects</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">alternate</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// Placement 表示新创建的节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">newFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Placement</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newFiber</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 处理子元素是数组的情况</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">reconcileChildrenArray</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 父级 Fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 子级 vdom 数组</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">newChildren</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Array</span><span style="color:#666666;">&lt;*&gt;,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExpirationTime</span></span>
<span class="line"><span style="color:#666666;">    ):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">         * 存储第一个子节点 Fiber 对象</span></span>
<span class="line"><span style="color:#758575DD;">         * 方法返回的也是第一个子节点 Fiber 对象</span></span>
<span class="line"><span style="color:#758575DD;">         * 因为其他子节点 Fiber 对象都存储在上一个子 Fiber 节点对象的 sibling 属性中</span></span>
<span class="line"><span style="color:#758575DD;">         */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">resultingFirstChild</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;"> =</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 上一次创建的 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">previousNewFiber</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;"> =</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始渲染没有旧的子级 所以为 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">oldFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">lastPlacedIndex</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newIdx</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextOldFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// oldFiber 为空 说明是初始渲染</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">oldFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 遍历子 vdom 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newIdx</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newChildren</span><span style="color:#666666;">.</span><span style="color:#B8A965;">length</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newIdx</span><span style="color:#CB7676;">++</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 创建子 vdom 对应的 fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createChild</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">newChildren</span><span style="color:#666666;">[</span><span style="color:#BD976A;">newIdx</span><span style="color:#666666;">],</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">expirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 如果 newFiber 为 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">newFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 进入下次循环</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#4D9375;">continue</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 初始渲染时只为 newFiber 添加了 index 属性,</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 其他事没干. lastPlacedIndex 被原封不动的返回了</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">lastPlacedIndex</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">placeChild</span><span style="color:#666666;">(</span><span style="color:#BD976A;">newFiber</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">lastPlacedIndex</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newIdx</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 为当前节点设置下一个兄弟节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">previousNewFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 存储第一个子 Fiber 发生在第一次循环时</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">resultingFirstChild</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newFiber</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 为节点设置下一个兄弟 Fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">previousNewFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">sibling</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newFiber</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 在循环的过程中更新上一个创建的Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">previousNewFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newFiber</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 返回创建好的子 Fiber</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 其他 Fiber 都作为 sibling 存在</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">resultingFirstChild</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 返回第一个子元素 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">resultingFirstChild</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 处理子元素是文本或者数值的情况</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">reconcileSingleTextNode</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">textContent</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">string</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExpirationTime</span></span>
<span class="line"><span style="color:#666666;">    ):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始渲染不执行</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostText</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// We already have an existing node so let&#39;s just update it and delete</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// the rest.</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">deleteRemainingChildren</span><span style="color:#666666;">(</span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">.</span><span style="color:#BD976A;">sibling</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">existing</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">useFiber</span><span style="color:#666666;">(</span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">textContent</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">existing</span><span style="color:#666666;">.</span><span style="color:#BD976A;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">existing</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 现有的第一个子节点不是文本节点，因此我们需要创建一个并删除现有的.</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始渲染不执行</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">deleteRemainingChildren</span><span style="color:#666666;">(</span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 根据文本创建 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">created</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createFiberFromText</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">textContent</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">mode</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">expirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 设置父 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">created</span><span style="color:#666666;">.</span><span style="color:#BD976A;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 返回创建好的 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">created</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 处理子元素是单个对象的情况</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">reconcileSingleElement</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 父 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 备份子 fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 子 vdom 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">element</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ReactElement</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExpirationTime</span></span>
<span class="line"><span style="color:#666666;">    ):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 查看子 vdom 对象是否表示 fragment</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">element</span><span style="color:#666666;">.</span><span style="color:#BD976A;">type</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">REACT_FRAGMENT_TYPE</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// false</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 根据 React Element 创建 Fiber 对象</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 返回创建好的 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">created</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createFiberFromElement</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">element</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 用来表示当前组件下的所有子组件要用处于何种渲染模式</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 文件位置: ./ReactTypeOfMode.js</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 0    同步渲染模式</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 100  异步渲染模式</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">mode</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">expirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 添加 ref 属性 { current: DOM }</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">created</span><span style="color:#666666;">.</span><span style="color:#BD976A;">ref</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">coerceRef</span><span style="color:#666666;">(</span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">element</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 添加父级 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">created</span><span style="color:#666666;">.</span><span style="color:#BD976A;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 返回创建好的子 Fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">created</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">reconcileChildFibers</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 父 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 旧的第一个子 Fiber 初始渲染 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 新的子 vdom 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">newChild</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始渲染 整型最大值 代表同步任务</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">expirationTime</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExpirationTime</span></span>
<span class="line"><span style="color:#666666;">    ):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 这是入口方法, 根据 newChild 类型进行对应处理</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 判断新的子 vdom 是否为占位组件 比如 &lt;&gt;&lt;/&gt;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// false</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isUnkeyedTopLevelFragment</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newChild</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">object</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">newChild</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">newChild</span><span style="color:#666666;">.</span><span style="color:#BD976A;">type</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">REACT_FRAGMENT_TYPE</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">newChild</span><span style="color:#666666;">.</span><span style="color:#BD976A;">key</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果 newChild 为占位符, 使用 占位符组件的子元素作为 newChild</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">isUnkeyedTopLevelFragment</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">newChild</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newChild</span><span style="color:#666666;">.</span><span style="color:#BD976A;">props</span><span style="color:#666666;">.</span><span style="color:#BD976A;">children</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 检测 newChild 是否为对象类型</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isObject</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newChild</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">object</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newChild</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// newChild 是单个对象的情况</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">isObject</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 匹配子元素的类型</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">switch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">newChild</span><span style="color:#666666;">.</span><span style="color:#BD976A;">$$typeof</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 子元素为 ReactElement</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">REACT_ELEMENT_TYPE</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 为 Fiber 对象设置 effectTag 属性</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 返回创建好的子 Fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">placeSingleChild</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#666666;">                        </span><span style="color:#758575DD;">// 处理单个 React Element 的情况</span></span>
<span class="line"><span style="color:#666666;">                        </span><span style="color:#758575DD;">// 内部会调用其他方法创建对应的 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#80A665;">reconcileSingleElement</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                            </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                            </span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                            </span><span style="color:#BD976A;">newChild</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                            </span><span style="color:#BD976A;">expirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 处理 children 为文本和数值的情况 return &quot;App works&quot;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newChild</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">string</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newChild</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#C98A7D;">number</span><span style="color:#C98A7DAA;">&#39;</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">placeSingleChild</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">reconcileSingleTextNode</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 如果 newChild 是数值, 转换为字符串</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#C98A7DAA;">&#39;&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">+</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newChild</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">expirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// children 是数组的情况</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#80A665;">isArray</span><span style="color:#666666;">(</span><span style="color:#BD976A;">newChild</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 返回创建好的子 Fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">reconcileChildrenArray</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">currentFirstChild</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">newChild</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">expirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * shouldTrackSideEffects 标识, 是否为 Fiber 对象添加 effectTag</span></span>
<span class="line"><span style="color:#A0ADA0;"> * true 添加 false 不添加</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 对于初始渲染来说, 只有根组件需要添加, 其他元素不需要添加, 防止过多的 DOM 操作</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#A0ADA0;">// 用于初始渲染</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">mountChildFibers</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">ChildReconciler</span><span style="color:#999999;">(</span><span style="color:#1E754F;">false</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">ChildReconciler</span><span style="color:#999999;">(</span><span style="color:#B07D48;">shouldTrackSideEffects</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">placeChild</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">newFiber</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">lastPlacedIndex</span><span style="color:#999999;">: </span><span style="color:#2E808F;">number</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">newIndex</span><span style="color:#999999;">: </span><span style="color:#2E808F;">number</span></span>
<span class="line"><span style="color:#999999;">    ):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">number</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">newFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">index</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newIndex</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">shouldTrackSideEffects</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">lastPlacedIndex</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 忽略了一部分初始化渲染不执行的代码</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">placeSingleChild</span><span style="color:#999999;">(</span><span style="color:#B07D48;">newFiber</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Fiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果是初始渲染 会在根组件(App)上设置 effectTag 属性为 Placement 值为 1</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 其他子级节点具有默认值为 0 防止在 commit 阶段反复操作真实DOM</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始渲染时如果当前处理的是根组件 true 其他组件 false</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">shouldTrackSideEffects</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">alternate</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// Placement 表示新创建的节点</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">newFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Placement</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newFiber</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 处理子元素是数组的情况</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">reconcileChildrenArray</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 父级 Fiber</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 子级 vdom 数组</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">newChildren</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Array</span><span style="color:#999999;">&lt;*&gt;,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExpirationTime</span></span>
<span class="line"><span style="color:#999999;">    ):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Fiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 存储第一个子节点 Fiber 对象</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 方法返回的也是第一个子节点 Fiber 对象</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 因为其他子节点 Fiber 对象都存储在上一个子 Fiber 节点对象的 sibling 属性中</span></span>
<span class="line"><span style="color:#A0ADA0;">         */</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">resultingFirstChild</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;"> =</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 上一次创建的 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">previousNewFiber</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;"> =</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始渲染没有旧的子级 所以为 null</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">oldFiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">lastPlacedIndex</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newIdx</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextOldFiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// oldFiber 为空 说明是初始渲染</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">oldFiber</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 遍历子 vdom 对象</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">for</span><span style="color:#393A34;"> </span><span style="color:#999999;">(;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newIdx</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newChildren</span><span style="color:#999999;">.</span><span style="color:#998418;">length</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newIdx</span><span style="color:#AB5959;">++</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 创建子 vdom 对应的 fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newFiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createChild</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">newChildren</span><span style="color:#999999;">[</span><span style="color:#B07D48;">newIdx</span><span style="color:#999999;">],</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">expirationTime</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 如果 newFiber 为 null</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">newFiber</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 进入下次循环</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#1E754F;">continue</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 初始渲染时只为 newFiber 添加了 index 属性,</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 其他事没干. lastPlacedIndex 被原封不动的返回了</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">lastPlacedIndex</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">placeChild</span><span style="color:#999999;">(</span><span style="color:#B07D48;">newFiber</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">lastPlacedIndex</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newIdx</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 为当前节点设置下一个兄弟节点</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">previousNewFiber</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 存储第一个子 Fiber 发生在第一次循环时</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">resultingFirstChild</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newFiber</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 为节点设置下一个兄弟 Fiber</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">previousNewFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">sibling</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newFiber</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 在循环的过程中更新上一个创建的Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">previousNewFiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newFiber</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 返回创建好的子 Fiber</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 其他 Fiber 都作为 sibling 存在</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">resultingFirstChild</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 返回第一个子元素 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">resultingFirstChild</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 处理子元素是文本或者数值的情况</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">reconcileSingleTextNode</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">textContent</span><span style="color:#999999;">: </span><span style="color:#2E808F;">string</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExpirationTime</span></span>
<span class="line"><span style="color:#999999;">    ):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Fiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始渲染不执行</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostText</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// We already have an existing node so let&#39;s just update it and delete</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// the rest.</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">deleteRemainingChildren</span><span style="color:#999999;">(</span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">.</span><span style="color:#B07D48;">sibling</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">existing</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">useFiber</span><span style="color:#999999;">(</span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">textContent</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">existing</span><span style="color:#999999;">.</span><span style="color:#B07D48;">return</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">existing</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 现有的第一个子节点不是文本节点，因此我们需要创建一个并删除现有的.</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始渲染不执行</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">deleteRemainingChildren</span><span style="color:#999999;">(</span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 根据文本创建 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">created</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createFiberFromText</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">textContent</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">mode</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">expirationTime</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 设置父 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">created</span><span style="color:#999999;">.</span><span style="color:#B07D48;">return</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 返回创建好的 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">created</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 处理子元素是单个对象的情况</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">reconcileSingleElement</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 父 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 备份子 fiber</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 子 vdom 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">element</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ReactElement</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExpirationTime</span></span>
<span class="line"><span style="color:#999999;">    ):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Fiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 查看子 vdom 对象是否表示 fragment</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">element</span><span style="color:#999999;">.</span><span style="color:#B07D48;">type</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">REACT_FRAGMENT_TYPE</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// false</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 根据 React Element 创建 Fiber 对象</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 返回创建好的 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">created</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createFiberFromElement</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">element</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 用来表示当前组件下的所有子组件要用处于何种渲染模式</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 文件位置: ./ReactTypeOfMode.js</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 0    同步渲染模式</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 100  异步渲染模式</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">mode</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">expirationTime</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 添加 ref 属性 { current: DOM }</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">created</span><span style="color:#999999;">.</span><span style="color:#B07D48;">ref</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">coerceRef</span><span style="color:#999999;">(</span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">element</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 添加父级 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">created</span><span style="color:#999999;">.</span><span style="color:#B07D48;">return</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 返回创建好的子 Fiber</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">created</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">reconcileChildFibers</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 父 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 旧的第一个子 Fiber 初始渲染 null</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 新的子 vdom 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">newChild</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始渲染 整型最大值 代表同步任务</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">expirationTime</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExpirationTime</span></span>
<span class="line"><span style="color:#999999;">    ):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Fiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 这是入口方法, 根据 newChild 类型进行对应处理</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 判断新的子 vdom 是否为占位组件 比如 &lt;&gt;&lt;/&gt;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// false</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isUnkeyedTopLevelFragment</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newChild</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">object</span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">newChild</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">newChild</span><span style="color:#999999;">.</span><span style="color:#B07D48;">type</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">REACT_FRAGMENT_TYPE</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">newChild</span><span style="color:#999999;">.</span><span style="color:#B07D48;">key</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果 newChild 为占位符, 使用 占位符组件的子元素作为 newChild</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">isUnkeyedTopLevelFragment</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">newChild</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newChild</span><span style="color:#999999;">.</span><span style="color:#B07D48;">props</span><span style="color:#999999;">.</span><span style="color:#B07D48;">children</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 检测 newChild 是否为对象类型</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isObject</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newChild</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">object</span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newChild</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// newChild 是单个对象的情况</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">isObject</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 匹配子元素的类型</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">switch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">newChild</span><span style="color:#999999;">.</span><span style="color:#B07D48;">$$typeof</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 子元素为 ReactElement</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">REACT_ELEMENT_TYPE</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 为 Fiber 对象设置 effectTag 属性</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 返回创建好的子 Fiber</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">placeSingleChild</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#999999;">                        </span><span style="color:#A0ADA0;">// 处理单个 React Element 的情况</span></span>
<span class="line"><span style="color:#999999;">                        </span><span style="color:#A0ADA0;">// 内部会调用其他方法创建对应的 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#59873A;">reconcileSingleElement</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                            </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                            </span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                            </span><span style="color:#B07D48;">newChild</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                            </span><span style="color:#B07D48;">expirationTime</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 处理 children 为文本和数值的情况 return &quot;App works&quot;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newChild</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">string</span><span style="color:#B56959AA;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newChild</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B56959AA;">&#39;</span><span style="color:#B56959;">number</span><span style="color:#B56959AA;">&#39;</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">placeSingleChild</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">reconcileSingleTextNode</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 如果 newChild 是数值, 转换为字符串</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B56959AA;">&#39;&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">+</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newChild</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">expirationTime</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// children 是数组的情况</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#59873A;">isArray</span><span style="color:#999999;">(</span><span style="color:#B07D48;">newChild</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 返回创建好的子 Fiber</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#59873A;">reconcileChildrenArray</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">currentFirstChild</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">newChild</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">expirationTime</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-8-10-completeunitofwork" tabindex="-1">5.1.8.10 completeUnitOfWork <a class="header-anchor" href="#_5-1-8-10-completeunitofwork" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> *</span></span>
<span class="line"><span style="color:#758575DD;"> * 从下至上移动到该节点的兄弟节点, 如果一直往上没有兄弟节点就返回父节点, 最终会到达 root 节点</span></span>
<span class="line"><span style="color:#758575DD;"> * 1. 创建其他节点的 Fiber 对象</span></span>
<span class="line"><span style="color:#758575DD;"> * 2. 创建每一个节点的真实 DOM 对象并将其添加到 stateNode 属性中</span></span>
<span class="line"><span style="color:#758575DD;"> * 3. 构建 effect 链表结构</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">completeUnitOfWork</span><span style="color:#666666;">(</span><span style="color:#BD976A;">unitOfWork</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 为 workInProgress 全局变量重新赋值</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">unitOfWork</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">do</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 获取备份节点</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始化渲染 非根 Fiber 对象没有备份节点 所以 current 为 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">alternate</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 父级 Fiber 对象, 非根 Fiber 对象都有父级</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">returnFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 判断传入的 Fiber 对象是否构建完成, 任务调度相关</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// &amp; 是表示位的与运算, 把左右两边的数字转化为二进制</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 然后每一位分别进行比较, 如果相等就为1, 不相等即为0</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 此处应用&quot;位与&quot;运算符的目的是&quot;清零&quot;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// true</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">((</span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Incomplete</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoEffect</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">next</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果不能使用分析器的 timer, 直接执行 completeWork</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// enableProfilerTimer =&gt; true</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 但此处无论条件是否成立都会执行 completeWork</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">enableProfilerTimer</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">mode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ProfileMode</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoMode</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 重点代码(二)</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 创建节点真实 DOM 对象并将其添加到 stateNode 属性中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">next</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">completeWork</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">renderExpirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 创建节点真实 DOM 对象并将其添加到 stateNode 属性中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">next</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">completeWork</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">renderExpirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 重点代码(一)</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果子级存在</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">next</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 返回子级 一直返回到 workLoopSync</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 再重新执行 performUnitOfWork 构建子级 Fiber 节点对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">next</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 构建 effect 链表结构</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果不是根 Fiber 就是 true 否则就是 false</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 将子树和此 Fiber 的所有 effect 附加到父级的 effect 列表中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 如果父 Fiber 存在 并且</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">returnFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 父 Fiber 对象中的 effectTag 为 0</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">(</span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Incomplete</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoEffect</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 将子树和此 Fiber 的所有副作用附加到父级的 effect 列表上</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 以下两个判断的作用是搜集子 Fiber的 effect 到父 Fiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">firstEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// first</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">firstEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">firstEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                        </span><span style="color:#758575DD;">// next</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                            </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">firstEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// last</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 获取副作用标记</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 初始渲染时除[根组件]以外的 Fiber, effectTag 值都为 0, 即不需要执行任何真实DOM操作</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 根组件的 effectTag 值为 3, 即需要将此节点对应的真实DOM对象添加到页面中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 创建 effect 列表时跳过 NoWork(0) 和 PerformedWork(1) 标记</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// PerformedWork 由 React DevTools 读取, 不提交</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 初始渲染时 只有遍历到了根组件 判断条件才能成立, 将 effect 链表添加到 rootFiber</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 初始渲染 FiberRoot 对象中的 firstEffect 和 lastEffect 都是 App 组件</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 因为当所有节点在内存中构建完成后, 只需要一次将所有 DOM 添加到页面中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">PerformedWork</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// false</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                        </span><span style="color:#758575DD;">// 为 fiberRoot 添加 firstEffect</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">firstEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 为 fiberRoot 添加 lastEffect</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 忽略了初始渲染不执行的代码</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 获取下一个同级 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">siblingFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">sibling</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果下一个同级 Fiber 对象存在</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">siblingFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 返回下一个同级 Fiber 对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">siblingFiber</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 否则退回父级</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgress</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">returnFiber</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 当执行到这里的时候, 说明遍历到了 root 节点, 已完成遍历</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 更新 workInProgressRootExitStatus 的状态为 已完成</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgressRootExitStatus</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">RootIncomplete</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">workInProgressRootExitStatus</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">RootCompleted</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> *</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 从下至上移动到该节点的兄弟节点, 如果一直往上没有兄弟节点就返回父节点, 最终会到达 root 节点</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 1. 创建其他节点的 Fiber 对象</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 2. 创建每一个节点的真实 DOM 对象并将其添加到 stateNode 属性中</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 3. 构建 effect 链表结构</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">completeUnitOfWork</span><span style="color:#999999;">(</span><span style="color:#B07D48;">unitOfWork</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Fiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 为 workInProgress 全局变量重新赋值</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">unitOfWork</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">do</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 获取备份节点</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始化渲染 非根 Fiber 对象没有备份节点 所以 current 为 null</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">alternate</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 父级 Fiber 对象, 非根 Fiber 对象都有父级</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">returnFiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 判断传入的 Fiber 对象是否构建完成, 任务调度相关</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// &amp; 是表示位的与运算, 把左右两边的数字转化为二进制</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 然后每一位分别进行比较, 如果相等就为1, 不相等即为0</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 此处应用&quot;位与&quot;运算符的目的是&quot;清零&quot;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// true</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">((</span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Incomplete</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoEffect</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">next</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果不能使用分析器的 timer, 直接执行 completeWork</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// enableProfilerTimer =&gt; true</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 但此处无论条件是否成立都会执行 completeWork</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">enableProfilerTimer</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">mode</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ProfileMode</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoMode</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 重点代码(二)</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 创建节点真实 DOM 对象并将其添加到 stateNode 属性中</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">next</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">completeWork</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">renderExpirationTime</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 创建节点真实 DOM 对象并将其添加到 stateNode 属性中</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">next</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">completeWork</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">renderExpirationTime</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 重点代码(一)</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果子级存在</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">next</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 返回子级 一直返回到 workLoopSync</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 再重新执行 performUnitOfWork 构建子级 Fiber 节点对象</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">next</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 构建 effect 链表结构</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果不是根 Fiber 就是 true 否则就是 false</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 将子树和此 Fiber 的所有 effect 附加到父级的 effect 列表中</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 如果父 Fiber 存在 并且</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">returnFiber</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 父 Fiber 对象中的 effectTag 为 0</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">(</span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Incomplete</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoEffect</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 将子树和此 Fiber 的所有副作用附加到父级的 effect 列表上</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 以下两个判断的作用是搜集子 Fiber的 effect 到父 Fiber</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">firstEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// first</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">firstEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">firstEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                        </span><span style="color:#A0ADA0;">// next</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span></span>
<span class="line"><span style="color:#393A34;">                            </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">firstEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// last</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 获取副作用标记</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 初始渲染时除[根组件]以外的 Fiber, effectTag 值都为 0, 即不需要执行任何真实DOM操作</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 根组件的 effectTag 值为 3, 即需要将此节点对应的真实DOM对象添加到页面中</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 创建 effect 列表时跳过 NoWork(0) 和 PerformedWork(1) 标记</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// PerformedWork 由 React DevTools 读取, 不提交</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 初始渲染时 只有遍历到了根组件 判断条件才能成立, 将 effect 链表添加到 rootFiber</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 初始渲染 FiberRoot 对象中的 firstEffect 和 lastEffect 都是 App 组件</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 因为当所有节点在内存中构建完成后, 只需要一次将所有 DOM 添加到页面中</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&gt;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">PerformedWork</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// false</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                        </span><span style="color:#A0ADA0;">// 为 fiberRoot 添加 firstEffect</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">firstEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 为 fiberRoot 添加 lastEffect</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 忽略了初始渲染不执行的代码</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 获取下一个同级 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">siblingFiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">sibling</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果下一个同级 Fiber 对象存在</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">siblingFiber</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 返回下一个同级 Fiber 对象</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">siblingFiber</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 否则退回父级</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgress</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">returnFiber</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 当执行到这里的时候, 说明遍历到了 root 节点, 已完成遍历</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 更新 workInProgressRootExitStatus 的状态为 已完成</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgressRootExitStatus</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">RootIncomplete</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">workInProgressRootExitStatus</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">RootCompleted</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-8-11-completework" tabindex="-1">5.1.8.11 completeWork <a class="header-anchor" href="#_5-1-8-11-completework" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberCompleteWork.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">completeWork</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">current</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">renderExpirationTime</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExpirationTime</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取待更新 props</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">newProps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">pendingProps</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">switch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 0</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">FunctionComponent</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 3</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostRoot</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">updateHostContainer</span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 5</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostComponent</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 获取 rootDOM 节点 &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">rootContainerInstance</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">getRootHostContainer</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 节点的具体的类型 div span ...</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">type</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">type</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// false current = null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 初始渲染不执行</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// false</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">wasHydrated</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 初始渲染不执行</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 创建节点实例对象 &lt;div&gt;&lt;/div&gt; &lt;span&gt;&lt;/span&gt;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">instance</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">createInstance</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#BD976A;">type</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#BD976A;">newProps</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#BD976A;">rootContainerInstance</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#BD976A;">currentHostContext</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#BD976A;">workInProgress</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">                     * 将所有的子级追加到父级中</span></span>
<span class="line"><span style="color:#758575DD;">                     * instance 为父级</span></span>
<span class="line"><span style="color:#758575DD;">                     * workInProgress.child 为子级</span></span>
<span class="line"><span style="color:#758575DD;">                     */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#80A665;">appendAllChildren</span><span style="color:#666666;">(</span><span style="color:#BD976A;">instance</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">false</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">false</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 为 Fiber 对象添加 stateNode 属性</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">instance</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 处理 ref DOM 引用</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">ref</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#80A665;">markRef</span><span style="color:#666666;">(</span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">completeWork</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">current</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">renderExpirationTime</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExpirationTime</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Fiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">|</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取待更新 props</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">newProps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">pendingProps</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">switch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 0</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">FunctionComponent</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 3</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostRoot</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">updateHostContainer</span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 5</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostComponent</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 获取 rootDOM 节点 &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">rootContainerInstance</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">getRootHostContainer</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 节点的具体的类型 div span ...</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">type</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">type</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// false current = null</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 初始渲染不执行</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// false</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">wasHydrated</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 初始渲染不执行</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 创建节点实例对象 &lt;div&gt;&lt;/div&gt; &lt;span&gt;&lt;/span&gt;</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">instance</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">createInstance</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B07D48;">type</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B07D48;">newProps</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B07D48;">rootContainerInstance</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B07D48;">currentHostContext</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B07D48;">workInProgress</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">                     * 将所有的子级追加到父级中</span></span>
<span class="line"><span style="color:#A0ADA0;">                     * instance 为父级</span></span>
<span class="line"><span style="color:#A0ADA0;">                     * workInProgress.child 为子级</span></span>
<span class="line"><span style="color:#A0ADA0;">                     */</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#59873A;">appendAllChildren</span><span style="color:#999999;">(</span><span style="color:#B07D48;">instance</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">false</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">false</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 为 Fiber 对象添加 stateNode 属性</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">instance</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 处理 ref DOM 引用</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">ref</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#59873A;">markRef</span><span style="color:#999999;">(</span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-1-8-12-appendallchildren" tabindex="-1">5.1.8.12 appendAllChildren <a class="header-anchor" href="#_5-1-8-12-appendallchildren" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberCompleteWork.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#80A665;">appendAllChildren</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">parent</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Instance</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">needsVisibilityToggle</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">boolean</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">isHidden</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">boolean</span></span>
<span class="line"><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取子级</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果子级不为空 执行循环</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果 node 是普通 ReactElement 或者为文本</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostText</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 将子级追加到父级中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">appendInitialChild</span><span style="color:#666666;">(</span><span style="color:#BD976A;">parent</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果 node 不是普通 ReactElement 又不是文本</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 将 node 视为组件, 组件本身不能转换为真实 DOM 元素</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 获取到组件的第一个子元素, 继续执行循环</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#666666;">.</span><span style="color:#BD976A;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">node</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">continue</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果 node 和 workInProgress 是同一个节点</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 说明 node 已经退回到父级 终止循环</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 说明此时所有子级都已经追加到父级中了</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 处理子级节点的兄弟节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">sibling</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果节点没有父级或者节点的父级是自己, 退出循环</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 说明此时所有子级都已经追加到父级中了</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">workInProgress</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 更新 node</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">node</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 更新父级 方便回退</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">sibling</span><span style="color:#666666;">.</span><span style="color:#BD976A;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 将 node 更新为下一个兄弟节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">node</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">sibling</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">};</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#59873A;">appendAllChildren</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">parent</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Instance</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">needsVisibilityToggle</span><span style="color:#999999;">: </span><span style="color:#2E808F;">boolean</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">isHidden</span><span style="color:#999999;">: </span><span style="color:#2E808F;">boolean</span></span>
<span class="line"><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取子级</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果子级不为空 执行循环</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果 node 是普通 ReactElement 或者为文本</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostComponent</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostText</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 将子级追加到父级中</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">appendInitialChild</span><span style="color:#999999;">(</span><span style="color:#B07D48;">parent</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果 node 不是普通 ReactElement 又不是文本</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 将 node 视为组件, 组件本身不能转换为真实 DOM 元素</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 获取到组件的第一个子元素, 继续执行循环</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#999999;">.</span><span style="color:#B07D48;">return</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">node</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">continue</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果 node 和 workInProgress 是同一个节点</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 说明 node 已经退回到父级 终止循环</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 说明此时所有子级都已经追加到父级中了</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 处理子级节点的兄弟节点</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">sibling</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果节点没有父级或者节点的父级是自己, 退出循环</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 说明此时所有子级都已经追加到父级中了</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">workInProgress</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 更新 node</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">node</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 更新父级 方便回退</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">sibling</span><span style="color:#999999;">.</span><span style="color:#B07D48;">return</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 将 node 更新为下一个兄弟节点</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">node</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">sibling</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">};</span></span>
<span class="line"></span></code></pre></div><h3 id="_5-2-commit-阶段" tabindex="-1">5.2 commit 阶段 <a class="header-anchor" href="#_5-2-commit-阶段" aria-hidden="true">#</a></h3><h4 id="_5-2-1-finishsyncrender" tabindex="-1">5.2.1 finishSyncRender <a class="header-anchor" href="#_5-2-1-finishsyncrender" aria-hidden="true">#</a></h4><p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">finishSyncRender</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 销毁 workInProgress Fiber 树</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 因为待提交 Fiber 对象已经被存储在了 root.finishedWork 中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">workInProgressRoot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 进入 commit 阶段</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">commitRoot</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">finishSyncRender</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 销毁 workInProgress Fiber 树</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 因为待提交 Fiber 对象已经被存储在了 root.finishedWork 中</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">workInProgressRoot</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 进入 commit 阶段</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">commitRoot</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-2-2-commitroot" tabindex="-1">5.2.2 commitRoot <a class="header-anchor" href="#_5-2-2-commitroot" aria-hidden="true">#</a></h4><p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">commitRoot</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取任务优先级 97 =&gt; 普通优先级</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">renderPriorityLevel</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">getCurrentPriorityLevel</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 使用最高优先级执行当前任务, 因为 commit 阶段不可以被打断</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// ImmediatePriority, 优先级为 99, 最高优先级</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#80A665;">runWithPriority</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">ImmediatePriority</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">commitRootImpl</span><span style="color:#666666;">.</span><span style="color:#80A665;">bind</span><span style="color:#666666;">(</span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">renderPriorityLevel</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">commitRoot</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取任务优先级 97 =&gt; 普通优先级</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">renderPriorityLevel</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">getCurrentPriorityLevel</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 使用最高优先级执行当前任务, 因为 commit 阶段不可以被打断</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// ImmediatePriority, 优先级为 99, 最高优先级</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#59873A;">runWithPriority</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">ImmediatePriority</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">commitRootImpl</span><span style="color:#999999;">.</span><span style="color:#59873A;">bind</span><span style="color:#999999;">(</span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">renderPriorityLevel</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-2-3-commitrootimpl" tabindex="-1">5.2.3 commitRootImpl <a class="header-anchor" href="#_5-2-3-commitrootimpl" aria-hidden="true">#</a></h4><p>commit 阶段可以分为三个子阶段：</p><ul><li>before mutation 阶段（执行 DOM 操作前）</li><li>mutation 阶段（执行 DOM 操作）</li><li>layout 阶段（执行 DOM 操作后）</li></ul><p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">commitRootImpl</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">renderPriorityLevel</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取待提交 Fiber 对象 rootFiber</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">finishedWork</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果没有任务要执行</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 阻止程序继续向下执行</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 重置为默认值</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">finishedWork</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callbackNode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callbackExpirationTime</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoWork</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callbackPriority</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoPriority</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nextKnownPendingLevel</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoWork</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取要执行 DOM 操作的副作用列表</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">firstEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">firstEffect</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// true</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">firstEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// commit 第一个子阶段</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">firstEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 处理类组件的 getSnapShotBeforeUpdate 生命周期函数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">do</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">invokeGuardedCallback</span><span style="color:#666666;">(</span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">commitBeforeMutationEffects</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// commit 第二个子阶段</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">firstEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">do</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">invokeGuardedCallback</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">commitMutationEffects</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">renderPriorityLevel</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 将 workInProgress Fiber 树变成 current Fiber 树</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">root</span><span style="color:#666666;">.</span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// commit 第三个子阶段</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">firstEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">do</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">invokeGuardedCallback</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">commitLayoutEffects</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">expirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 重置 nextEffect</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">commitRootImpl</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">renderPriorityLevel</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取待提交 Fiber 对象 rootFiber</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">finishedWork</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果没有任务要执行</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 阻止程序继续向下执行</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 重置为默认值</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">finishedWork</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callbackNode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callbackExpirationTime</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoWork</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callbackPriority</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoPriority</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nextKnownPendingLevel</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoWork</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取要执行 DOM 操作的副作用列表</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">firstEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">firstEffect</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// true</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">firstEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// commit 第一个子阶段</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">firstEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 处理类组件的 getSnapShotBeforeUpdate 生命周期函数</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">do</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">invokeGuardedCallback</span><span style="color:#999999;">(</span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">commitBeforeMutationEffects</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// commit 第二个子阶段</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">firstEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">do</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">invokeGuardedCallback</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">commitMutationEffects</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">renderPriorityLevel</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 将 workInProgress Fiber 树变成 current Fiber 树</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">root</span><span style="color:#999999;">.</span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// commit 第三个子阶段</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">firstEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">do</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">invokeGuardedCallback</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">commitLayoutEffects</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">expirationTime</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 重置 nextEffect</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-2-4-第一子阶段" tabindex="-1">5.2.4 第一子阶段 <a class="header-anchor" href="#_5-2-4-第一子阶段" aria-hidden="true">#</a></h4><h5 id="_5-2-4-1-commitbeforemutationeffects" tabindex="-1">5.2.4.1 commitBeforeMutationEffects <a class="header-anchor" href="#_5-2-4-1-commitbeforemutationeffects" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// commit 阶段的第一个子阶段</span></span>
<span class="line"><span style="color:#758575DD;">// 调用类组件的 getSnapshotBeforeUpdate 生命周期函数</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">commitBeforeMutationEffects</span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 循环 effect 链</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// nextEffect 是 effect 链上从 firstEffect 到 lastEffec 的每一个需要commit的 fiber 对象</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始化渲染第一个 nextEffect 为 App 组件</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// effectTag =&gt; 3</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// console.log(effectTag);</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// nextEffect = null;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// return;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果 fiber 对象中里有 Snapshot 这个 effectTag 的话</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// Snapshot 和更新有关系 初始化渲染 不执行</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// false</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">((</span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Snapshot</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">NoEffect</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 获取当前 fiber 节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">alternate</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 当 nextEffect 上有 Snapshot 这个 effectTag 时</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 执行以下方法, 主要是类组件调用 getSnapshotBeforeUpdate 生命周期函数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">commitBeforeMutationEffectOnFiber</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 更新循环条件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// commit 阶段的第一个子阶段</span></span>
<span class="line"><span style="color:#A0ADA0;">// 调用类组件的 getSnapshotBeforeUpdate 生命周期函数</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">commitBeforeMutationEffects</span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 循环 effect 链</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// nextEffect 是 effect 链上从 firstEffect 到 lastEffec 的每一个需要commit的 fiber 对象</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始化渲染第一个 nextEffect 为 App 组件</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// effectTag =&gt; 3</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// console.log(effectTag);</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// nextEffect = null;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// return;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果 fiber 对象中里有 Snapshot 这个 effectTag 的话</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// Snapshot 和更新有关系 初始化渲染 不执行</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// false</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">((</span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Snapshot</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">NoEffect</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 获取当前 fiber 节点</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">alternate</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 当 nextEffect 上有 Snapshot 这个 effectTag 时</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 执行以下方法, 主要是类组件调用 getSnapshotBeforeUpdate 生命周期函数</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">commitBeforeMutationEffectOnFiber</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 更新循环条件</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-2-4-2-commitbeforemutationlifecycles" tabindex="-1">5.2.4.2 commitBeforeMutationLifeCycles <a class="header-anchor" href="#_5-2-4-2-commitbeforemutationlifecycles" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">commitBeforeMutationLifeCycles</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">current</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">void</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">switch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">FunctionComponent</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ForwardRef</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">SimpleMemoComponent</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Block</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果该 fiber 类型是 ClassComponent</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ClassComponent</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Snapshot</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 旧的 props</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">prevProps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedProps</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 旧的 state</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">prevState</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedState</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 获取 classComponent 组件的实例对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">instance</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 执行 getSnapshotBeforeUpdate 生命周期函数</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 在组件更新前捕获一些 DOM 信息</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">// 返回自定义的值或 null, 统称为 snapshot</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">snapshot</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">instance</span><span style="color:#666666;">.</span><span style="color:#80A665;">getSnapshotBeforeUpdate</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">elementType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">type</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                            </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">prevProps</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                            </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">resolveDefaultProps</span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">type</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">prevProps</span><span style="color:#666666;">),</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#BD976A;">prevState</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostRoot</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostComponent</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostText</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostPortal</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">IncompleteClassComponent</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// Nothing to do for these component types</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">commitBeforeMutationLifeCycles</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">current</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">void</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">switch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">FunctionComponent</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ForwardRef</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">SimpleMemoComponent</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Block</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果该 fiber 类型是 ClassComponent</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ClassComponent</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Snapshot</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 旧的 props</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">prevProps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedProps</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 旧的 state</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">prevState</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedState</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 获取 classComponent 组件的实例对象</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">instance</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 执行 getSnapshotBeforeUpdate 生命周期函数</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 在组件更新前捕获一些 DOM 信息</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">// 返回自定义的值或 null, 统称为 snapshot</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">snapshot</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">instance</span><span style="color:#999999;">.</span><span style="color:#59873A;">getSnapshotBeforeUpdate</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">elementType</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">type</span></span>
<span class="line"><span style="color:#393A34;">                            </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">prevProps</span></span>
<span class="line"><span style="color:#393A34;">                            </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#59873A;">resolveDefaultProps</span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">type</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">prevProps</span><span style="color:#999999;">),</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#B07D48;">prevState</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostRoot</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostComponent</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostText</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostPortal</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">IncompleteClassComponent</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// Nothing to do for these component types</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-2-5-第二子阶段" tabindex="-1">5.2.5 第二子阶段 <a class="header-anchor" href="#_5-2-5-第二子阶段" aria-hidden="true">#</a></h4><h5 id="_5-2-5-1-commitmutationeffects" tabindex="-1">5.2.5.1 commitMutationEffects <a class="header-anchor" href="#_5-2-5-1-commitmutationeffects" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// commit 阶段的第二个子阶段</span></span>
<span class="line"><span style="color:#758575DD;">// 根据 effectTag 执行 DOM 操作</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">commitMutationEffects</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">FiberRoot</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">renderPriorityLevel</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 循环 effect 链</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 获取 effectTag</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始渲染第一次循环为 App 组件</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 即将根组件及内部所有内容一次性添加到页面中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 根据 effectTag 分别处理</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">primaryEffectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">Placement</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Update</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Deletion</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Hydrating</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 匹配 effectTag</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始渲染 primaryEffectTag 为 2 匹配到 Placement</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">switch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">primaryEffectTag</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 针对该节点及子节点进行插入操作</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Placement</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">commitPlacement</span><span style="color:#666666;">(</span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// effectTag 从 3 变为 1</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 从 effect 标签中清除 &quot;placement&quot; 重置 effectTag 值</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 以便我们知道在调用诸如componentDidMount之类的任何生命周期之前已将其插入。</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">&amp;=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">~</span><span style="color:#BD976A;">Placement</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">break</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 插入并更新 DOM</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">PlacementAndUpdate</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 插入</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">commitPlacement</span><span style="color:#666666;">(</span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">&amp;=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">~</span><span style="color:#BD976A;">Placement</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 更新</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">alternate</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">commitWork</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">break</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 服务器端渲染</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Hydrating</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">&amp;=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">~</span><span style="color:#BD976A;">Hydrating</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">break</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 服务器端渲染</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HydratingAndUpdate</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">&amp;=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">~</span><span style="color:#BD976A;">Hydrating</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// Update</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">alternate</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">commitWork</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">break</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 更新 DOM</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Update</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">alternate</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">commitWork</span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">break</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 删除 DOM</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Deletion</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">commitDeletion</span><span style="color:#666666;">(</span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">renderPriorityLevel</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">break</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// commit 阶段的第二个子阶段</span></span>
<span class="line"><span style="color:#A0ADA0;">// 根据 effectTag 执行 DOM 操作</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">commitMutationEffects</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">: </span><span style="color:#2E808F;">FiberRoot</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">renderPriorityLevel</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 循环 effect 链</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 获取 effectTag</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始渲染第一次循环为 App 组件</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 即将根组件及内部所有内容一次性添加到页面中</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 根据 effectTag 分别处理</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">primaryEffectTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">Placement</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Update</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Deletion</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Hydrating</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 匹配 effectTag</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始渲染 primaryEffectTag 为 2 匹配到 Placement</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">switch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">primaryEffectTag</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 针对该节点及子节点进行插入操作</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Placement</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">commitPlacement</span><span style="color:#999999;">(</span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// effectTag 从 3 变为 1</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 从 effect 标签中清除 &quot;placement&quot; 重置 effectTag 值</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 以便我们知道在调用诸如componentDidMount之类的任何生命周期之前已将其插入。</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">&amp;=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">~</span><span style="color:#B07D48;">Placement</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">break</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 插入并更新 DOM</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">PlacementAndUpdate</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 插入</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">commitPlacement</span><span style="color:#999999;">(</span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">&amp;=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">~</span><span style="color:#B07D48;">Placement</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 更新</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">alternate</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">commitWork</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">break</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 服务器端渲染</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Hydrating</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">&amp;=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">~</span><span style="color:#B07D48;">Hydrating</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">break</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 服务器端渲染</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HydratingAndUpdate</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">&amp;=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">~</span><span style="color:#B07D48;">Hydrating</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// Update</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">alternate</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">commitWork</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">break</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 更新 DOM</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Update</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">alternate</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">commitWork</span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">break</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 删除 DOM</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Deletion</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">commitDeletion</span><span style="color:#999999;">(</span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">renderPriorityLevel</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">break</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-2-5-2-commitplacement" tabindex="-1">5.2.5.2 commitPlacement <a class="header-anchor" href="#_5-2-5-2-commitplacement" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 挂载 DOM 元素</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">commitPlacement</span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">void</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// finishedWork 初始化渲染时为根组件 Fiber 对象</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取非组件父级 Fiber 对象</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 初始渲染时为 &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentFiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">getHostParentFiber</span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 存储真正的父级 DOM 节点对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parent</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 是否为渲染容器</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 渲染容器和普通react元素的主要区别在于是否需要特殊处理注释节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isContainer</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取父级 DOM 节点对象</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 但是初始渲染时 rootFiber 对象中的 stateNode 存储的是 FiberRoot</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentStateNode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 判断父节点的类型</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 初始渲染时是 hostRoot 3</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">switch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">parentFiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostComponent</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentStateNode</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">isContainer</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">false</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">break</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostRoot</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 获取真正的 DOM 节点对象</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentStateNode</span><span style="color:#666666;">.</span><span style="color:#BD976A;">containerInfo</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 是 container 容器</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">isContainer</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">break</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostPortal</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentStateNode</span><span style="color:#666666;">.</span><span style="color:#BD976A;">containerInfo</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">isContainer</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">break</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">FundamentalComponent</span><span style="color:#666666;">:</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">enableFundamentalAPI</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parentStateNode</span><span style="color:#666666;">.</span><span style="color:#BD976A;">instance</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">isContainer</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">false</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 查看当前节点是否有下一个兄弟节点</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 有, 执行 insertBefore</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 没有, 执行 appendChild</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">before</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">getHostSibling</span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 渲染容器</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">isContainer</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 向父节点中追加节点 或者 将子节点插入到 before 节点的前面</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">insertOrAppendPlacementNodeIntoContainer</span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">before</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parent</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 非渲染容器</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 向父节点中追加节点 或者 将子节点插入到 before 节点的前面</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">insertOrAppendPlacementNode</span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">before</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parent</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 挂载 DOM 元素</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">commitPlacement</span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">void</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// finishedWork 初始化渲染时为根组件 Fiber 对象</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取非组件父级 Fiber 对象</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 初始渲染时为 &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentFiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">getHostParentFiber</span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 存储真正的父级 DOM 节点对象</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parent</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 是否为渲染容器</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 渲染容器和普通react元素的主要区别在于是否需要特殊处理注释节点</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isContainer</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取父级 DOM 节点对象</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 但是初始渲染时 rootFiber 对象中的 stateNode 存储的是 FiberRoot</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentStateNode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 判断父节点的类型</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 初始渲染时是 hostRoot 3</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">switch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">parentFiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostComponent</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentStateNode</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">isContainer</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">false</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">break</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostRoot</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 获取真正的 DOM 节点对象</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentStateNode</span><span style="color:#999999;">.</span><span style="color:#B07D48;">containerInfo</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 是 container 容器</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">isContainer</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">break</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostPortal</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentStateNode</span><span style="color:#999999;">.</span><span style="color:#B07D48;">containerInfo</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">isContainer</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">break</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">FundamentalComponent</span><span style="color:#999999;">:</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">enableFundamentalAPI</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parentStateNode</span><span style="color:#999999;">.</span><span style="color:#B07D48;">instance</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">isContainer</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">false</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 查看当前节点是否有下一个兄弟节点</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 有, 执行 insertBefore</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 没有, 执行 appendChild</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">before</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">getHostSibling</span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 渲染容器</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">isContainer</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 向父节点中追加节点 或者 将子节点插入到 before 节点的前面</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">insertOrAppendPlacementNodeIntoContainer</span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">before</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parent</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 非渲染容器</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 向父节点中追加节点 或者 将子节点插入到 before 节点的前面</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">insertOrAppendPlacementNode</span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">before</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parent</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-2-5-3-gethostparentfiber" tabindex="-1">5.2.5.3 getHostParentFiber <a class="header-anchor" href="#_5-2-5-3-gethostparentfiber" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 获取 HostRootFiber 对象</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">getHostParentFiber</span><span style="color:#666666;">(</span><span style="color:#BD976A;">fiber</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取当前 Fiber 父级</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">fiber</span><span style="color:#666666;">.</span><span style="color:#BD976A;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 查看父级是否为 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 查看父级是否为 hostRoot</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#80A665;">isHostParent</span><span style="color:#666666;">(</span><span style="color:#BD976A;">parent</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 返回</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parent</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 继续向上查找</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">parent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parent</span><span style="color:#666666;">.</span><span style="color:#BD976A;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 获取 HostRootFiber 对象</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">getHostParentFiber</span><span style="color:#999999;">(</span><span style="color:#B07D48;">fiber</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">Fiber</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取当前 Fiber 父级</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">fiber</span><span style="color:#999999;">.</span><span style="color:#B07D48;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 查看父级是否为 null</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 查看父级是否为 hostRoot</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#59873A;">isHostParent</span><span style="color:#999999;">(</span><span style="color:#B07D48;">parent</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 返回</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parent</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 继续向上查找</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">parent</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parent</span><span style="color:#999999;">.</span><span style="color:#B07D48;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-2-5-4-insertorappendplacementnodeintocontainer" tabindex="-1">5.2.5.4 insertOrAppendPlacementNodeIntoContainer <a class="header-anchor" href="#_5-2-5-4-insertorappendplacementnodeintocontainer" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 向容器中追加 | 插入到某一个节点的前面</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">insertOrAppendPlacementNodeIntoContainer</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">node</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">before</span><span style="color:#666666;">: </span><span style="color:#CB7676;">?</span><span style="color:#5DA9A7;">Instance</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">parent</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Container</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">void</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">tag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果待插入的节点是一个 DOM 元素或者文本的话</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 比如 组件fiber =&gt; false div =&gt; true</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isHost</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">tag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostComponent</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">tag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HostText</span><span style="color:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">isHost</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">enableFundamentalAPI</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">tag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">FundamentalComponent</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 获取 DOM 节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">stateNode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">isHost</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#666666;">.</span><span style="color:#BD976A;">instance</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果 before 存在</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">before</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 插入到 before 前面</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">insertInContainerBefore</span><span style="color:#666666;">(</span><span style="color:#BD976A;">parent</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">stateNode</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">before</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 追加到父容器中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">appendChildToContainer</span><span style="color:#666666;">(</span><span style="color:#BD976A;">parent</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">stateNode</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 如果是组件节点, 比如 ClassComponent, 则找它的第一个子节点(DOM 元素)</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 进行插入操作</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">child</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">node</span><span style="color:#666666;">.</span><span style="color:#BD976A;">child</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">child</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 向父级中追加子节点或者将子节点插入到 before 的前面</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">insertOrAppendPlacementNodeIntoContainer</span><span style="color:#666666;">(</span><span style="color:#BD976A;">child</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">before</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">parent</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 获取下一个兄弟节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sibling</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">child</span><span style="color:#666666;">.</span><span style="color:#BD976A;">sibling</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果兄弟节点存在</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">sibling</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 向父级中追加子节点或者将子节点插入到 before 的前面</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">insertOrAppendPlacementNodeIntoContainer</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">sibling</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">before</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">parent</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 同步兄弟节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">sibling</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">sibling</span><span style="color:#666666;">.</span><span style="color:#BD976A;">sibling</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 向容器中追加 | 插入到某一个节点的前面</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">insertOrAppendPlacementNodeIntoContainer</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">node</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">before</span><span style="color:#999999;">: </span><span style="color:#AB5959;">?</span><span style="color:#2E808F;">Instance</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">parent</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Container</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">void</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">tag</span><span style="color:#393A34;"> </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果待插入的节点是一个 DOM 元素或者文本的话</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 比如 组件fiber =&gt; false div =&gt; true</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isHost</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">tag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostComponent</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">tag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HostText</span><span style="color:#999999;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">isHost</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">enableFundamentalAPI</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">tag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">FundamentalComponent</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 获取 DOM 节点</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">stateNode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">isHost</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#999999;">.</span><span style="color:#B07D48;">instance</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果 before 存在</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">before</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 插入到 before 前面</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">insertInContainerBefore</span><span style="color:#999999;">(</span><span style="color:#B07D48;">parent</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">stateNode</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">before</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 追加到父容器中</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">appendChildToContainer</span><span style="color:#999999;">(</span><span style="color:#B07D48;">parent</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">stateNode</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 如果是组件节点, 比如 ClassComponent, 则找它的第一个子节点(DOM 元素)</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 进行插入操作</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">child</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">node</span><span style="color:#999999;">.</span><span style="color:#B07D48;">child</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">child</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 向父级中追加子节点或者将子节点插入到 before 的前面</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">insertOrAppendPlacementNodeIntoContainer</span><span style="color:#999999;">(</span><span style="color:#B07D48;">child</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">before</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">parent</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 获取下一个兄弟节点</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sibling</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">child</span><span style="color:#999999;">.</span><span style="color:#B07D48;">sibling</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果兄弟节点存在</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">sibling</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 向父级中追加子节点或者将子节点插入到 before 的前面</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">insertOrAppendPlacementNodeIntoContainer</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">sibling</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">before</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">parent</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 同步兄弟节点</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">sibling</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">sibling</span><span style="color:#999999;">.</span><span style="color:#B07D48;">sibling</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-2-5-5-insertincontainerbefore" tabindex="-1">5.2.5.5 insertInContainerBefore <a class="header-anchor" href="#_5-2-5-5-insertincontainerbefore" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">insertInContainerBefore</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">container</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Container</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">child</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Instance</span><span style="color:#666666;"> | </span><span style="color:#5DA9A7;">TextInstance</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">beforeChild</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Instance</span><span style="color:#666666;"> | </span><span style="color:#5DA9A7;">TextInstance</span><span style="color:#666666;"> | </span><span style="color:#5DA9A7;">SuspenseInstance</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">void</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果父容器是注释节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nodeType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">COMMENT_NODE</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 找到注释节点的父级节点 因为注释节点没法调用 insertBefore</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">(</span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#BD976A;">parentNode</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">any</span><span style="color:#666666;">).</span><span style="color:#80A665;">insertBefore</span><span style="color:#666666;">(</span><span style="color:#BD976A;">child</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">beforeChild</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 将 child 插入到 beforeChild 的前面</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#80A665;">insertBefore</span><span style="color:#666666;">(</span><span style="color:#BD976A;">child</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">beforeChild</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">insertInContainerBefore</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">container</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Container</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">child</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Instance</span><span style="color:#999999;"> | </span><span style="color:#2E808F;">TextInstance</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">beforeChild</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Instance</span><span style="color:#999999;"> | </span><span style="color:#2E808F;">TextInstance</span><span style="color:#999999;"> | </span><span style="color:#2E808F;">SuspenseInstance</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">void</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果父容器是注释节点</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nodeType</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">COMMENT_NODE</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 找到注释节点的父级节点 因为注释节点没法调用 insertBefore</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">(</span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#B07D48;">parentNode</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">any</span><span style="color:#999999;">).</span><span style="color:#59873A;">insertBefore</span><span style="color:#999999;">(</span><span style="color:#B07D48;">child</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">beforeChild</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 将 child 插入到 beforeChild 的前面</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#59873A;">insertBefore</span><span style="color:#999999;">(</span><span style="color:#B07D48;">child</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">beforeChild</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-2-5-6-appendchildtocontainer" tabindex="-1">5.2.5.6 appendChildToContainer <a class="header-anchor" href="#_5-2-5-6-appendchildtocontainer" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">appendChildToContainer</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">container</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Container</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">child</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Instance</span><span style="color:#666666;"> | </span><span style="color:#5DA9A7;">TextInstance</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">void</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 监测 container 是否注释节点</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nodeType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">COMMENT_NODE</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 获取父级的父级</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">parentNode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">container</span><span style="color:#666666;">.</span><span style="color:#BD976A;">parentNode</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">any</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 将子级节点插入到注释节点的前面</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">parentNode</span><span style="color:#666666;">.</span><span style="color:#80A665;">insertBefore</span><span style="color:#666666;">(</span><span style="color:#BD976A;">child</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">container</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 直接将 child 插入到父级中</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">parentNode</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">container</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">parentNode</span><span style="color:#666666;">.</span><span style="color:#80A665;">appendChild</span><span style="color:#666666;">(</span><span style="color:#BD976A;">child</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">appendChildToContainer</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">container</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Container</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">child</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Instance</span><span style="color:#999999;"> | </span><span style="color:#2E808F;">TextInstance</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">void</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 监测 container 是否注释节点</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nodeType</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">COMMENT_NODE</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 获取父级的父级</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">parentNode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">container</span><span style="color:#999999;">.</span><span style="color:#B07D48;">parentNode</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">any</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 将子级节点插入到注释节点的前面</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">parentNode</span><span style="color:#999999;">.</span><span style="color:#59873A;">insertBefore</span><span style="color:#999999;">(</span><span style="color:#B07D48;">child</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">container</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 直接将 child 插入到父级中</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">parentNode</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">container</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">parentNode</span><span style="color:#999999;">.</span><span style="color:#59873A;">appendChild</span><span style="color:#999999;">(</span><span style="color:#B07D48;">child</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_5-2-6-第三子阶段" tabindex="-1">5.2.6 第三子阶段 <a class="header-anchor" href="#_5-2-6-第三子阶段" aria-hidden="true">#</a></h4><h5 id="_5-2-6-1-commitlayouteffects" tabindex="-1">5.2.6.1 commitLayoutEffects <a class="header-anchor" href="#_5-2-6-1-commitlayouteffects" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// commit 阶段的第三个子阶段</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">commitLayoutEffects</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">root</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">FiberRoot</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">committedExpirationTime</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExpirationTime</span></span>
<span class="line"><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 此时 effectTag 已经被重置为 1, 表示 DOM 操作已经完成</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 调用生命周期函数和钩子函数</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 前提是类组件中调用了生命周期函数 或者函数组件中调用了 useEffect</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">Update</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Callback</span><span style="color:#666666;">))</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 类组件处理生命周期函数</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 函数组件处理钩子函数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">commitLayoutEffectOnFiber</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">root</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">current</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">committedExpirationTime</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 更新循环条件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">nextEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">nextEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// commit 阶段的第三个子阶段</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">commitLayoutEffects</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">root</span><span style="color:#999999;">: </span><span style="color:#2E808F;">FiberRoot</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">committedExpirationTime</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExpirationTime</span></span>
<span class="line"><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 此时 effectTag 已经被重置为 1, 表示 DOM 操作已经完成</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 调用生命周期函数和钩子函数</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 前提是类组件中调用了生命周期函数 或者函数组件中调用了 useEffect</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">Update</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Callback</span><span style="color:#999999;">))</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 类组件处理生命周期函数</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 函数组件处理钩子函数</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">commitLayoutEffectOnFiber</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">root</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">current</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">committedExpirationTime</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 更新循环条件</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">nextEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">nextEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-2-6-2-commitlifecycles" tabindex="-1">5.2.6.2 commitLifeCycles <a class="header-anchor" href="#_5-2-6-2-commitlifecycles" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">commitLifeCycles</span><span style="color:#666666;">(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">finishedRoot</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">FiberRoot</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">current</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">committedExpirationTime</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">ExpirationTime</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">void</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#4D9375;">switch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">FunctionComponent</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 处理钩子函数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#80A665;">commitHookEffectListMount</span><span style="color:#666666;">(</span><span style="color:#BD976A;">HookLayout</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">|</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">HookHasEffect</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">case</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">ClassComponent</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 获取类组件实例对象</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">instance</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">stateNode</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 如果在类组件中存在生命周期函数判断条件就会成立</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effectTag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Update</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 初始渲染阶段</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">current</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 调用 componentDidMount 生命周期函数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">instance</span><span style="color:#666666;">.</span><span style="color:#80A665;">componentDidMount</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 更新阶段</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 获取旧的 props</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">prevProps</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">elementType</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">type</span></span>
<span class="line"><span style="color:#DBD7CAEE;">              </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedProps</span></span>
<span class="line"><span style="color:#DBD7CAEE;">              </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">resolveDefaultProps</span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">type</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedProps</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 获取旧的 state</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">prevState</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">current</span><span style="color:#666666;">.</span><span style="color:#BD976A;">memoizedState</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// 调用 componentDidUpdate 生命周期函数</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// instance.__reactInternalSnapshotBeforeUpdate 快照 getSnapShotBeforeUpdate 方法的返回值</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">instance</span><span style="color:#666666;">.</span><span style="color:#80A665;">componentDidUpdate</span><span style="color:#666666;">(</span><span style="color:#BD976A;">prevProps</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">prevState</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">instance</span><span style="color:#666666;">.</span><span style="color:#BD976A;">__reactInternalSnapshotBeforeUpdate</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 获取任务队列</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">updateQueue</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">updateQueue</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 如果任务队列存在</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">updateQueue</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;">         * 调用 ReactElement 渲染完成之后的回调函数</span></span>
<span class="line"><span style="color:#758575DD;">         * 即 render 方法的第三个参数</span></span>
<span class="line"><span style="color:#758575DD;">         */</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">commitUpdateQueue</span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">updateQueue</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">instance</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">commitLifeCycles</span><span style="color:#999999;">(</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">finishedRoot</span><span style="color:#999999;">: </span><span style="color:#2E808F;">FiberRoot</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">current</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">committedExpirationTime</span><span style="color:#999999;">: </span><span style="color:#2E808F;">ExpirationTime</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">void</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#1E754F;">switch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">FunctionComponent</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 处理钩子函数</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#59873A;">commitHookEffectListMount</span><span style="color:#999999;">(</span><span style="color:#B07D48;">HookLayout</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">|</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">HookHasEffect</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">case</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">ClassComponent</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 获取类组件实例对象</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">instance</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">stateNode</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 如果在类组件中存在生命周期函数判断条件就会成立</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effectTag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Update</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 初始渲染阶段</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">current</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 调用 componentDidMount 生命周期函数</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">instance</span><span style="color:#999999;">.</span><span style="color:#59873A;">componentDidMount</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 更新阶段</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 获取旧的 props</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">prevProps</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">elementType</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">type</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedProps</span></span>
<span class="line"><span style="color:#393A34;">              </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#59873A;">resolveDefaultProps</span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">type</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedProps</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 获取旧的 state</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">prevState</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">current</span><span style="color:#999999;">.</span><span style="color:#B07D48;">memoizedState</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// 调用 componentDidUpdate 生命周期函数</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// instance.__reactInternalSnapshotBeforeUpdate 快照 getSnapShotBeforeUpdate 方法的返回值</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">instance</span><span style="color:#999999;">.</span><span style="color:#59873A;">componentDidUpdate</span><span style="color:#999999;">(</span><span style="color:#B07D48;">prevProps</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">prevState</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">instance</span><span style="color:#999999;">.</span><span style="color:#B07D48;">__reactInternalSnapshotBeforeUpdate</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 获取任务队列</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">updateQueue</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">updateQueue</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 如果任务队列存在</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">updateQueue</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 调用 ReactElement 渲染完成之后的回调函数</span></span>
<span class="line"><span style="color:#A0ADA0;">         * 即 render 方法的第三个参数</span></span>
<span class="line"><span style="color:#A0ADA0;">         */</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">commitUpdateQueue</span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">updateQueue</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">instance</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-2-6-3-commitupdatequeue" tabindex="-1">5.2.6.3 commitUpdateQueue <a class="header-anchor" href="#_5-2-6-3-commitupdatequeue" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactUpdateQueue.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 执行渲染完成之后的回调函数</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">commitUpdateQueue</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">State</span><span style="color:#666666;">&gt;(</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">finishedQueue</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">UpdateQueue</span><span style="color:#666666;">&lt;</span><span style="color:#5DA9A7;">State</span><span style="color:#666666;">&gt;,</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">instance</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">any</span></span>
<span class="line"><span style="color:#666666;">):</span><span style="color:#DBD7CAEE;"> </span><span style="color:#5DA9A7;">void</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// effects 为数组, 存储任务对象 (Update 对象)</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 但前提是在调用 render 方法时传递了回调函数, 就是 render 方法的第三个参数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effects</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">finishedQueue</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effects</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 重置 finishedQueue.effects 数组</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">finishedQueue</span><span style="color:#666666;">.</span><span style="color:#BD976A;">effects</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果传递了 render 方法的第三个参数, effect 数组就不会为 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">effects</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 遍历 effect 数组</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">for</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4C9A91;">0</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&lt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effects</span><span style="color:#666666;">.</span><span style="color:#B8A965;">length</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">i</span><span style="color:#CB7676;">++</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 获取数组中的第 i 个需要执行的 effect</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effects</span><span style="color:#666666;">[</span><span style="color:#BD976A;">i</span><span style="color:#666666;">];</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 获取 callback 回调函数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">callback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callback</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 如果回调函数不为 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">callback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 清空 effect 中的 callback</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">callback</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 执行回调函数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">callCallback</span><span style="color:#666666;">(</span><span style="color:#BD976A;">callback</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">instance</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 执行渲染完成之后的回调函数</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">commitUpdateQueue</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">State</span><span style="color:#999999;">&gt;(</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">finishedQueue</span><span style="color:#999999;">: </span><span style="color:#2E808F;">UpdateQueue</span><span style="color:#999999;">&lt;</span><span style="color:#2E808F;">State</span><span style="color:#999999;">&gt;,</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">instance</span><span style="color:#999999;">: </span><span style="color:#2E808F;">any</span></span>
<span class="line"><span style="color:#999999;">):</span><span style="color:#393A34;"> </span><span style="color:#2E808F;">void</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// effects 为数组, 存储任务对象 (Update 对象)</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 但前提是在调用 render 方法时传递了回调函数, 就是 render 方法的第三个参数</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effects</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">finishedQueue</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effects</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 重置 finishedQueue.effects 数组</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">finishedQueue</span><span style="color:#999999;">.</span><span style="color:#B07D48;">effects</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果传递了 render 方法的第三个参数, effect 数组就不会为 null</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">effects</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 遍历 effect 数组</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">for</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#2F798A;">0</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&lt;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effects</span><span style="color:#999999;">.</span><span style="color:#998418;">length</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">i</span><span style="color:#AB5959;">++</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 获取数组中的第 i 个需要执行的 effect</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effects</span><span style="color:#999999;">[</span><span style="color:#B07D48;">i</span><span style="color:#999999;">];</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 获取 callback 回调函数</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">callback</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callback</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 如果回调函数不为 null</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">callback</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 清空 effect 中的 callback</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">callback</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 执行回调函数</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">callCallback</span><span style="color:#999999;">(</span><span style="color:#B07D48;">callback</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">instance</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div><h5 id="_5-2-6-4-commithookeffectlistmount" tabindex="-1">5.2.6.4 commitHookEffectListMount <a class="header-anchor" href="#_5-2-6-4-commithookeffectlistmount" aria-hidden="true">#</a></h5><p><code>文件位置: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * useEffect 回调函数调用</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">commitHookEffectListMount</span><span style="color:#666666;">(</span><span style="color:#BD976A;">tag</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">number</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">Fiber</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取任务队列</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">updateQueue</span><span style="color:#666666;">: </span><span style="color:#5DA9A7;">FunctionComponentUpdateQueue</span><span style="color:#666666;"> | </span><span style="color:#CB7676;">null</span><span style="color:#666666;"> =</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">(</span><span style="color:#BD976A;">finishedWork</span><span style="color:#666666;">.</span><span style="color:#BD976A;">updateQueue</span><span style="color:#DBD7CAEE;">: </span><span style="color:#BD976A;">any</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 获取 lastEffect</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">lastEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">updateQueue</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">updateQueue</span><span style="color:#666666;">.</span><span style="color:#BD976A;">lastEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 如果 lastEffect 不为 null</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">lastEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">null</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 获取要执行的副作用</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">firstEffect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">lastEffect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">next</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">firstEffect</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 通过遍历的方式调用 useEffect 中的回调函数</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// 在组件中定义了调用了几次 useEffect 遍历就会执行几次</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">do</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">((</span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">tag</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">tag</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// Mount</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">create</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">create</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// create 就是 useEffect 方法的第一个参数</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">// 返回值就是清理函数</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">destroy</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">create</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// 更新循环条件</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">effect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">effect</span><span style="color:#666666;">.</span><span style="color:#BD976A;">next</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">while</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">effect</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">!==</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">firstEffect</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * useEffect 回调函数调用</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">commitHookEffectListMount</span><span style="color:#999999;">(</span><span style="color:#B07D48;">tag</span><span style="color:#999999;">: </span><span style="color:#2E808F;">number</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">: </span><span style="color:#2E808F;">Fiber</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取任务队列</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">updateQueue</span><span style="color:#999999;">: </span><span style="color:#2E808F;">FunctionComponentUpdateQueue</span><span style="color:#999999;"> | </span><span style="color:#AB5959;">null</span><span style="color:#999999;"> =</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">(</span><span style="color:#B07D48;">finishedWork</span><span style="color:#999999;">.</span><span style="color:#B07D48;">updateQueue</span><span style="color:#393A34;">: </span><span style="color:#B07D48;">any</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 获取 lastEffect</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">lastEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">updateQueue</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">updateQueue</span><span style="color:#999999;">.</span><span style="color:#B07D48;">lastEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 如果 lastEffect 不为 null</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">lastEffect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">null</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 获取要执行的副作用</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">firstEffect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">lastEffect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">next</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">firstEffect</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 通过遍历的方式调用 useEffect 中的回调函数</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// 在组件中定义了调用了几次 useEffect 遍历就会执行几次</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">do</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">((</span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">tag</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">tag</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// Mount</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">create</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">create</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// create 就是 useEffect 方法的第一个参数</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">// 返回值就是清理函数</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">destroy</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">create</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// 更新循环条件</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">effect</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">effect</span><span style="color:#999999;">.</span><span style="color:#B07D48;">next</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">while</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">effect</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">!==</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">firstEffect</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-6b6fcb79 data-v-ae0105da><!----><div class="prev-next" data-v-ae0105da><div class="pager" data-v-ae0105da><a class="pager-link prev" href="/Framework/React/ReactFilber.html" data-v-ae0105da><span class="desc" data-v-ae0105da>Previous page</span><span class="title" data-v-ae0105da>React Fiber</span></a></div><div class="has-prev pager" data-v-ae0105da><a class="pager-link next" href="/Framework/React/ReactRouter.html" data-v-ae0105da><span class="desc" data-v-ae0105da>Next page</span><span class="title" data-v-ae0105da>React Router</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter has-sidebar" data-v-82528fa6 data-v-13fad65a><div class="container" data-v-13fad65a><p class="message" data-v-13fad65a>Released under the MIT License.</p><p class="copyright" data-v-13fad65a>Copyright © 2022-present Attraction11</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"framework_module_index.md\":\"fc542c91\",\"framework_next_gatsby.md\":\"0648ae07\",\"framework_next_nextjs.md\":\"7e68bacd\",\"framework_next_serverender.md\":\"a3a44189\",\"framework_nuxt_myssr.md\":\"93624c7e\",\"framework_nuxt_nuxtbase.md\":\"6f8742ef\",\"framework_nuxt_serverender.md\":\"a3762f60\",\"framework_nuxt_staticsite.md\":\"893b01b6\",\"framework_nuxt_index.md\":\"ddeca323\",\"framework_react_mobx6.md\":\"cf1247d0\",\"framework_react_qa1.md\":\"4d2743b7\",\"framework_react_qa2.md\":\"9ea1efc0\",\"framework_react_react.md\":\"4c22d863\",\"framework_react_react16code.md\":\"1148dd90\",\"framework_react_reactbase.md\":\"76975013\",\"framework_react_reactdiff.md\":\"eb2a21d8\",\"framework_react_reactfilber.md\":\"026f1546\",\"framework_react_reacthooks.md\":\"78ba7e39\",\"framework_react_reactredux.md\":\"e0c60cdf\",\"framework_react_reactrouter.md\":\"064cf4c5\",\"framework_react_redux.md\":\"77c98801\",\"framework_react_reduxcode.md\":\"848129a8\",\"framework_vue_component.md\":\"aee81eca\",\"framework_vue_qa1.md\":\"44c0b0f1\",\"framework_vue_qa2.md\":\"37c31fc2\",\"framework_vue_qa3.md\":\"097e7f0b\",\"framework_vue_virtualdom.md\":\"dcab979d\",\"framework_vue_vue2.md\":\"49d8af5b\",\"framework_vue_vue3.md\":\"4f3bfb0f\",\"framework_vue_vue3code.md\":\"703924f3\",\"framework_vue_vue3tsx.md\":\"89468506\",\"framework_vue_vuerouter.md\":\"32f5a345\",\"framework_vue_vuex.md\":\"75647aef\",\"fullstack_database_mongodb.md\":\"533c2318\",\"fullstack_database_redis.md\":\"3688c374\",\"fullstack_graphql_index.md\":\"4fd6bfc1\",\"fullstack_node_nodebase.md\":\"cb028d69\",\"fullstack_node_nodecore.md\":\"2534ded2\",\"fullstack_node_nodemessage.md\":\"c5c244e6\",\"fullstack_node_webcli.md\":\"60c8d698\",\"fullstack_webdev_egg.md\":\"59beb4c1\",\"fullstack_webdev_express.md\":\"f7d7f193\",\"fullstack_webdev_koa.md\":\"ed474b56\",\"fullstack_webdev_nest.md\":\"3fd5f101\",\"javascript_asynchronous_heap_stack.md\":\"6e33a805\",\"javascript_asynchronous_index.md\":\"b1db3019\",\"javascript_asynchronous_objectoriented.md\":\"fe14fd46\",\"javascript_asynchronous_promise.md\":\"79057715\",\"javascript_asynchronous_promisecode.md\":\"89f23300\",\"javascript_asynchronous_this.md\":\"cf2bc474\",\"javascript_esfeatures_index.md\":\"a5de200e\",\"javascript_engineering_automate.md\":\"84194cf0\",\"javascript_engineering_codestandard.md\":\"b3d431f6\",\"javascript_engineering_modular.md\":\"1f7970ef\",\"javascript_engineering_webpack.md\":\"999bc0aa\",\"javascript_engineering_index.md\":\"1394c932\",\"javascript_functional_closure.md\":\"a98a3a0d\",\"javascript_functional_combination.md\":\"73887d1e\",\"javascript_functional_currying.md\":\"210aecda\",\"javascript_functional_index.md\":\"39ce2ab9\",\"javascript_functional_purefunction.md\":\"83b246e7\",\"javascript_html_css_flex.md\":\"e20b4364\",\"javascript_html_css_grid.md\":\"4c2f1947\",\"javascript_html_css_index.md\":\"102f4608\",\"javascript_html_css_layout.md\":\"014d282e\",\"javascript_html_css_randomrecord.md\":\"b94fae3c\",\"javascript_html_css_skill.md\":\"2df8cf47\",\"javascript_module_three.md\":\"5445112c\",\"javascript_module_two.md\":\"922d71c8\",\"javascript_module_index.md\":\"058aa546\",\"javascript_performance_check.md\":\"23977715\",\"javascript_performance_execute.md\":\"3d410b3b\",\"javascript_performance_optimize.md\":\"b06d9e8a\",\"javascript_performance_index.md\":\"239713ef\",\"javascript_typescript_tooltype.md\":\"64234312\",\"javascript_typescript_index.md\":\"8a51cf21\",\"panclient_flutter_webcli.md\":\"62390cce\",\"panclient_rn_webcli.md\":\"f1cc1a76\",\"programtopics_microfrontend_webcli.md\":\"469aa911\",\"readme.md\":\"fb490f74\",\"sites.md\":\"89ad49a8\",\"vscode插件开发.md\":\"ac5c9c68\",\"index.md\":\"bcb494f1\",\"notes_git常用操作.md\":\"6b94e88a\",\"notes_linux基本命令.md\":\"a02dd0c4\",\"notes_nginx基本使用.md\":\"4c75fd8d\",\"notes_regexp介绍与使用.md\":\"21992c95\",\"notes_力扣题记录.md\":\"4c460ffe\",\"notes_小程序开发记录.md\":\"d3827680\",\"notes_常用快捷键.md\":\"ba242b91\",\"notes_排序算法.md\":\"a1fb0c0b\",\"notes_网络相关知识.md\":\"52df4d3e\"}")</script>
    <script type="module" async src="/assets/app.5eebf8c0.js"></script>
    
  </body>
</html>